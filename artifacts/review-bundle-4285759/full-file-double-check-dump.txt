===== FILE: apps/hps-dealengine/components/ui.tsx =====
import React, { useContext, createContext } from 'react';
import type { ReactNode } from 'react';
import type {
  IconProps,
  CardProps,
  BadgeProps,
  ButtonProps,
  InputFieldProps,
  SelectFieldProps,
  ToggleSwitchProps,
  TabsContextType,
  ModalProps,
  MultiSelectChecklistProps,
  DynamicBandEditorProps,
} from '../types';
import { num } from '../utils/helpers';
import { Icons } from '../constants';
import { InfoTooltip } from './ui/InfoTooltip';
import NumericInput from './ui/NumericInput';

export function cn(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(' ');
}

export const Icon = ({ d, size = 20, className = '' }: IconProps) => (
  <svg
    width={size}
    height={size}
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
  >
    <path d={d} />
  </svg>
);

export const GlassCard = ({ children, className = '' }: CardProps) => (
  <div
    className={cn(
      'card-primary card-padding-md hover-lift text-[color:var(--text-primary)]',
      className
    )}
    style={{ color: 'var(--text-primary)' }}
  >
    {children}
  </div>
);

export const Badge = ({
  color,
  children,
  className = '',
  dataTestId,
  ...rest
}: BadgeProps) => {
  const colors = {
    green: 'border border-[color:var(--accent-green)]/40 bg-[color:var(--accent-green)]/15 text-[color:var(--text-primary)]',
    blue: 'border border-[color:var(--accent-color)]/35 bg-[color:var(--accent-color)]/15 text-[color:var(--text-primary)]',
    orange: 'bg-accent-orange-subtle text-accent-orange-light border border-accent-orange-subtle',
    red: 'bg-brand-red-subtle text-brand-red-light border border-brand-red-subtle',
  };
  const colorClass = color ? colors[color] : colors.blue;
  return (
    <span
      data-testid={dataTestId}
      {...rest}
      className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colorClass} ${className}`}
    >
      {children}
    </span>
  );
};

export const Button = ({
  children,
  onClick,
  size = 'md',
  variant = 'primary',
  className = '',
  title,
  disabled = false,
  dataTestId,
}: ButtonProps) => {
  const sizeClass =
    ({ sm: 'btn-sm', md: '', lg: 'btn-lg', xl: 'btn-xl' } as Record<string, string>)[
      size as string
    ] || '';
  const variantClass =
    ({
      primary: 'btn-primary',
      danger: 'btn-danger',
      ghost: 'btn-ghost',
      success: 'btn-success',
      neutral: 'btn-secondary',
      secondary: 'btn-secondary',
    } as Record<string, string>)[variant as string] || 'btn-primary';
  return (
    <button
      className={cn('btn', variantClass, sizeClass, className)}
      onClick={onClick}
      title={title}
      disabled={disabled}
      data-testid={dataTestId}
    >
      {children}
    </button>
  );
};

export const InputField = ({
  label,
  type = 'text',
  value,
  onChange,
  prefix,
  suffix,
  description,
  warning,
  helpKey,
  dataTestId,
  ...props
}: InputFieldProps) => {
  const isNumber = type === 'number';
  const { className, ...inputProps } = props as any;
  const placeholderValue = isNumber
    ? (props as any)?.placeholder ?? '0'
    : (props as any)?.placeholder;

  const numericValue = (() => {
    if (!isNumber) return null;
    if (value === null || value === undefined || value === '') return null;
    const cleaned =
      typeof value === 'string' ? value.replace(/,/g, '').trim() : value;
    const parsed = Number(cleaned);
    return Number.isFinite(parsed) ? parsed : null;
  })();

  return (
    <div className="relative">
      <div className="mb-1 flex items-center gap-2">
        <label className="block text-base font-medium text-text-primary">{label}</label>
        {helpKey ? <InfoTooltip helpKey={helpKey} /> : null}
      </div>
      {description && <p className="text-xs text-text-secondary/70 mb-2">{description}</p>}
      <div className={`input-wrapper ${prefix ? 'has-prefix' : ''} ${suffix ? 'has-suffix' : ''}`}>
        {prefix && <span className="input-prefix">{prefix}</span>}
        {isNumber ? (
          <NumericInput
            data-testid={dataTestId}
            value={numericValue}
            placeholder={placeholderValue}
            onValueChange={(next) => {
              if (!onChange) return;
              const synthetic = {
                target: {
                  value: next === null ? null : String(next),
                },
              };
              onChange(synthetic as any);
            }}
            className={cn(warning ? 'input-error' : '', className)}
            {...inputProps}
          />
        ) : (
          <input
            type={type}
            data-testid={dataTestId}
            value={value}
            placeholder={placeholderValue}
            onChange={(e) => {
              onChange?.(e);
            }}
            className={cn('input-base', warning ? 'input-error' : '', className)}
            {...inputProps}
          />
        )}
        {suffix && <span className="input-suffix">{suffix}</span>}
      </div>
      {warning ? <p className="input-error-message mt-1 flex items-center gap-1"><Icon d={Icons.alert} size={16} className="text-accent-orange" />{warning}</p> : null}
    </div>
  );
};

export const SelectField = ({
  label,
  value,
  onChange,
  children,
  className,
  description,
  helpKey,
  dataTestId,
}: SelectFieldProps) => (
  <div className={className}>
    <div className="mb-1 flex items-center gap-2">
      <label className="block text-base font-medium text-text-primary">{label}</label>
      {helpKey ? <InfoTooltip helpKey={helpKey} /> : null}
    </div>
    {description && <p className="text-xs text-text-secondary/70 mb-2">{description}</p>}
    <select value={value} onChange={onChange} className="input-base" data-testid={dataTestId}>
      {children}
    </select>
  </div>
);

export const ToggleSwitch = ({ label, checked, onChange, description }: ToggleSwitchProps) => (
  <label className="flex items-start justify-between cursor-pointer">
    <div className="pr-4">
      <span className="text-sm text-text-primary">{label}</span>
      {description && <p className="text-xs text-text-secondary/70 mt-1">{description}</p>}
    </div>
    <div className="relative shrink-0 mt-1">
      <input
        type="checkbox"
        className="sr-only"
        checked={checked}
        onChange={(e) => onChange?.(e.target.checked)}
      />
      <div
        className={cn(
          'block w-10 h-6 rounded-full transition-colors border',
          checked ? 'bg-accent-blue/80 border-accent-blue/70' : 'bg-gray-700 border-white/20'
        )}
      ></div>
      <div
        className={cn(
          'dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform shadow-sm ring-1 ring-black/10',
          checked ? 'transform translate-x-4' : ''
        )}
      ></div>
    </div>
  </label>
);

const TabsContext = createContext<TabsContextType>({ activeTab: '', setActiveTab: () => {} });

// children optional to avoid TS noise in your config
export const NestedTabs = ({
  children,
  initialTab,
}: {
  children?: ReactNode;
  initialTab: string;
}) => {
  const [activeTab, setActiveTab] = React.useState(initialTab);
  return (
    <TabsContext.Provider value={{ activeTab, setActiveTab }}>{children}</TabsContext.Provider>
  );
};

export const NestedTabsList = ({
  children,
  className,
}: {
  children?: ReactNode;
  className?: string;
}) => <div className={`flex flex-wrap items-center gap-2 ${className}`}>{children}</div>;

export const NestedTabsTrigger = ({
  children,
  value,
  className,
}: {
  children?: ReactNode;
  value: string;
  className?: string;
}) => {
  const { activeTab, setActiveTab } = useContext(TabsContext);
  const isActive = activeTab === value;
  return (
    <button
      onClick={() => setActiveTab && setActiveTab(value)}
      className={`px-4 py-2 text-sm font-semibold transition-all duration-200 border-b-2 ${
        isActive
          ? 'text-text-primary border-accent-blue shadow-[0_4px_12px_-4px_var(--accent-blue)]'
          : 'text-text-secondary border-transparent hover:text-text-primary'
      } ${className}`}
    >
      {children}
    </button>
  );
};

export const NestedTabsContent = ({ value, children }: { value: string; children?: ReactNode }) => {
  const { activeTab } = useContext(TabsContext);
  const isActive = activeTab === value;
  return (
    <div
      className={`transition-opacity ${isActive ? 'animate-fade-in' : 'animate-fade-out'} ${
        isActive ? 'opacity-100' : 'opacity-0 absolute inset-0 pointer-events-none'
      }`}
    >
      {children}
    </div>
  );
};

export const Modal = ({ isOpen, onClose, title, children, size = 'md' }: ModalProps) => {
  if (!isOpen) return null;

  const sizeClasses = {
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
  };
  const safeTitle = title ?? '';
  const titleId = safeTitle.replace(/\s+/g, '-').toLowerCase();

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50"
      onClick={onClose}
      role="dialog"
      aria-modal="true"
      aria-labelledby={titleId}
    >
      <div
        className={`card-primary card-padding-lg hover-lift w-full m-4 ${sizeClasses[size]}`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex items-center justify-between pb-3">
          <h3 id={titleId} className="text-lg font-bold text-text-primary">
            {title}
          </h3>
          <button
            onClick={onClose}
            className="text-text-secondary hover:text-text-primary text-2xl leading-none"
          >
            &times;
          </button>
        </div>
        <div className="mt-4">{children}</div>
      </div>
    </div>
  );
};

export const MultiSelectChecklist = ({
  label,
  options,
  selected,
  onChange,
  className,
  description,
}: MultiSelectChecklistProps) => {
  const handleToggle = (option: string) => {
    const newSelected = selected.includes(option)
      ? selected.filter((item) => item !== option)
      : [...selected, option];
    onChange(newSelected);
  };

  return (
    <div className={className}>
      <label className="block text-sm font-medium text-text-primary mb-1">{label}</label>
      {description && <p className="text-xs text-text-secondary/70 mb-2">{description}</p>}
      <div className="info-card p-2 space-y-1">
        {options.map((option) => (
          <label
            key={option}
            className="flex items-center gap-2 text-sm text-text-secondary cursor-pointer hover:text-text-primary"
          >
            <input
              type="checkbox"
              checked={selected.includes(option)}
              onChange={() => handleToggle(option)}
              className="h-4 w-4 rounded bg-accent-blue/40 border-accent-blue/50 text-accent-blue focus:ring-accent-blue"
            />
            {option}
          </label>
        ))}
      </div>
    </div>
  );
};

export const DynamicBandEditor = ({
  label,
  columns,
  data = [],
  onChange,
  newRowDefaults,
  className,
  description,
}: DynamicBandEditorProps) => {
  const handleUpdate = (rowIndex: number, key: string, value: any) => {
    const newData = [...data];
    newData[rowIndex][key] = value;
    onChange(newData);
  };
  const handleAdd = () => onChange([...data, { ...newRowDefaults, id: Date.now() }]);
  const handleRemove = (rowIndex: number) => onChange(data.filter((_, i) => i !== rowIndex));

  return (
    <div className={className}>
      <div className="flex justify-between items-center mb-1">
        <div>
          <label className="block text-sm font-medium text-text-primary">{label}</label>
          {description && <p className="text-xs text-text-secondary/70 mt-1">{description}</p>}
        </div>
        <Button size="sm" variant="ghost" onClick={handleAdd}>
          + Add Row
        </Button>
      </div>
      <div className="overflow-x-auto info-card p-1 mt-2">
        <table className="w-full text-sm">
          <thead>
            <tr>
              {columns.map((col) => (
                <th key={col.key} className="p-2 text-left label-xs">
                  {col.label}
                </th>
              ))}
              <th className="w-[60px]"></th>
            </tr>
          </thead>
          <tbody>
            {data.map((row, rowIndex) => (
              <tr key={row.id || rowIndex}>
                {columns.map((col) => (
                  <td key={col.key} className="p-1">
                    {col.type === 'select' ? (
                      <select
                        value={row[col.key] || ''}
                        onChange={(e) => handleUpdate(rowIndex, col.key, e.target.value)}
                        className="input-base input-sm"
                      >
                        {col.options?.map((opt) => (
                          <option key={opt} value={opt}>
                            {opt}
                          </option>
                        ))}
                      </select>
                    ) : (
                      <input
                        type={col.type}
                        value={row[col.key] || ''}
                        onChange={(e) =>
                          handleUpdate(
                            rowIndex,
                            col.key,
                            col.type === 'number' ? num(e.target.value) : e.target.value
                          )
                        }
                        className="input-base input-sm"
                      />
                    )}
                  </td>
                ))}
                <td className="p-1 text-center">
                  <Button size="sm" variant="danger" onClick={() => handleRemove(rowIndex)}>
                    &times;
                  </Button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};


===== FILE: apps/hps-dealengine/components/ui/NumericInput.tsx =====
import React from "react";

export interface NumericInputProps
  extends Omit<React.InputHTMLAttributes<HTMLInputElement>, "value" | "onChange"> {
  value: number | null | undefined;
  onValueChange?: (value: number | null) => void;
}

/**
 * Lightweight numeric input that treats empty as truly empty (null) and
 * never propagates NaN. Uses type="text" + inputMode="decimal" to avoid
 * browser number quirks while keeping mobile numeric keyboards.
 */
export function NumericInput({
  value,
  onValueChange,
  onFocus,
  className = "",
  ...rest
}: NumericInputProps) {
  const displayValue =
    typeof value === "number" && !Number.isNaN(value) ? String(value) : "";

  return (
    <input
      {...rest}
      type="text"
      inputMode="decimal"
      className={`input-base text-right text-numeric ${className}`}
      value={displayValue}
      onChange={(event) => {
        const raw = event.target.value;
        if (raw.trim() === "") {
          onValueChange?.(null);
          return;
        }
        const next = Number(raw.replace(/,/g, ""));
        if (Number.isNaN(next)) {
          return;
        }
        onValueChange?.(next);
      }}
      onFocus={(event) => {
        event.target.select();
        if (typeof onFocus === "function") {
          onFocus(event);
        }
      }}
    />
  );
}

export default NumericInput;


===== FILE: apps/hps-dealengine/lib/dealSessionContext.tsx =====
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useMemo,
  useCallback,
  useRef,
  useState,
} from "react";
import type { ReactNode } from "react";

import { createInitialEstimatorState } from "./ui-v2-constants";
import type { Deal, SandboxConfig } from "../types";
import type {
  AnalyzeResult,
  RepairRates,
  RepairRateProfile,
} from "@hps-internal/contracts";
import { Postures } from "@hps-internal/contracts";
import type {
  NegotiationPlaybookResult,
  AiChatMessage,
  NegotiatorTone,
} from "./ai/types";

import { HPSEngine } from "../services/engine";
import { getSupabaseClient } from "./supabaseClient";
import { useSearchParams } from "next/navigation";
import {
  DEFAULT_SANDBOX_CONFIG,
  mergeSandboxConfig,
} from "../constants/sandboxSettings";
import { fetchSandboxSettings } from "./sandboxSettings";
import { fetchRepairRates } from "./repairRates";
import { getActiveOrgMembershipRole, type OrgMembershipRole } from "./orgMembership";
import {
  fetchLatestRunForDeal,
  fetchWorkingState,
  hashWorkingState,
  upsertWorkingState,
  type WorkingStatePayload,
} from "./workingState";

/**
 * Thin typed view of the canonical deals row in public.deals.
 * This gives the app a stable identity + address container to pair with
 * the richer engine-level Deal in memory.
 */
export type DbDeal = {
  id: string;
  org_id: string;
  orgId: string;
  orgName?: string | null;
  organization?: { name?: string | null } | null;
  client_name?: string | null;
  client_phone?: string | null;
  client_email?: string | null;
  clientName?: string | null;
  clientPhone?: string | null;
  clientEmail?: string | null;
  created_by: string;
  created_at: string;
  updated_at: string;
  address: string | null;
  city: string | null;
  state: string | null;
  zip: string | null;
  payload: unknown;
};

type DealSessionValue = {
  deal: Deal;
  sandbox: SandboxConfig;
  posture: (typeof Postures)[number];
  autosaveStatus: {
    state: "idle" | "saving" | "saved" | "error";
    lastSavedAt: string | null;
    error: string | null;
  };
  saveWorkingStateNow: (opts?: { payload?: WorkingStatePayload }) => Promise<void>;
  sandboxLoading: boolean;
  sandboxError: string | null;
  lastAnalyzeResult: AnalyzeResult | null;
  lastRunId: string | null;
  lastRunAt: string | null;
  hasUnsavedDealChanges: boolean;
  repairRates: RepairRates | null;
  repairRatesLoading: boolean;
  repairRatesError: string | null;
  activeRepairProfile: RepairRateProfile | null;
  activeRepairProfileId: string | null;
  dbDeal: DbDeal | null;
  membershipRole: OrgMembershipRole | null;
  negotiationPlaybook?: NegotiationPlaybookResult | null;
  negotiatorMessages?: AiChatMessage[];
  negotiatorLogicRowIds?: string[] | null;
  negotiatorTone?: NegotiatorTone;
  setDeal: React.Dispatch<React.SetStateAction<Deal>>;
  setSandbox: React.Dispatch<React.SetStateAction<SandboxConfig>>;
  setPosture: React.Dispatch<
    React.SetStateAction<(typeof Postures)[number]>
  >;
  setHasUnsavedDealChanges: React.Dispatch<
    React.SetStateAction<boolean>
  >;
  setLastRunAt: React.Dispatch<React.SetStateAction<string | null>>;
  refreshSandbox: () => Promise<void>;
  refreshRepairRates: (opts?: {
    profileId?: string | null;
    marketCode?: string;
    posture?: (typeof Postures)[number] | string | null;
  }) => Promise<void>;
  setLastAnalyzeResult: (result: AnalyzeResult | null) => void;
  setLastRunId: (id: string | null) => void;
  setDbDeal: (deal: DbDeal | null) => void;
  setActiveRepairProfileId: React.Dispatch<
    React.SetStateAction<string | null>
  >;
  setNegotiationPlaybook: (result: NegotiationPlaybookResult | null) => void;
  setNegotiatorMessages: (messages: AiChatMessage[]) => void;
  appendNegotiatorMessage: (message: AiChatMessage) => void;
  clearNegotiatorThread: () => void;
  setNegotiatorLogicRowIds: (ids: string[] | null) => void;
  setNegotiatorTone: (tone: NegotiatorTone) => void;
  isHydratingActiveDeal: boolean;
  hydratedDealId: string | null;
};

const DealSessionContext = createContext<DealSessionValue | null>(null);

export function normalizeDealShape(base?: any): Deal {
  const d: any = base ? structuredClone(base) : {};

  const marketSource = d.market ?? {};
  const { offer_price: _legacyOfferPrice, ...restMarket } = marketSource;
  d.market = {
    arv: marketSource?.arv ?? null,
    as_is_value: marketSource?.as_is_value ?? null,
    contract_price: marketSource?.contract_price ?? null,
    contract_price_executed: marketSource?.contract_price_executed ?? null,
    valuation_basis: marketSource?.valuation_basis ?? null,
    price_to_list_ratio: marketSource?.price_to_list_ratio ?? null,
    local_discount_pct: marketSource?.local_discount_pct ?? null,
    dom: marketSource?.dom ?? null,
    months_of_inventory: marketSource?.months_of_inventory ?? null,
    ...restMarket,
  };

  d.costs = {
    ...(d.costs ?? {}),
    double_close: d.costs?.double_close ?? {},
  };

  d.debt = {
    senior_principal: d.debt?.senior_principal ?? null,
    ...(d.debt ?? {}),
  };

  return d as Deal;
}

/**
 * Build a robust initial Deal that matches what Overview/Underwrite expect.
 * Prefer UI-V2 estimator defaults; fall back to HPSEngine defaults,
 * then to a minimal defensive shape.
 */
function makeInitialDeal(): Deal {
  // 1) Try UI-V2 estimator state (design source of truth)
  try {
    const est: any =
      typeof createInitialEstimatorState === "function"
        ? createInitialEstimatorState()
        : {};

    if (est?.deal) return normalizeDealShape(est.deal);
    if (est?.state?.deal) return normalizeDealShape(est.state.deal);
    if (est?.estimator?.deal) return normalizeDealShape(est.estimator.deal);
  } catch {
    // swallow and fall through to engine defaults
  }

  // 2) Try engine helpers / defaults
  try {
    const engineAny: any = HPSEngine as any;
    if (typeof engineAny?.createInitialDeal === "function") {
      return normalizeDealShape(engineAny.createInitialDeal());
    }
    if (engineAny?.defaults?.deal) {
      return normalizeDealShape(engineAny.defaults.deal);
    }
  } catch {
    // fall through to final minimal shape
  }

  // 3) Final defensive fallback: just the fields Overview/engine touch
  return normalizeDealShape({
    market: {
      arv: null,
      as_is_value: null,
      price_to_list_ratio: null,
      local_discount_pct: null,
      dom: null,
      months_of_inventory: null,
    },
    costs: {
      double_close: {},
    },
    debt: {
      senior_principal: null,
    },
  });
}

function deriveMarketCode(deal: Deal): string {
  const market: any = (deal as any)?.market ?? {};
  return (
    market.market_code ||
    market.market ||
    market.code ||
    market.msa ||
    "ORL"
  );
}

export function DealSessionProvider({ children }: { children: ReactNode }) {
  const [deal, setDeal] = useState<Deal>(() => makeInitialDeal());
  const [sandbox, setSandbox] = useState<SandboxConfig>(() =>
    mergeSandboxConfig(DEFAULT_SANDBOX_CONFIG)
  );
  const [posture, setPosture] = useState<(typeof Postures)[number]>("base");
  const supabase = React.useMemo(() => getSupabaseClient(), []);
  const [userId, setUserId] = useState<string | null>(null);
  const [sandboxLoading, setSandboxLoading] = useState(false);
  const [sandboxError, setSandboxError] = useState<string | null>(null);
  const [autosaveStatus, setAutosaveStatus] = useState<{
    state: "idle" | "saving" | "saved" | "error";
    lastSavedAt: string | null;
    error: string | null;
  }>({ state: "idle", lastSavedAt: null, error: null });
  const [lastAnalyzeResult, setLastAnalyzeResult] =
    useState<AnalyzeResult | null>(null);
  const [lastRunId, setLastRunId] = useState<string | null>(null);
  const [lastRunAt, setLastRunAt] = useState<string | null>(null);
  const [hasUnsavedDealChanges, setHasUnsavedDealChanges] = useState(false);
  const [dbDeal, setDbDeal] = useState<DbDeal | null>(null);
  const [repairRates, setRepairRates] = useState<RepairRates | null>(null);
  const [repairRatesLoading, setRepairRatesLoading] = useState(false);
  const [repairRatesError, setRepairRatesError] = useState<string | null>(null);
  const [activeRepairProfile, setActiveRepairProfile] =
    useState<RepairRateProfile | null>(null);
  const [activeRepairProfileId, setActiveRepairProfileId] = useState<
    string | null
  >(null);
  const [negotiationPlaybook, setNegotiationPlaybook] =
    useState<NegotiationPlaybookResult | null>(null);
  const [negotiatorMessages, setNegotiatorMessages] = useState<AiChatMessage[]>([]);
  const [negotiatorLogicRowIds, setNegotiatorLogicRowIds] = useState<string[] | null>(null);
  const [negotiatorTone, setNegotiatorTone] = useState<NegotiatorTone>("objective");
  const [membershipRole, setMembershipRole] = useState<OrgMembershipRole | null>(null);
  const [isHydratingActiveDeal, setIsHydratingActiveDeal] = useState(false);
  const [hydratedDealId, setHydratedDealId] = useState<string | null>(null);
  const [workingHydratedTick, setWorkingHydratedTick] = useState(0);
  const workingHydratedRef = useRef(false);
  const pendingAutosaveRef = useRef(false);
  const lastSavedHashRef = useRef<string | null>(null);
  const lastSavedDealRef = useRef<string | null>(null);
  const derivedMarketCode = useMemo(
    () => deriveMarketCode(deal as Deal).toUpperCase(),
    [
      (deal as any)?.market?.market_code,
      (deal as any)?.market?.market,
      (deal as any)?.market?.code,
      (deal as any)?.market?.msa,
    ],
  );
  const repairRatesRequestRef = React.useRef(0);
  const searchParams = useSearchParams();
  const dealIdFromUrl = searchParams?.get("dealId");

  useEffect(() => {
    let active = true;

    supabase.auth
      .getUser()
      .then(({ data }) => {
        if (!active) return;
        setUserId(data.user?.id ?? null);
      })
      .catch(() => {
        if (!active) return;
        setUserId(null);
      });

    const { data: authSub } = supabase.auth.onAuthStateChange((_event, session) => {
      if (!active) return;
      setUserId(session?.user?.id ?? null);
    });

    return () => {
      active = false;
      authSub?.subscription?.unsubscribe?.();
    };
  }, [supabase]);

  const appendNegotiatorMessage = React.useCallback((message: AiChatMessage) => {
    setNegotiatorMessages((prev) => [...prev, message]);
  }, []);

  const clearNegotiatorThread = React.useCallback(() => {
    setNegotiationPlaybook(null);
    setNegotiatorMessages([]);
    setNegotiatorLogicRowIds(null);
    setNegotiatorTone("objective");
  }, []);

  const loadSandbox = React.useCallback(async () => {
    setSandboxLoading(true);
    setSandboxError(null);
    try {
      const settings = await fetchSandboxSettings({
        orgId: dbDeal?.org_id,
        posture,
      });
      const merged = mergeSandboxConfig(settings?.config ?? undefined);
      setSandbox(merged);
    } catch (err) {
      console.error("[DealSession] failed to load sandbox settings", err);
      setSandbox(mergeSandboxConfig(DEFAULT_SANDBOX_CONFIG));
      setSandboxError("Could not load sandbox settings; using defaults.");
    } finally {
      setSandboxLoading(false);
    }
  }, [dbDeal?.org_id, posture]);

  const loadDealById = useCallback(
    async (dealId: string) => {
      try {
        const { data: session } = await supabase.auth.getSession();
        if (!session?.session) {
          return null;
        }
        const { data, error } = await supabase
          .from("deals")
          .select(
            "id, org_id, created_by, created_at, updated_at, address, city, state, zip, client_name, client_phone, client_email, payload, organization:organizations(name)"
          )
          .eq("id", dealId)
          .maybeSingle();

        if (error || !data) {
          return null;
        }

      const organization =
        (data as any)?.organization ?? (data as any)?.organizations ?? null;
      const normalized = {
        ...(data as any),
        orgId: (data as any)?.org_id ?? (data as any)?.orgId ?? "",
        orgName: organization?.name ?? null,
        organization,
      } as DbDeal;

      setDbDeal(normalized);

      try {
        const latestRun = await fetchLatestRunForDeal(supabase, {
          orgId: normalized.org_id,
          dealId: normalized.id,
        });

        if (latestRun?.output) {
          const trace = Array.isArray((latestRun as any)?.trace)
            ? ((latestRun as any).trace as any[])
            : null;
          const merged = trace
            ? ({ ...(latestRun.output as any), trace } as AnalyzeResult)
            : (latestRun.output as AnalyzeResult);

          setLastAnalyzeResult(merged);
          setLastRunId(latestRun.id ?? null);
          setLastRunAt((latestRun as any)?.created_at ?? null);
        }
      } catch (err) {
        console.warn("[DealSession] failed to load latest run for deal", err);
      }

      return normalized;
    } catch {
      return null;
    }
  },
    [supabase],
  );

  // Persist selected deal id locally so reloads keep context
  useEffect(() => {
    if (dbDeal?.id) {
      localStorage.setItem("hps-active-deal-id", dbDeal.id);
    }
  }, [dbDeal?.id]);

  useEffect(() => {
    setLastAnalyzeResult(null);
    setLastRunId(null);
    setLastRunAt(null);
  }, [dbDeal?.id]);

  // On mount, hydrate selection from localStorage if present
  useEffect(() => {
    const supabase = getSupabaseClient();
    const savedId = localStorage.getItem("hps-active-deal-id");
    if (!savedId) return;

    const load = async () => {
      const loaded = await loadDealById(savedId);
      if (loaded) {
        setHydratedDealId(loaded.id);
      }
    };

    void load();
  }, [loadDealById]);

  // Hydrate DealSession from URL ?dealId=... when present (deep-link)
  useEffect(() => {
    if (!dealIdFromUrl) return;
    if (isHydratingActiveDeal) return;

    // If already aligned with this dealId, no-op
    if (dbDeal?.id === dealIdFromUrl && hydratedDealId === dealIdFromUrl) {
      return;
    }

    setIsHydratingActiveDeal(true);
    loadDealById(dealIdFromUrl)
      .then((loaded) => {
        if (loaded?.id) {
          setHydratedDealId(loaded.id);
        }
      })
      .finally(() => {
        setIsHydratingActiveDeal(false);
      });
  }, [dealIdFromUrl, dbDeal?.id, hydratedDealId, isHydratingActiveDeal, loadDealById]);

  // When dbDeal changes, sync in-memory deal shape from payload
  useEffect(() => {
    if (dbDeal?.payload && !workingHydratedRef.current) {
      setDeal(normalizeDealShape(dbDeal.payload));
    }
  }, [dbDeal?.payload]);

  // Fallback: load the latest run for the active deal to ensure overview/trace have data.
  useEffect(() => {
    if (!dbDeal?.id || !dbDeal.org_id) return;
    if (!userId) return;
    if (lastAnalyzeResult) return;

    let cancelled = false;
    const loadLatestRun = async () => {
      const { data, error } = await supabase
        .from("runs")
        .select("id, org_id, deal_id, created_at, output, trace")
        .eq("org_id", dbDeal.org_id)
        .eq("deal_id", dbDeal.id)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (cancelled || error || !data) return;

      const output = ((data as any).output ?? null) as AnalyzeResult | null;
      const trace = Array.isArray((data as any)?.trace) ? ((data as any).trace as any[]) : null;
      const merged = trace && output ? ({ ...(output as any), trace } as AnalyzeResult) : output;

      setLastAnalyzeResult(merged);
      setLastRunId((data as any).id ?? null);
      setLastRunAt((data as any).created_at ?? null);
    };

    void loadLatestRun();

    return () => {
      cancelled = true;
    };
  }, [dbDeal?.id, dbDeal?.org_id, lastAnalyzeResult, supabase, setLastRunId, setLastRunAt, userId]);

  const refreshRepairRates = React.useCallback(
    async (
      opts?: {
        profileId?: string | null;
        marketCode?: string;
        posture?: (typeof Postures)[number] | string | null;
      },
    ) => {
      const requestId = ++repairRatesRequestRef.current;

      if (!dbDeal?.org_id || !dbDeal?.id) {
        setRepairRates(null);
        setRepairRatesError("Select a deal to load repair rates.");
        if (requestId === repairRatesRequestRef.current) {
          setRepairRatesLoading(false);
        }
        if (process.env.NODE_ENV !== "production") {
          console.debug("[DealSession] refreshRepairRates skipped (no org)", {
            hasDbDeal: !!dbDeal,
            hasDealId: !!dbDeal?.id,
            profileId: opts?.profileId ?? activeRepairProfileId,
            marketCode: opts?.marketCode,
            posture,
          });
        }
        return;
      }

      setRepairRatesLoading(true);
      setRepairRatesError(null);
      try {
        const marketCode = (opts?.marketCode ?? derivedMarketCode).toUpperCase();
        const postureNormalized = (
          opts?.posture ?? posture ?? "base"
        ).toLowerCase() as (typeof Postures)[number];

        if (process.env.NODE_ENV !== "production") {
          console.debug("[DealSession] refreshRepairRates start", {
            requestId,
            orgId: dbDeal.org_id,
            marketCode,
            posture: postureNormalized,
            profileId: opts?.profileId ?? activeRepairProfileId,
            dealId: dbDeal.id,
          });
        }

        const next = await fetchRepairRates({
          dealId: dbDeal.id,
          marketCode,
          posture: postureNormalized,
          profileId: opts?.profileId ?? activeRepairProfileId,
        });

        if (requestId !== repairRatesRequestRef.current) {
          return;
        }

        if (next) {
          if (process.env.NODE_ENV !== "production") {
            console.debug("[DealSession] refreshRepairRates store", {
              requestId,
              profileId: next.profileId,
              marketCode: next.marketCode,
              posture: next.posture,
              big5: next.big5,
            });
          }
          const normalized = {
            ...next,
            psfTiers: { ...(next.psfTiers ?? {}) },
            big5: { ...(next.big5 ?? {}) },
            lineItemRates: {
              ...(((next as any).lineItemRates ?? (next as any).items ?? {}) as
                Record<string, unknown>),
            },
          } as RepairRates;
          console.log("[DealSession] repairRates updated", {
            profileId: normalized.profileId,
            marketCode: normalized.marketCode,
            posture: normalized.posture,
            psf: normalized.psfTiers,
            big5: normalized.big5,
          });
          setRepairRates(normalized);
          if (next.profileId && next.profileId !== activeRepairProfileId) {
            setActiveRepairProfileId(next.profileId);
          }
          setActiveRepairProfile({
            id: next.profileId ?? undefined,
            orgId: next.orgId,
            name: next.profileName ?? "Active Profile",
            marketCode: next.marketCode,
            posture: next.posture as (typeof Postures)[number],
            asOf: next.asOf,
            source: next.source ?? undefined,
            version: next.version,
            isActive: true,
            isDefault: next.isDefault ?? false,
            psfTiers: next.psfTiers,
            big5: next.big5,
            lineItemRates: (next as any).lineItemRates ?? {},
          });
          if (process.env.NODE_ENV !== "production") {
            console.debug("[DealSession] refreshRepairRates success", {
              profileId: next.profileId,
              marketCode: next.marketCode,
              posture: next.posture,
              psf: next.psfTiers,
              big5: next.big5,
            });
          }
        } else {
          setRepairRates(null);
          setRepairRatesError("No active repair profile found for this org.");
          setActiveRepairProfile(null);
          if (process.env.NODE_ENV !== "production") {
            console.debug("[DealSession] refreshRepairRates no data", {
              orgId: dbDeal.org_id,
              marketCode,
              posture: postureNormalized,
            });
          }
        }
      } catch (err: any) {
        console.error("[DealSession] failed to load repair rates", err);
        if (requestId !== repairRatesRequestRef.current) {
          return;
        }
        setRepairRates(null);
        setRepairRatesError(
          err?.message ?? "Could not load repair rates for this org/market.",
        );
        setActiveRepairProfile(null);
        if (process.env.NODE_ENV !== "production") {
          console.debug("[DealSession] refreshRepairRates error details", {
            message: err?.message,
            orgId: dbDeal.org_id,
          });
        }
      } finally {
        if (requestId === repairRatesRequestRef.current) {
          setRepairRatesLoading(false);
        }
      }
    },
    [dbDeal?.org_id, derivedMarketCode, posture, activeRepairProfileId],
  );

  // Hydrate working state (draft vs latest run) when deal/user changes
  useEffect(() => {
    if (!dbDeal?.id || !dbDeal.org_id || !userId) {
      setLastAnalyzeResult(null);
      setLastRunId(null);
      setLastRunAt(null);
      workingHydratedRef.current = false;
      pendingAutosaveRef.current = false;
      lastSavedHashRef.current = null;
      lastSavedDealRef.current = null;
      return;
    }

    workingHydratedRef.current = false;
    lastSavedHashRef.current = null;
    lastSavedDealRef.current = null;

    const hydrate = async () => {
      try {
        const [working, latestRun] = await Promise.all([
          fetchWorkingState(supabase, {
            orgId: dbDeal.org_id,
            dealId: dbDeal.id,
            userId,
          }).catch(() => null),
          fetchLatestRunForDeal(supabase, {
            orgId: dbDeal.org_id,
            dealId: dbDeal.id,
          }).catch(() => null),
        ]);

        const workingPayload: WorkingStatePayload =
          (working?.payload as WorkingStatePayload) ?? {};
        const workingPosture =
          (working?.posture as (typeof Postures)[number]) ?? posture ?? "base";
        const workingHash =
          working && workingPayload
            ? hashWorkingState({
                dealId: dbDeal.id,
                posture: workingPosture,
                payload: workingPayload,
              })
            : null;
        const workingUpdatedAt = working?.updated_at
          ? new Date(working.updated_at).getTime()
          : -1;

        const runInput = (latestRun?.input as any) ?? null;
        const runPosture =
          (runInput?.posture as (typeof Postures)[number]) ??
          (latestRun?.posture as (typeof Postures)[number]) ??
          "base";
        const runHash =
          latestRun?.input_hash ??
          (runInput
            ? hashWorkingState({
                dealId: dbDeal.id,
                posture: runPosture,
                payload: {
                  deal: runInput.deal,
                  sandbox: runInput.sandbox,
                  repairProfile: runInput.repairProfile ?? null,
                },
              })
            : null);
        const runCreatedAt = latestRun?.created_at
          ? new Date(latestRun.created_at).getTime()
          : -1;

        const workingIsNewer = working && workingUpdatedAt >= runCreatedAt;

        if (working && workingIsNewer) {
          const nextDeal = normalizeDealShape(
            (workingPayload.deal as Deal | undefined) ??
              (dbDeal.payload ? normalizeDealShape(dbDeal.payload) : makeInitialDeal()),
          );
          setDeal(nextDeal);
          setSandbox(
            mergeSandboxConfig(
              (workingPayload.sandbox as SandboxConfig | undefined) ??
                DEFAULT_SANDBOX_CONFIG,
            ),
          );
          setPosture(workingPosture);
          if (typeof workingPayload.activeRepairProfileId !== "undefined") {
            setActiveRepairProfileId(workingPayload.activeRepairProfileId ?? null);
          } else {
            setActiveRepairProfileId(null);
          }

          if (runHash && workingHash && runHash === workingHash && latestRun?.output) {
            setLastAnalyzeResult(latestRun.output as AnalyzeResult);
            setLastRunId(latestRun.id ?? null);
            setLastRunAt(latestRun.created_at ?? null);
            lastSavedHashRef.current = workingHash;
            lastSavedDealRef.current = dbDeal.id;
          } else {
            setLastAnalyzeResult(null);
            setLastRunId(latestRun?.id ?? null);
            setLastRunAt(latestRun?.created_at ?? null);
            lastSavedHashRef.current = workingHash;
            lastSavedDealRef.current = dbDeal.id;
          }
          setHasUnsavedDealChanges(false);
          workingHydratedRef.current = true;
          return;
        }

        if (latestRun) {
          const nextDeal = normalizeDealShape(
            (runInput?.deal as Deal | undefined) ??
              (dbDeal.payload ? normalizeDealShape(dbDeal.payload) : makeInitialDeal()),
          );
          setDeal(nextDeal);
          setSandbox(
            mergeSandboxConfig(
              (runInput?.sandbox as SandboxConfig | undefined) ??
                DEFAULT_SANDBOX_CONFIG,
            ),
          );
          setPosture(runPosture);
          if (runInput?.repairProfile?.profileId) {
            setActiveRepairProfileId(runInput.repairProfile.profileId);
          } else {
            setActiveRepairProfileId(null);
          }
          setLastAnalyzeResult(
            (latestRun.output as AnalyzeResult | null | undefined) ?? null,
          );
          setLastRunId(latestRun.id ?? null);
          setLastRunAt(latestRun.created_at ?? null);
          lastSavedHashRef.current = runHash ?? null;
          lastSavedDealRef.current = dbDeal.id;
          setHasUnsavedDealChanges(false);
          workingHydratedRef.current = true;
          return;
        }

        // Fallback: payload from deals row or defaults
        if (dbDeal.payload) {
          setDeal(normalizeDealShape(dbDeal.payload));
        } else {
          setDeal(makeInitialDeal());
        }
        setSandbox(mergeSandboxConfig(DEFAULT_SANDBOX_CONFIG));
        setActiveRepairProfileId(null);
        setActiveRepairProfile(null);
        setRepairRates(null);
        setRepairRatesError(null);
        setPosture("base");
        setLastAnalyzeResult(null);
        setLastRunId(null);
        setLastRunAt(null);
        lastSavedHashRef.current = null;
        lastSavedDealRef.current = dbDeal.id;
        setHasUnsavedDealChanges(false);
      } catch (err) {
        console.error("[DealSession] hydrate working state failed", err);
        setLastAnalyzeResult(null);
        setLastRunId(null);
        setLastRunAt(null);
        lastSavedHashRef.current = null;
      } finally {
        workingHydratedRef.current = true;
        setWorkingHydratedTick((tick) => tick + 1);
      }
    };

    void hydrate();
  }, [dbDeal?.id, dbDeal?.org_id, userId, supabase]);

  // Autosave working state (deal + sandbox + repair profile) per user/deal/org
  const persistWorkingState = useCallback(
    async (opts?: { payload?: WorkingStatePayload; debounceMs?: number }) => {
      if (!workingHydratedRef.current) {
        if (hasUnsavedDealChanges) {
          pendingAutosaveRef.current = true;
        }
        return;
      }
      if (!dbDeal?.id || !dbDeal.org_id || !userId) return;

      const outputsAny = (lastAnalyzeResult as any)?.outputs ?? lastAnalyzeResult ?? null;
      const hasOffer =
        outputsAny &&
        typeof outputsAny.primary_offer !== "undefined" &&
        outputsAny.primary_offer !== null;

      const payload: WorkingStatePayload =
        opts?.payload ??
        {
          deal,
          sandbox,
          repairProfile: repairRates ?? null,
          activeRepairProfileId,
          activeOfferRunId: hasOffer ? lastRunId ?? null : null,
        };
      const postureValue = posture ?? "base";
      const hash = hashWorkingState({
        dealId: dbDeal.id,
        posture: postureValue,
        payload,
      });

      if (
        lastSavedHashRef.current === hash &&
        lastSavedDealRef.current === dbDeal.id
      ) {
        return;
      }

      setAutosaveStatus((prev) => ({
        state: "saving",
        lastSavedAt: prev.lastSavedAt ?? null,
        error: null,
      }));

      const delay = typeof opts?.debounceMs === "number" ? opts.debounceMs : 800;

      await new Promise<void>((resolve) => {
        const timeout = setTimeout(() => {
          upsertWorkingState(supabase, {
            orgId: dbDeal.org_id,
            dealId: dbDeal.id,
            userId,
            posture: postureValue,
            payload,
            sourceRunId: lastRunId ?? null,
          })
            .then(() => {
              lastSavedHashRef.current = hash;
              lastSavedDealRef.current = dbDeal.id;
              setHasUnsavedDealChanges(false);
              setAutosaveStatus({
                state: "saved",
                lastSavedAt: new Date().toISOString(),
                error: null,
              });
            })
            .catch((err) => {
              console.error("[DealSession] autosave working state failed", err);
              setAutosaveStatus((prev) => ({
                state: "error",
                lastSavedAt: prev.lastSavedAt ?? null,
                error: err instanceof Error ? err.message : "Autosave failed",
              }));
            })
            .finally(() => resolve());
        }, delay);

        // Clear if a new persist is scheduled before this one fires
        return () => clearTimeout(timeout);
      });
    },
    [
      activeRepairProfileId,
      dbDeal?.id,
      dbDeal?.org_id,
      deal,
      hasUnsavedDealChanges,
      lastAnalyzeResult,
      lastRunId,
      posture,
      repairRates,
      sandbox,
      supabase,
      userId,
    ],
  );

  useEffect(() => {
    if (!pendingAutosaveRef.current) return;
    if (!workingHydratedRef.current) return;
    pendingAutosaveRef.current = false;
    void persistWorkingState({ debounceMs: 0 });
  }, [persistWorkingState, workingHydratedTick]);

  // Autosave working state (debounced)
  useEffect(() => {
    void persistWorkingState();
  }, [
    deal,
    sandbox,
    posture,
    repairRates,
    activeRepairProfileId,
    dbDeal?.id,
    dbDeal?.org_id,
    userId,
    supabase,
    lastRunId,
    persistWorkingState,
  ]);

  const saveWorkingStateNow = useCallback(
    async (opts?: { payload?: WorkingStatePayload }) => {
      await persistWorkingState({ payload: opts?.payload, debounceMs: 0 });
    },
    [persistWorkingState],
  );

  // Load membership role for the active org
  useEffect(() => {
    const loadRole = async () => {
      try {
        const role = await getActiveOrgMembershipRole(
          supabase,
          dbDeal?.org_id ?? null,
        );
        setMembershipRole(role);
      } catch {
        setMembershipRole(null);
      }
    };
    void loadRole();
  }, [dbDeal?.org_id, supabase]);

  useEffect(() => {
    void loadSandbox();
  }, [loadSandbox]);

  useEffect(() => {
    void refreshRepairRates();
  }, [refreshRepairRates]);

  const value = useMemo(
    () => ({
      deal,
      sandbox,
      posture,
      autosaveStatus,
      saveWorkingStateNow,
      sandboxLoading,
      sandboxError,
      lastAnalyzeResult,
      lastRunId,
      lastRunAt,
      hasUnsavedDealChanges,
      repairRates,
      repairRatesLoading,
      repairRatesError,
      activeRepairProfile,
      activeRepairProfileId,
      negotiationPlaybook,
      negotiatorMessages,
      negotiatorLogicRowIds,
      dbDeal,
      setDeal,
      setSandbox,
      setPosture,
      setHasUnsavedDealChanges,
      setLastRunAt,
      refreshSandbox: loadSandbox,
      refreshRepairRates,
      setLastAnalyzeResult,
      setLastRunId,
      setDbDeal,
      setActiveRepairProfileId,
      setNegotiationPlaybook,
      setNegotiatorMessages,
      appendNegotiatorMessage,
      clearNegotiatorThread,
      setNegotiatorLogicRowIds,
      negotiatorTone,
      setNegotiatorTone,
      membershipRole,
      isHydratingActiveDeal,
      hydratedDealId,
    }),
    [
      deal,
      sandbox,
      posture,
      autosaveStatus,
      saveWorkingStateNow,
      sandboxLoading,
      sandboxError,
      lastAnalyzeResult,
      lastRunId,
      lastRunAt,
      hasUnsavedDealChanges,
      repairRates,
      repairRatesLoading,
      repairRatesError,
      activeRepairProfile,
      activeRepairProfileId,
      negotiationPlaybook,
      negotiatorMessages,
      negotiatorLogicRowIds,
      negotiatorTone,
      dbDeal,
      loadSandbox,
      refreshRepairRates,
      appendNegotiatorMessage,
      clearNegotiatorThread,
      setNegotiatorTone,
      membershipRole,
      isHydratingActiveDeal,
      hydratedDealId,
    ]
  );

  return (
    <DealSessionContext.Provider value={value}>
      {children}
    </DealSessionContext.Provider>
  );
}

export function useDealSession(): DealSessionValue {
  const ctx = useContext(DealSessionContext);
  if (!ctx) {
    throw new Error("useDealSession must be used within a DealSessionProvider");
  }
  return ctx;
}


===== FILE: apps/hps-dealengine/components/underwrite/UnderwriteTab.tsx =====
import React from "react";
import type { Deal, EngineCalculations, SandboxConfig } from "../../types";
import { GlassCard, Button, InputField, SelectField, ToggleSwitch, Icon, Modal, Badge } from "../ui";
import { Tooltip } from "../ui/tooltip";
import ScenarioModeler from "./ScenarioModeler";
import DoubleCloseCalculator from "./DoubleCloseCalculator";
import { num, fmt$ } from "../../utils/helpers";
import { Icons } from "../../constants";
import { getLastAnalyzeResult, subscribeAnalyzeResult } from "../../lib/analyzeBus";
import type { PropertySnapshot, ValuationRun } from "@hps-internal/contracts";
import CompsPanel from "./CompsPanel";
import { useDealSession } from "@/lib/dealSessionContext";
import type { DealContractRow } from "@/lib/dealContracts";

const fmtPercent = (value: number | null | undefined, opts?: { decimals?: number }) => {
  if (value == null || !Number.isFinite(Number(value))) return "-";
  const decimals = opts?.decimals ?? 1;
  return `${(Number(value) * 100).toFixed(decimals)}%`;
};

const UnderwritingSection: React.FC<{ title: string; children: React.ReactNode; icon: string }> = ({
  title,
  icon,
  children,
}) => (
  <GlassCard className="p-5 md:p-6 space-y-4">
    <h3 className="text-lg font-bold text-text-primary flex items-center gap-3">
      <Icon d={icon} size={20} className="text-accent-blue" />
      <span>{title}</span>
    </h3>
    {children}
  </GlassCard>
);

const FieldGroup: React.FC<{ title: string; children: React.ReactNode }> = ({ title, children }) => (
  <div className="space-y-3 p-4 info-card rounded-lg">
    <h4 className="label-xs uppercase tracking-wider text-accent-blue/80 pb-2 mb-3 border-b border-line">
      {title}
    </h4>
    {children}
  </div>
);

interface UnderwriteTabProps {
  deal: Deal;
  dealContract?: DealContractRow | null;
  calc: EngineCalculations;
  setDealValue: (path: string, value: any) => void;
  sandbox: SandboxConfig;
  canEditPolicy: boolean;
  onRequestOverride: (tokenKey: string, newValue: unknown) => void;
  valuationRun?: ValuationRun | null;
  valuationSnapshot?: PropertySnapshot | null;
  minClosedComps?: number | null;
  onRefreshValuation?: (forceRefresh?: boolean) => void;
  refreshingValuation?: boolean;
  valuationError?: string | null;
  valuationStatus?: string | null;
  onApplySuggestedArv?: () => void;
  applyingSuggestedArv?: boolean;
  onOverrideMarketValue?: (
    field: "arv" | "as_is_value",
    value: number,
    reason: string,
    valuationRunId?: string | null,
  ) => Promise<void>;
  overrideStatus?: string | null;
  overrideError?: string | null;
  overrideSaving?: boolean;
  autosaveStatus?: {
    state: "idle" | "saving" | "saved" | "error";
    lastSavedAt: string | null;
    error: string | null;
  };
}

const UnderwriteTab: React.FC<UnderwriteTabProps> = ({
  deal,
  dealContract,
  calc,
  setDealValue,
  sandbox,
  canEditPolicy,
  onRequestOverride,
  valuationRun,
  valuationSnapshot,
  minClosedComps,
  onRefreshValuation,
  refreshingValuation,
  valuationError,
  valuationStatus,
  onApplySuggestedArv,
  applyingSuggestedArv,
  onOverrideMarketValue,
  overrideStatus,
  overrideError,
  overrideSaving,
  autosaveStatus,
}) => {
  const { saveWorkingStateNow } = useDealSession();
  const baseDeal = (deal as any) ?? {};
  const sandboxAny = sandbox as any;

  const property = (baseDeal.property ??
    ({
      occupancy: "owner",
      county: "",
      old_roof_flag: false,
      is_homestead: false,
      is_foreclosure_sale: false,
      is_redemption_period_sale: false,
    } as any)) as any;
  const dealIdFromUrl =
    typeof window !== "undefined"
      ? new URLSearchParams(window.location.search).get("dealId")
      : null;
  const occupancyStorageKey = dealIdFromUrl
    ? `hps-underwrite-occupancy:${dealIdFromUrl}`
    : null;
  const [storedOccupancy, setStoredOccupancy] = React.useState<string | null>(null);

  React.useEffect(() => {
    if (!occupancyStorageKey) return;
    try {
      const raw = sessionStorage.getItem(occupancyStorageKey);
      if (raw) setStoredOccupancy(raw);
    } catch {
      // ignore storage read errors
    }
  }, [occupancyStorageKey]);

  const status = (baseDeal.status ??
    ({
      insurability: "bindable",
      structural_or_permit_risk_flag: false,
      major_system_failure_flag: false,
    } as any)) as any;

  const confidence = (baseDeal.confidence ??
    ({
      no_access_flag: false,
      reinstatement_proof_flag: false,
    } as any)) as any;

  const title = (baseDeal.title ?? {}) as any;

  const policy = (baseDeal.policy ?? {}) as any;

  const costs = (baseDeal.costs ?? {}) as any;
  if (!costs.monthly) {
    costs.monthly = {};
  }

  const debt = (baseDeal.debt ?? { juniors: [] }) as any;
  if (!Array.isArray(debt.juniors)) {
    debt.juniors = [];
  }

  const market = (baseDeal.market ?? {}) as any;
  const legal = (baseDeal.legal ?? {}) as any;
  const timeline = (baseDeal.timeline ?? {}) as any;
  const suggestedArv = valuationRun?.output?.suggested_arv ?? null;
  const suggestedArvMethod = valuationRun?.output?.suggested_arv_source_method ?? "comps_median_v1";
  const suggestedArvCompKindUsed = valuationRun?.output?.suggested_arv_comp_kind_used ?? null;
  const suggestedArvCompCountUsed = valuationRun?.output?.suggested_arv_comp_count_used ?? null;
  const arvRangeLow = valuationRun?.output?.arv_range_low ?? null;
  const arvRangeHigh = valuationRun?.output?.arv_range_high ?? null;
  const selectedCompIds = Array.isArray(valuationRun?.output?.selected_comp_ids)
    ? (valuationRun?.output?.selected_comp_ids ?? []).map((id) => id?.toString?.() ?? "").filter(Boolean)
    : [];
  const selectionSummary: any = valuationRun?.output?.selection_summary ?? null;
  const ladderSummary = selectionSummary?.ladder ?? {};
  const ladderStages: string[] = Array.isArray(ladderSummary?.stages)
    ? ladderSummary.stages
        .map((s: any) => (typeof s === "string" ? s : s?.name ?? null))
        .filter((s: any): s is string => typeof s === "string")
    : [];
  const stopReason = ladderSummary?.stop_reason ?? selectionSummary?.stop_reason ?? null;
  const outlierRemovedIds: string[] = Array.isArray(selectionSummary?.outliers?.removed_ids)
    ? selectionSummary.outliers.removed_ids
    : [];
  const outlierRemovedCount = outlierRemovedIds.length;
  const avmReferencePrice =
    (valuationRun as any)?.output?.avm_reference_price ??
    (valuationRun as any)?.output?.avmPrice ??
    (market as any)?.avm_price ??
    null;
  const avmReferenceLow =
    (valuationRun as any)?.output?.avm_reference_range_low ??
    (market as any)?.avm_price_range_low ??
    null;
  const avmReferenceHigh =
    (valuationRun as any)?.output?.avm_reference_range_high ??
    (market as any)?.avm_price_range_high ??
    null;
  const contractPriceRaw = dealContract?.executed_contract_price ?? null;
  const contractPriceExecuted =
    contractPriceRaw == null || String(contractPriceRaw).trim().length === 0
      ? null
      : Number(contractPriceRaw);
  const valuationBasis = market.valuation_basis ?? "";
  const compCount = valuationRun?.output?.comp_count ?? null;
  const valuationConfidence = valuationRun?.output?.valuation_confidence ?? null;
  const compStats = valuationRun?.output?.comp_set_stats ?? null;
  const provenance = valuationRun?.provenance ?? null;
  const valuationWarningCodes = Array.isArray(valuationRun?.output?.warning_codes)
    ? (valuationRun.output.warning_codes ?? []).filter((w): w is string => typeof w === "string")
    : [];
  const valuationWarnings = valuationWarningCodes.length
    ? valuationWarningCodes
    : Array.isArray(valuationRun?.output?.warnings)
    ? (valuationRun?.output?.warnings ?? []).filter((w): w is string => typeof w === "string")
    : [];
  const displayMinComps =
    minClosedComps ??
    (valuationRun as any)?.provenance?.min_closed_comps_required ??
    (valuationRun as any)?.input?.min_closed_comps_required ??
    null;
  const suggestedApplied = Boolean(
    market?.arv_source === "valuation_run" &&
      valuationRun?.id &&
      market?.arv_valuation_run_id === valuationRun.id,
  );
  const comps = Array.isArray(valuationSnapshot?.comps) ? valuationSnapshot.comps : [];
  const marketSnapshot: any = (valuationSnapshot as any)?.market ?? null;
  const closedSalesCount = comps.filter((c: any) => (c as any)?.comp_kind === "closed_sale").length;
  const listingCount = comps.filter((c: any) => (c as any)?.comp_kind === "sale_listing").length;
  const suggestedArvBasis = valuationRun?.output?.suggested_arv_basis ?? null;
  const ensembleWeights = (valuationRun?.output as any)?.ensemble_weights ?? null;
  const ensembleCapValue = (valuationRun?.output as any)?.ensemble_cap_value ?? null;
  const ensembleCapApplied = (valuationRun?.output as any)?.ensemble_cap_applied === true;
  const uncertaintyRangeLow = (valuationRun?.output as any)?.uncertainty_range_low ?? null;
  const uncertaintyRangeHigh = (valuationRun?.output as any)?.uncertainty_range_high ?? null;
  const uncertaintyRangePct = (valuationRun?.output as any)?.uncertainty_range_pct ?? null;
  const compStatusCounts = React.useMemo(
    () =>
      comps.reduce(
        (acc, comp) => {
          const statusRaw = (comp.status || "").toString().toLowerCase();
          if (
            statusRaw.includes("inactive") ||
            statusRaw.includes("expired") ||
            statusRaw.includes("off")
          ) {
            acc.inactive += 1;
          } else if (statusRaw.includes("active")) {
            acc.active += 1;
          } else if (statusRaw) {
            acc.other += 1;
          } else {
            acc.unknown += 1;
          }
          return acc;
        },
        { active: 0, inactive: 0, other: 0, unknown: 0 },
      ),
    [comps],
  );
  const compsGating = displayMinComps != null ? closedSalesCount < displayMinComps : false;
  const providerLabel =
    provenance?.provider_name ??
    valuationSnapshot?.provider ??
    provenance?.source ??
    valuationSnapshot?.source ??
    "-";
  const snapshotAsOf = valuationSnapshot?.as_of
    ? new Date(valuationSnapshot.as_of).toLocaleDateString()
    : "-";
  const marketSnapshotAsOf =
    (marketSnapshot?.as_of && new Date(marketSnapshot.as_of).toLocaleDateString()) || snapshotAsOf;
  const marketSnapshotSource = marketSnapshot?.source ?? providerLabel;
  const [overrideTarget, setOverrideTarget] = React.useState<"arv" | "as_is_value" | null>(null);
  const [overrideValue, setOverrideValue] = React.useState<string>("");
  const [overrideReason, setOverrideReason] = React.useState<string>("");
  const [overrideLocalError, setOverrideLocalError] = React.useState<string | null>(null);
  const [overrideSubmitting, setOverrideSubmitting] = React.useState(false);

  // Live engine outputs from Edge (via /underwrite/debug analyzeBus)
  const [analysisOutputs, setAnalysisOutputs] = React.useState<any | null>(null);

  React.useEffect(() => {
    const last = getLastAnalyzeResult();
    if (last && (last as any).outputs) {
      setAnalysisOutputs((last as any).outputs);
    }

    const unsubscribe = subscribeAnalyzeResult((result) => {
      setAnalysisOutputs((result as any)?.outputs ?? null);
    });

    // Ensure cleanup returns void, not boolean
    return () => {
      unsubscribe();
    };
  }, []);

  const addJuniorLien = () => {
    const newLien: any = { id: Date.now(), type: "Judgment", balance: "", per_diem: "", good_thru: "" };
    const juniors = (debt.juniors || []) as any[];
    setDealValue("debt.juniors", [...juniors, newLien]);
  };

  const updateJuniorLien = (index: number, field: string, value: any) => {
    const juniors = (debt.juniors || []) as any[];
    const updatedJuniors = [...juniors];
    if (!updatedJuniors[index]) updatedJuniors[index] = {};
    (updatedJuniors[index] as any)[field] = value;
    setDealValue("debt.juniors", updatedJuniors);
  };

  const removeJuniorLien = (index: number) => {
    const juniors = (debt.juniors || []) as any[];
    setDealValue(
      "debt.juniors",
      juniors.filter((_: any, i: number) => i !== index),
    );
  };

  const arvWarning =
    num(market.arv) > 0 &&
    num(market.as_is_value) > 0 &&
    num(market.arv) < num(market.as_is_value)
      ? "ARV is less than As-Is Value. This is unusual and may indicate a data entry error."
      : null;

  const handleApplySuggested = () => {
    if (onApplySuggestedArv) {
      onApplySuggestedArv();
    } else if (suggestedArv != null) {
      setDealValue("market.arv", suggestedArv);
    }
  };

  const openOverrideModal = (field: "arv" | "as_is_value") => {
    setOverrideTarget(field);
    const current = field === "arv" ? market.arv : market.as_is_value;
    setOverrideValue(current ?? "");
    setOverrideReason("");
    setOverrideLocalError(null);
  };

  const closeOverrideModal = () => {
    setOverrideTarget(null);
    setOverrideValue("");
    setOverrideReason("");
    setOverrideLocalError(null);
  };

  const handleOverrideSubmit = async () => {
    if (!overrideTarget) return;
    const numeric = Number(overrideValue);
    if (!Number.isFinite(numeric)) {
      setOverrideLocalError("Enter a valid number.");
      return;
    }
    const trimmedReason = overrideReason.trim();
    if (trimmedReason.length < 10) {
      setOverrideLocalError("Reason must be at least 10 characters.");
      return;
    }
    if (!onOverrideMarketValue) {
      setOverrideLocalError("Override handler is unavailable.");
      return;
    }
    setOverrideSubmitting(true);
    setOverrideLocalError(null);
    try {
      await onOverrideMarketValue(overrideTarget, numeric, trimmedReason, valuationRun?.id ?? null);
      closeOverrideModal();
    } catch (err: any) {
      setOverrideLocalError(err?.message ?? "Failed to save override");
    } finally {
      setOverrideSubmitting(false);
    }
  };

  const warningCopy: Record<string, string> = {
    missing_correlation_signal: "Correlation unavailable; confidence capped at C.",
  };

  const getMinSpreadPlaceholder = () => {
    const arv = num(market.arv, 0);
    const bands: any[] = Array.isArray(sandboxAny.minSpreadByArvBand)
      ? sandboxAny.minSpreadByArvBand
      : [];
    const applicableBand = bands.find((b) => arv <= b.maxArv) || bands[bands.length - 1];
    if (!applicableBand) return "Policy Default";
    return `${fmt$(applicableBand.minSpread, 0)} (Policy)`;
  };

  const commissionItems: any[] = Array.isArray(sandboxAny.listingCostModelSellerCostLineItems)
    ? sandboxAny.listingCostModelSellerCostLineItems
    : [];
  const commissionDefault = commissionItems.find((i) => i.item === "Commissions")?.defaultPct || 6;
  const concessionsDefault = commissionItems.find((i) => i.item === "Seller Concessions")?.defaultPct || 2;
  const sellCloseDefault = commissionItems.find((i) => i.item === "Title & Stamps")?.defaultPct || 1.5;

  const aivSafetyCap =
    analysisOutputs && typeof (analysisOutputs as any).aivSafetyCap === "number"
      ? ((analysisOutputs as any).aivSafetyCap as number)
      : null;

  const carryMonths =
    analysisOutputs && typeof (analysisOutputs as any).carryMonths === "number"
      ? ((analysisOutputs as any).carryMonths as number)
      : null;

  const LockedHint = ({
    tokenKey,
  newValue,
}: {
  tokenKey: string;
  newValue: unknown;
  }) =>
    !canEditPolicy ? (
      <div className="flex items-center justify-between rounded-md border border-white/10 bg-white/5 px-2 py-1 text-[11px] text-text-secondary">
        <span>Locked (policy)</span>
        <Button
          size="sm"
          variant="ghost"
          onClick={() => onRequestOverride(tokenKey, newValue)}
        >
          Request override
        </Button>
      </div>
    ) : null;

  return (
    <div className="flex flex-col gap-6">
      {/* Market & Valuation */}
      <UnderwritingSection title="Market & Valuation" icon={Icons.barChart}>
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex flex-wrap items-center gap-2 text-sm text-text-secondary">
            <span className="font-semibold text-text-primary">Valuation Confidence:</span>
            <span className="text-lg font-semibold text-text-primary">
              {valuationConfidence ?? "-"}
            </span>
            <span className="rounded border border-white/10 px-2 py-1 text-xs">
              {compCount ?? comps.length ?? 0} comps{" "}
              {displayMinComps != null ? `(min ${displayMinComps})` : "(policy missing)"}
            </span>
            {compsGating && (
              <span className="rounded border border-amber-400/40 bg-amber-400/10 px-2 py-1 text-xs text-amber-100">
                Informational only: insufficient closed-sale comps
              </span>
            )}
          </div>
          <div className="flex gap-2">
            <Button
              variant="neutral"
              size="sm"
              onClick={() => onRefreshValuation?.(true)}
              disabled={refreshingValuation || !onRefreshValuation}
            >
              {refreshingValuation ? "Refreshing..." : "Refresh Valuation"}
            </Button>
          </div>
        </div>

        {valuationError && (
          <div className="rounded-md border border-red-400/40 bg-red-500/10 px-3 py-2 text-sm text-red-100">
            {valuationError}
          </div>
        )}
        {valuationStatus && (
          <div className="rounded-md border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-100">
            {valuationStatus}
          </div>
        )}
        {!valuationRun && displayMinComps == null && (
          <div className="rounded-md border border-amber-400/40 bg-amber-500/10 px-3 py-2 text-sm text-amber-100">
            Policy token missing: valuation.min_closed_comps_required
          </div>
        )}

        <div className="grid gap-3 md:grid-cols-2 xl:grid-cols-4">
          <div className="info-card rounded-lg border border-white/5 bg-white/5 p-4 space-y-3">
            <div className="flex items-center justify-between text-xs uppercase tracking-wide text-text-secondary">
              <span>Facts</span>
              {suggestedApplied && (
                <span className="rounded border border-emerald-400/40 px-2 py-1 text-[11px] text-emerald-200">
                  Applied
                </span>
              )}
            </div>
            {autosaveStatus && (
              <div className="text-[11px] text-text-secondary">
                {autosaveStatus.state === "saving" && "Saving..."}
                {autosaveStatus.state === "error" &&
                  (autosaveStatus.error ? `Error: ${autosaveStatus.error}` : "Save error")}
                {autosaveStatus.state !== "saving" &&
                  autosaveStatus.state !== "error" &&
                  (autosaveStatus.lastSavedAt ? "Saved" : null)}
              </div>
            )}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <InputField
                label="ARV"
                type="number"
                prefix="$"
                value={market.arv ?? ""}
                disabled
                warning={arvWarning}
                helpKey="arv"
              />
              <InputField
                label="As-Is Value"
                type="number"
                prefix="$"
                value={market.as_is_value ?? ""}
                disabled
                warning={arvWarning}
                helpKey="aiv"
              />
              <SelectField
                label="Valuation Basis"
                value={valuationBasis}
                onChange={(e: any) => setDealValue("market.valuation_basis", e.target.value)}
              >
                <option value="">Select basis</option>
                <option value="rentcast_avm">RentCast AVM (with comparable sale listings)</option>
                <option value="manual_override">Manual override</option>
              </SelectField>
            </div>
            <div className="flex flex-wrap gap-2">
              <Button
                size="sm"
                variant="neutral"
                onClick={() => openOverrideModal("arv")}
                disabled={overrideSaving}
              >
                Override ARV
              </Button>
              <Button
                size="sm"
                variant="neutral"
                onClick={() => openOverrideModal("as_is_value")}
                disabled={overrideSaving}
              >
                Override As-Is Value
              </Button>
            </div>
            {overrideError && (
              <div className="rounded-md border border-red-400/40 bg-red-500/10 px-3 py-2 text-xs text-red-100">
                {overrideError}
              </div>
            )}
            {overrideStatus && (
              <div className="rounded-md border border-blue-400/40 bg-blue-500/10 px-3 py-2 text-xs text-blue-100">
                {overrideStatus}
              </div>
            )}
            <div className="space-y-2 text-xs text-text-secondary">
              <div className="rounded-md border border-white/10 bg-white/5 p-3 space-y-2">
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div className="space-y-1">
                    <div className="text-sm font-semibold text-text-primary">
                      Suggested ARV (method: {suggestedArvMethod})
                    </div>
                    <div className="flex flex-wrap gap-2">
                      <span className="flex items-center gap-2">
                        {suggestedArvBasis === "ensemble_v1" ? (
                          <Badge color="blue" className="text-[11px] uppercase tracking-wide">
                            Ensemble
                          </Badge>
                        ) : null}
                        {suggestedArv != null ? fmt$(suggestedArv, 0) : ""}{" "}
                        {arvRangeLow != null && arvRangeHigh != null
                          ? `(range ${fmt$(arvRangeLow, 0)}  ${fmt$(arvRangeHigh, 0)})`
                          : ""}
                      </span>
                      {uncertaintyRangeLow != null && uncertaintyRangeHigh != null ? (
                        <span className="rounded border border-white/10 px-2 py-1">
                          Uncertainty: {fmt$(uncertaintyRangeLow, 0)}  {fmt$(uncertaintyRangeHigh, 0)}{" "}
                          {uncertaintyRangePct != null ? `(${fmtPercent(uncertaintyRangePct)})` : ""}
                        </span>
                      ) : null}
                      {ensembleWeights ? (
                        <span className="rounded border border-white/10 px-2 py-1">
                          weights: comps {fmtPercent((ensembleWeights as any).comps ?? null)} / avm{" "}
                          {fmtPercent((ensembleWeights as any).avm ?? null)}
                        </span>
                      ) : null}
                      {ensembleCapValue != null ? (
                        <span className="rounded border border-white/10 px-2 py-1">
                          Ceiling: {fmt$(ensembleCapValue, 0)} {ensembleCapApplied ? "(applied)" : "(not applied)"}
                        </span>
                      ) : null}
                      <span className="rounded border border-white/10 px-2 py-1">
                        Comps: {suggestedArvCompKindUsed ?? "-"} {" "}
                        {suggestedArvCompCountUsed ?? 0} used
                      </span>
                      <span className="rounded border border-white/10 px-2 py-1">
                        Selection: {ladderStages.length > 0 ? ladderStages.join(" -> ") : "stages unknown"} (stop:{" "}
                        {stopReason ?? "n/a"})
                      </span>
                      <span className="rounded border border-white/10 px-2 py-1">
                        Outliers removed: {outlierRemovedCount}
                      </span>
                    </div>
                  </div>
                  <Button
                    size="sm"
                    variant="neutral"
                    onClick={handleApplySuggested}
                    disabled={applyingSuggestedArv || suggestedApplied || suggestedArv == null}
                  >
                    {suggestedApplied
                      ? "Applied"
                      : applyingSuggestedArv
                      ? "Applying..."
                      : "Use Suggested ARV"}
                  </Button>
                </div>
                {valuationWarnings.length > 0 && (
                  <div className="flex flex-wrap gap-2">
                    {valuationWarnings.map((w) => (
                      <span
                        key={w}
                        className="rounded border border-amber-400/40 bg-amber-500/10 px-2 py-1 text-[11px] text-amber-100"
                      >
                        {w.replace(/_/g, " ")}
                      </span>
                    ))}
                  </div>
                )}
              </div>

              <div className="rounded-md border border-white/10 bg-white/5 p-3 space-y-2">
                <div className="text-sm font-semibold text-text-primary">AVM Reference (RentCast)</div>
                <div className="flex flex-wrap gap-2">
                  <span>
                    {avmReferencePrice != null ? fmt$(avmReferencePrice, 0) : ""}{" "}
                    {avmReferenceLow != null && avmReferenceHigh != null
                      ? `(range ${fmt$(avmReferenceLow, 0)}  ${fmt$(avmReferenceHigh, 0)})`
                      : ""}
                  </span>
                  <span className="rounded border border-white/10 px-2 py-1">
                    Provider: {providerLabel} {provenance?.stub ? "(stub)" : ""}
                  </span>
                  <span className="rounded border border-white/10 px-2 py-1">As of: {snapshotAsOf}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="info-card rounded-lg border border-white/5 bg-white/5 p-4 space-y-3">
            <div className="text-xs uppercase tracking-wide text-text-secondary">Market</div>
            <div className="space-y-2 text-sm text-text-secondary">
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">Contract Price (Executed)</span>
                <span
                  className="rounded border border-white/10 px-2 py-1"
                  data-testid="executed-contract-price"
                >
                  {contractPriceExecuted != null && Number.isFinite(contractPriceExecuted)
                    ? fmt$(contractPriceExecuted, 0)
                    : ""}
                </span>
                {(contractPriceExecuted == null ||
                  !Number.isFinite(contractPriceExecuted)) && (
                  <Tooltip content="Set when the deal is marked Under Contract.">
                    <span className="sr-only">No contract price yet</span>
                  </Tooltip>
                )}
              </div>
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">DOM (Zip, days)</span>
                {marketSnapshot?.dom_zip_days != null ? (
                  <span className="rounded border border-white/10 px-2 py-1">
                    {marketSnapshot.dom_zip_days}
                  </span>
                ) : (
                  <Tooltip content="Not available from v1 provider; planned in v2.">
                    <span className="rounded border border-white/10 px-2 py-1"></span>
                  </Tooltip>
                )}
              </div>
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">MOI (Zip, months)</span>
                {marketSnapshot?.moi_zip_months != null ? (
                  <span className="rounded border border-white/10 px-2 py-1">
                    {marketSnapshot.moi_zip_months}
                  </span>
                ) : (
                  <Tooltip content="Not available from v1 provider; planned in v2.">
                    <span className="rounded border border-white/10 px-2 py-1"></span>
                  </Tooltip>
                )}
              </div>
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">Price-to-List %</span>
                {marketSnapshot?.price_to_list_pct != null ? (
                  <span className="rounded border border-white/10 px-2 py-1">
                    {`${Number(marketSnapshot.price_to_list_pct * 100).toFixed(1)}%`}
                  </span>
                ) : (
                  <Tooltip content="Not available from v1 provider; planned in v2.">
                    <span className="rounded border border-white/10 px-2 py-1"></span>
                  </Tooltip>
                )}
              </div>
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">Local Discount (20th %)</span>
                {marketSnapshot?.local_discount_pct_p20 != null ? (
                  <span className="rounded border border-white/10 px-2 py-1">
                    {`${Number(marketSnapshot.local_discount_pct_p20 * 100).toFixed(1)}%`}
                  </span>
                ) : (
                  <Tooltip content="Not available from v1 provider; planned in v2.">
                    <span className="rounded border border-white/10 px-2 py-1"></span>
                  </Tooltip>
                )}
              </div>
              <div className="flex items-center gap-2">
                <span className="w-40 text-text-primary">Flood / SFHA</span>
                <span className="rounded border border-white/10 px-2 py-1">
                  Not connected (v1)
                </span>
              </div>
              <div className="flex flex-wrap items-center gap-2 text-xs">
                <span className="rounded border border-white/10 px-2 py-1">
                  Source: {marketSnapshotSource ?? "-"}
                </span>
                <span className="rounded border border-white/10 px-2 py-1">
                  As of: {marketSnapshotAsOf}
                </span>
              </div>
            </div>
          </div>

          <div className="info-card rounded-lg border border-white/5 bg-white/5 p-4 space-y-3">
            <div className="text-xs uppercase tracking-wide text-text-secondary">Comps</div>
            <div className="text-sm font-semibold text-text-primary">
              Comparable sale listings (RentCast)
            </div>
            <div className="flex flex-wrap items-center gap-2 text-sm text-text-secondary">
              <span className="font-semibold text-text-primary">{comps.length} listings</span>
              {displayMinComps != null ? (
                <span className="rounded border border-white/10 px-2 py-1 text-xs">min {displayMinComps}</span>
              ) : (
                <span className="rounded border border-amber-400/40 px-2 py-1 text-xs text-amber-100">
                  valuation.min_closed_comps_required missing
                </span>
              )}
            </div>
            <div className="flex flex-wrap gap-2 text-xs text-text-secondary">
              <span>Active: {compStatusCounts.active}</span>
              <span>Inactive: {compStatusCounts.inactive}</span>
              <span>Other: {compStatusCounts.other}</span>
              <span>Unknown: {compStatusCounts.unknown}</span>
            </div>
            {compStats && (
              <div className="text-xs text-text-secondary">
                Listing stats: {compCount ?? "-"} listings, med dist {compStats.median_distance_miles ?? "-"} mi, med
                corr {compStats.median_correlation ?? "-"}, med days-old {compStats.median_days_old ?? "-"}
              </div>
            )}
            <div className="flex flex-wrap gap-2 text-xs text-text-secondary">
              <span className="rounded border border-white/10 px-2 py-1">Provider: {providerLabel}</span>
              <span className="rounded border border-white/10 px-2 py-1">As of: {snapshotAsOf}</span>
              {valuationSnapshot?.stub && (
                <span className="rounded border border-amber-400/40 px-2 py-1 text-amber-100">Stub data</span>
              )}
            </div>
            {compsGating && (
              <div className="rounded-md border border-amber-400/40 bg-amber-400/10 px-3 py-2 text-xs text-amber-100">
                Insufficient comparable sale listings. Valuation is informational only.
              </div>
            )}
          </div>

          <div className="info-card rounded-lg border border-white/5 bg-white/5 p-4 space-y-3">
            <div className="text-xs uppercase tracking-wide text-text-secondary">Confidence</div>
            <div className="flex items-baseline gap-2">
              <span className="text-2xl font-semibold text-text-primary">
                {valuationConfidence ?? "-"}
              </span>
              <span className="text-xs text-text-secondary">Valuation Confidence</span>
            </div>
            <div className="text-xs text-text-secondary">
              {compCount != null
                ? `${compCount} comps scored${displayMinComps != null ? ` / min ${displayMinComps}` : ""}`
                : "No valuation run yet."}
            </div>
            {valuationWarnings.length > 0 && (
              <ul className="list-disc space-y-1 pl-4 text-xs text-amber-100">
                {valuationWarnings.map((w) => (
                  <li key={w}>{warningCopy[w] ?? w}</li>
                ))}
              </ul>
            )}
            {compsGating && (
              <div className="text-xs text-amber-100">
                Confidence capped until comps meet policy thresholds.
              </div>
            )}
          </div>
        </div>
      </UnderwritingSection>

      {valuationSnapshot && Array.isArray(valuationSnapshot.comps) && (
        <CompsPanel
          comps={valuationSnapshot.comps as any}
          snapshot={valuationSnapshot}
          minClosedComps={displayMinComps}
          onRefresh={(force) => onRefreshValuation?.(force)}
          refreshing={refreshingValuation}
          selectedCompIds={selectedCompIds}
          selectedCompsDetailed={(valuationRun?.output as any)?.selected_comps as any}
          selectionVersion={(valuationRun?.output as any)?.selection_version ?? null}
          selectionDiagnostics={(valuationRun?.output as any)?.selection_diagnostics as any}
        />
      )}

      {/* Property & Risk */}
      <UnderwritingSection title="Property & Risk" icon={Icons.shield}>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div className="space-y-3">
            <SelectField
              label="Occupancy"
              value={storedOccupancy ?? property.occupancy}
              dataTestId="uw-occupancy"
              onChange={(e: any) => {
                const nextValue = e.target.value;
                setDealValue("property.occupancy", nextValue);
                setStoredOccupancy(nextValue);
                if (occupancyStorageKey) {
                  try {
                    sessionStorage.setItem(occupancyStorageKey, nextValue);
                  } catch {
                    // ignore storage write errors
                  }
                }
                setTimeout(() => {
                  void saveWorkingStateNow();
                }, 0);
              }}
            >
              <option value="owner">Owner</option>
              <option value="tenant">Tenant</option>
              <option value="vacant">Vacant</option>
            </SelectField>

            <SelectField
              label="Insurance Bindability"
              value={status.insurability}
              onChange={(e: any) => setDealValue("status.insurability", e.target.value)}
            >
              <option value="bindable">Bindable</option>
              <option value="conditional">Conditional</option>
              <option value="unbindable">Unbindable</option>
            </SelectField>

            <InputField
              label="County"
              value={property.county}
              dataTestId="uw-county"
              onChange={(e: any) => {
                const nextValue = e.target.value;
                setDealValue("property.county", nextValue);
                setTimeout(() => {
                  void saveWorkingStateNow();
                }, 0);
              }}
            />
          </div>

          <div className="info-card space-y-3 p-4">
            <ToggleSwitch
              label="No Interior Access"
              checked={!!confidence.no_access_flag}
              onChange={() =>
                setDealValue("confidence.no_access_flag", !confidence.no_access_flag)
              }
            />
            <ToggleSwitch
              label="Structural/Permit/WDO Risk"
              checked={!!status.structural_or_permit_risk_flag}
              onChange={() =>
                setDealValue(
                  "status.structural_or_permit_risk_flag",
                  !status.structural_or_permit_risk_flag,
                )
              }
            />
            <ToggleSwitch
              label="Old Roof (>20 years)"
              checked={!!property.old_roof_flag}
              onChange={() => setDealValue("property.old_roof_flag", !property.old_roof_flag)}
            />
          </div>

          <div className="info-card space-y-3 p-4">
            <ToggleSwitch
              label="Major System Failure"
              checked={!!status.major_system_failure_flag}
              onChange={() =>
                setDealValue(
                  "status.major_system_failure_flag",
                  !status.major_system_failure_flag,
                )
              }
            />
            <ToggleSwitch
              label="Reinstatement Proof"
              checked={!!confidence.reinstatement_proof_flag}
              onChange={() =>
                setDealValue(
                  "confidence.reinstatement_proof_flag",
                  !confidence.reinstatement_proof_flag,
                )
              }
            />
            <ToggleSwitch
              label="Homestead Status"
              checked={!!property.is_homestead}
              onChange={() => setDealValue("property.is_homestead", !property.is_homestead)}
            />
          </div>
        </div>
      </UnderwritingSection>

      {/* Debt & Liens */}
      <UnderwritingSection title="Debt & Liens" icon={Icons.briefcase}>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <FieldGroup title="Senior Lien Payoff">
            <div className="grid grid-cols-2 gap-3 items-end">
              <InputField
                label="Senior Principal"
                type="number"
                prefix="$"
                value={debt.senior_principal ?? ""}
                onChange={(e: any) => setDealValue("debt.senior_principal", e.target.value)}
                disabled={!canEditPolicy}
              />
              <InputField
                label="Senior Per Diem"
                type="number"
                prefix="$"
                min="0"
                value={debt.senior_per_diem ?? ""}
                onChange={(e: any) => setDealValue("debt.senior_per_diem", e.target.value)}
                disabled={!canEditPolicy}
              />
              <InputField
                label="Payoff Good-Thru"
                type="date"
                value={debt.good_thru_date ?? ""}
                onChange={(e: any) => setDealValue("debt.good_thru_date", e.target.value)}
                disabled={!canEditPolicy}
              />
              <ToggleSwitch
                label="Payoff Confirmed"
                checked={!!debt.payoff_is_confirmed}
                onChange={() =>
                  canEditPolicy &&
                  setDealValue("debt.payoff_is_confirmed", !debt.payoff_is_confirmed)
                }
              />
              <InputField
                label="Protective Advances"
                type="number"
                prefix="$"
                min="0"
                value={debt.protective_advances ?? ""}
                onChange={(e: any) => setDealValue("debt.protective_advances", e.target.value)}
                disabled={!canEditPolicy}
              />
              <LockedHint tokenKey="debt" newValue={debt} />
            </div>
          </FieldGroup>

          <FieldGroup title="Other Encumbrances & Title">
            <div className="grid grid-cols-2 gap-3 items-end">
              <InputField
                label="Title Cure Cost"
                type="number"
                prefix="$"
                min="0"
                value={title.cure_cost ?? ""}
                onChange={(e: any) => setDealValue("title.cure_cost", e.target.value)}
                disabled={!canEditPolicy}
              />
              <InputField
                label="Title Risk %"
                type="number"
                suffix="%"
                min="0"
                max="3"
                value={Number(title.risk_pct ?? 0) * 100}
                onChange={(e: any) => setDealValue("title.risk_pct", e.target.value)}
                disabled={!canEditPolicy}
              />
              <InputField
                label="HOA Estoppel Fee"
                type="number"
                prefix="$"
                min="0"
                value={debt.hoa_estoppel_fee ?? ""}
                onChange={(e: any) => setDealValue("debt.hoa_estoppel_fee", e.target.value)}
                disabled={!canEditPolicy}
              />
              <LockedHint tokenKey="title" newValue={title} />
            </div>
          </FieldGroup>
        </div>

        <div className="mt-6">
          <div className="flex justify-between items-center mb-2">
            <h4 className="label-xs uppercase tracking-wider text-accent-blue/80">Junior Liens</h4>
            <Button
              size="sm"
              variant="neutral"
              onClick={addJuniorLien}
              disabled={!canEditPolicy}
            >
              + Add Lien
            </Button>
          </div>

          <div className="space-y-2">
            {(debt.juniors || []).map((lien: any, index: number) => (
              <div
                key={lien.id || index}
                className="info-card grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-2 items-end p-2"
              >
                <InputField
                  label="Type"
                  placeholder="HELOC, etc"
                  value={lien.type || ""}
                  onChange={(e: any) => updateJuniorLien(index, "type", e.target.value)}
                  disabled={!canEditPolicy}
                />
                <InputField
                  label="Balance"
                  type="number"
                  prefix="$"
                  value={lien.balance}
                  onChange={(e: any) => updateJuniorLien(index, "balance", e.target.value)}
                  disabled={!canEditPolicy}
                />
                <InputField
                  label="Per Diem"
                  type="number"
                  prefix="$"
                  value={lien.per_diem}
                  onChange={(e: any) => updateJuniorLien(index, "per_diem", e.target.value)}
                  disabled={!canEditPolicy}
                />
                <InputField
                  label="Good-Thru"
                  type="date"
                  value={lien.good_thru || ""}
                  onChange={(e: any) => updateJuniorLien(index, "good_thru", e.target.value)}
                  disabled={!canEditPolicy}
                />
                <Button
                  size="sm"
                  variant="danger"
                  className="h-[38px] w-full"
                  onClick={() => removeJuniorLien(index)}
                  disabled={!canEditPolicy}
                >
                  Remove
                </Button>
              </div>
            ))}
          </div>
          {!canEditPolicy && (
            <div className="text-[11px] text-text-secondary">
              Junior liens locked; request override to change payoff assumptions.
            </div>
          )}
        </div>
      </UnderwritingSection>

      {/* Policy & Fees */}
      <UnderwritingSection title="Policy & Fees" icon={Icons.sliders}>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <InputField
            label="Assignment Fee Target"
            type="number"
            prefix="$"
            value={policy.assignment_fee_target ?? ""}
            onChange={(e: any) => setDealValue("policy.assignment_fee_target", e.target.value)}
            placeholder="Optional"
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="policy.assignment_fee_target"
            newValue={policy.assignment_fee_target ?? null}
          />

          <InputField
            label="List Commission Override %"
            type="number"
            suffix="%"
            value={
              costs.list_commission_pct != null
                ? costs.list_commission_pct * 100
                : ""
            }
            onChange={(e: any) => {
              const raw = e.target.value;
              setDealValue(
                "costs.list_commission_pct",
                raw == null || raw === "" ? null : parseFloat(raw) / 100,
              );
            }}
            placeholder={`${commissionDefault}% (Policy)`}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="costs.list_commission_pct"
            newValue={costs.list_commission_pct ?? null}
          />

          <InputField
            label="Sell Close Costs %"
            type="number"
            suffix="%"
            value={Number(costs.sell_close_pct ?? 0) * 100}
            onChange={(e: any) => {
              const raw = e.target.value;
              setDealValue(
                "costs.sell_close_pct",
                raw == null || raw === "" ? null : parseFloat(raw) / 100,
              );
            }}
            min="0"
            max="30"
            step="0.1"
            placeholder={`${sellCloseDefault}% (Policy)`}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="costs.sell_close_pct"
            newValue={costs.sell_close_pct ?? null}
          />

          <InputField
            label="Seller Concessions %"
            type="number"
            suffix="%"
            value={Number(costs.concessions_pct ?? 0) * 100}
            onChange={(e: any) => {
              const raw = e.target.value;
              setDealValue(
                "costs.concessions_pct",
                raw == null || raw === "" ? null : parseFloat(raw) / 100,
              );
            }}
            min="0"
            max="30"
            step="0.1"
            placeholder={`${concessionsDefault}% (Policy)`}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="costs.concessions_pct"
            newValue={costs.concessions_pct ?? null}
          />

          <InputField
            label="Safety Margin on AIV %"
            type="number"
            suffix="%"
            value={Number(policy.safety_on_aiv_pct ?? 0) * 100}
            onChange={(e: any) => {
              const raw = e.target.value;
              setDealValue(
                "policy.safety_on_aiv_pct",
                raw == null || raw === "" ? null : parseFloat(raw) / 100,
              );
            }}
            min="0"
            max="10"
            step="0.1"
            placeholder={`${sandboxAny.aivSafetyCapPercentage || 3}% (Policy)`}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="policy.safety_on_aiv_pct"
            newValue={policy.safety_on_aiv_pct ?? null}
          />

          <InputField
            label="Min Spread"
            type="number"
            prefix="$"
            value={policy.min_spread ?? ""}
            onChange={(e: any) => setDealValue("policy.min_spread", e.target.value)}
            placeholder={getMinSpreadPlaceholder()}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="policy.min_spread"
            newValue={policy.min_spread ?? null}
          />

          <InputField
            label="Monthly Interest"
            type="number"
            prefix="$"
            min="0"
            value={costs.monthly.interest ?? ""}
            onChange={(e: any) => setDealValue("costs.monthly.interest", e.target.value)}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="costs.monthly.interest"
            newValue={costs.monthly.interest ?? null}
          />

          <ToggleSwitch
            label="Costs Are Annual"
            checked={!!policy.costs_are_annual}
            onChange={() =>
              setDealValue("policy.costs_are_annual", !policy.costs_are_annual)
            }
          />
        </div>
      </UnderwritingSection>

      {/* Timeline & Legal */}
      <UnderwritingSection title="Timeline & Legal" icon={Icons.alert}>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 items-end">
          <div className="pt-4 md:col-span-2">
            <ToggleSwitch
              label="Foreclosure Sale (Certificate of Title Issued)"
              checked={!!property.is_foreclosure_sale}
              onChange={() =>
                setDealValue(
                  "property.is_foreclosure_sale",
                  !property.is_foreclosure_sale,
                )
              }
            />
          </div>
          <div className="pt-4 md:col-span-2">
            <ToggleSwitch
              label="10-Day Redemption Period Applies"
              checked={!!property.is_redemption_period_sale}
              onChange={() =>
                setDealValue(
                  "property.is_redemption_period_sale",
                  !property.is_redemption_period_sale,
                )
              }
            />
          </div>

          <InputField
            label="Case No."
            value={legal.case_no ?? ""}
            onChange={(e: any) => setDealValue("legal.case_no", e.target.value)}
          />
          <InputField
            label="Auction Date"
            type="date"
            value={timeline.auction_date ?? ""}
            onChange={(e: any) => setDealValue("timeline.auction_date", e.target.value)}
          />
          <InputField
            label="Planned Close"
            type="number"
            suffix="days"
            value={policy.planned_close_days ?? ""}
            onChange={(e: any) => setDealValue("policy.planned_close_days", e.target.value)}
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="policy.planned_close_days"
            newValue={policy.planned_close_days ?? null}
          />
          <InputField
            label="Manual Days to Money"
            placeholder="Overrides auto-calc"
            type="number"
            suffix="days"
            min="0"
            value={policy.manual_days_to_money ?? ""}
            onChange={(e: any) =>
              setDealValue(
                "policy.manual_days_to_money",
                e.target.value === "" ? null : e.target.value,
              )
            }
            disabled={!canEditPolicy}
          />
          <LockedHint
            tokenKey="policy.manual_days_to_money"
            newValue={policy.manual_days_to_money ?? null}
          />
        </div>
      </UnderwritingSection>

      {/* Scenario Modeler */}
      <UnderwritingSection title="Scenario Modeler" icon={Icons.lightbulb}>
        <ScenarioModeler deal={deal} setDealValue={setDealValue} sandbox={sandbox} calc={calc} />
      </UnderwritingSection>

      {/* Double Close Calculator */}
      <UnderwritingSection title="HPS Double Closing Cost Calculator" icon={Icons.calculator}>
        <DoubleCloseCalculator deal={deal} calc={calc} setDealValue={setDealValue} />
      </UnderwritingSection>

      <Modal
        open={overrideTarget !== null}
        onClose={closeOverrideModal}
        title={overrideTarget === "arv" ? "Override ARV" : "Override As-Is Value"}
      >
        <div className="space-y-3">
          <InputField
            label={overrideTarget === "arv" ? "ARV" : "As-Is Value"}
            type="number"
            prefix="$"
            value={overrideValue}
            onChange={(e: any) => {
              const raw = e.target.value;
              setOverrideValue(raw == null ? "" : raw);
            }}
          />
          <div className="space-y-1">
            <label className="text-sm text-text-primary">Reason (required)</label>
            <textarea
              className="w-full rounded-md border border-white/10 bg-white/5 px-2 py-2 text-sm text-text-primary focus:border-accent-blue/60 focus:outline-none"
              value={overrideReason}
              onChange={(e) => setOverrideReason(e.target.value)}
              minLength={10}
              rows={3}
            />
            <p className="text-[11px] text-text-secondary">Minimum 10 characters.</p>
          </div>
          {overrideLocalError && (
            <div className="rounded-md border border-red-400/40 bg-red-500/10 px-3 py-2 text-xs text-red-100">
              {overrideLocalError}
            </div>
          )}
          <div className="flex justify-end gap-2">
            <Button variant="ghost" size="sm" onClick={closeOverrideModal} disabled={overrideSubmitting}>
              Cancel
            </Button>
            <Button
              variant="primary"
              size="sm"
              onClick={handleOverrideSubmit}
              disabled={overrideSubmitting}
            >
              {overrideSubmitting || overrideSaving ? "Saving..." : "Save Override"}
            </Button>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default UnderwriteTab;


===== FILE: apps/hps-dealengine/components/underwrite/DoubleCloseCalculator.tsx =====
import React from 'react';
import { GlassCard, Button, InputField, SelectField, ToggleSwitch, Badge } from '../ui';
import { DoubleClose } from '../../services/engine';
import { fmt$ } from '../../utils/helpers';
import type { Deal, EngineCalculations } from '../../types';

interface DoubleCloseCalculatorProps {
  deal: Deal;
  calc: EngineCalculations;
  setDealValue: (path: string, value: any) => void;
}

const DoubleCloseCalculator: React.FC<DoubleCloseCalculatorProps> = ({
  deal,
  calc,
  setDealValue,
}) => {
  const setDC = (k: string, v: any) => setDealValue(`costs.double_close.${k}`, v);
  const dc = (deal as any).costs?.double_close || {};
  const dcCalcs = DoubleClose.computeDoubleClose(dc, { deal });

  const doAutofill = () => {
    const filled = DoubleClose.autofill(dc, { deal }, calc);
    setDealValue('costs.double_close', filled);
  };

  const isSimple = !!dc.use_simple_mode;

  return (
    <div className="space-y-4 mt-3">
      <GlassCard className="p-4 md:p-5">
        <div className="flex items-center justify-between">
          <div className="label-xs uppercase">Double Close Tools</div>
          <div className="flex items-center gap-3">
            <ToggleSwitch
              label={isSimple ? 'Simple' : 'Advanced'}
              checked={isSimple}
              onChange={() => setDC('use_simple_mode', !isSimple)}
            />
            <Button size="sm" onClick={doAutofill}>
              Autofill from deal
            </Button>
          </div>
        </div>
      </GlassCard>

      {isSimple ? (
        <GlassCard className="p-5 md:p-6 space-y-3">
          <h4 className="label-xs uppercase">Simple Mode - Core Inputs</h4>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <SelectField
              label="County"
              value={dc.county || 'Orange'}
              onChange={(e) => setDC('county', e.target.value)}
            >
              <option>Orange</option>
              <option>Osceola</option>
              <option>Polk</option>
              <option>Miami-Dade</option>
            </SelectField>
            <InputField
              label="AB Price (Pab)"
              type="number"
              prefix="$"
              value={Number.isFinite(dc.pab) ? dc.pab : ''}
              onChange={(e) => setDC('pab', e.target.value)}
              placeholder="Enter Price"
            />
            <InputField
              label="BC Price (Pbc)"
              type="number"
              prefix="$"
              value={Number.isFinite(dc.pbc) ? dc.pbc : ''}
              onChange={(e) => setDC('pbc', e.target.value)}
              placeholder="Enter Price"
            />
            <SelectField
              label="Structure"
              value={dc.type || 'Same-day'}
              onChange={(e) => setDC('type', e.target.value)}
            >
              <option>Same-day</option>
              <option>Held-days</option>
            </SelectField>
            <InputField
              label="Days Held"
              type="number"
              value={dc.type === 'Same-day' ? 0 : dc.days_held || ''}
              onChange={(e) => setDC('days_held', e.target.value)}
              disabled={dc.type === 'Same-day'}
            />
            <ToggleSwitch
              label="Using Transactional Funding?"
              checked={!!dc.using_tf}
              onChange={() => setDC('using_tf', !dc.using_tf)}
            />
            {dc.using_tf && (
              <>
                <InputField
                  label="TF Principal"
                  type="number"
                  prefix="$"
                  value={Number.isFinite(dc.tf_principal) ? dc.tf_principal : ''}
                  onChange={(e) => setDC('tf_principal', e.target.value)}
                  placeholder="Enter Amount"
                />
                <InputField
                  label="TF Points (e.g., 0.02)"
                  value={dc.tf_points_rate || ''}
                  onChange={(e) => setDC('tf_points_rate', e.target.value)}
                />
              </>
            )}
            <SelectField
              label="HOA/Condo Present?"
              value={dc.association_present || 'No'}
              onChange={(e) => setDC('association_present', e.target.value)}
            >
              <option>No</option>
              <option>Yes-HOA</option>
              <option>Yes-Condo</option>
            </SelectField>
            {dc.association_present !== 'No' && (
              <SelectField
                label="Rush Estoppel?"
                value={dc.rush_estoppel || 'No'}
                onChange={(e) => setDC('rush_estoppel', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
              </SelectField>
            )}
          </div>
        </GlassCard>
      ) : (
        <>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">A) Property & County</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <SelectField
                label="County"
                value={dc.county || 'Orange'}
                onChange={(e) => setDC('county', e.target.value)}
              >
                <option>Orange</option>
                <option>Osceola</option>
                <option>Polk</option>
              </SelectField>
              <SelectField
                label="Property Type"
                value={dc.property_type || 'SFR'}
                onChange={(e) => setDC('property_type', e.target.value)}
              >
                <option>SFR</option>
                <option>Townhome</option>
                <option>Condo</option>
                <option>Duplex/2-4</option>
                <option>Mobile on land</option>
                <option>Vacant land</option>
              </SelectField>
              <SelectField
                label="HOA/Condo Present"
                value={dc.association_present || 'No'}
                onChange={(e) => setDC('association_present', e.target.value)}
              >
                <option>No</option>
                <option>Yes-HOA</option>
                <option>Yes-Condo</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">B) Structure & Timing</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <SelectField
                label="Double-close type"
                value={dc.type || 'Same-day'}
                onChange={(e) => setDC('type', e.target.value)}
              >
                <option>Same-day</option>
                <option>Held-days</option>
              </SelectField>
              <InputField
                label="Days held (A-B  B-C)"
                type="number"
                value={dc.days_held || ''}
                onChange={(e) => setDC('days_held', e.target.value)}
              />
              <SelectField
                label="Same-day order (if applicable)"
                value={dc.same_day_order || 'No preference'}
                onChange={(e) => setDC('same_day_order', e.target.value)}
              >
                <option>No preference</option>
                <option>A-B AM / B-C PM</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">C) A-B (you BUY from seller)</h4>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
              <InputField
                label="Pab"
                type="number"
                prefix="$"
                value={Number.isFinite(dc.pab) ? dc.pab : ''}
                onChange={(e) => setDC('pab', e.target.value)}
                placeholder="Enter Price"
              />
              <InputField
                label="Title/settlement A-B"
                type="number"
                prefix="$"
                value={dc.title_ab || ''}
                onChange={(e) => setDC('title_ab', e.target.value)}
              />
              <InputField
                label="Other fees A-B"
                type="number"
                prefix="$"
                value={dc.other_ab || ''}
                onChange={(e) => setDC('other_ab', e.target.value)}
              />
              <SelectField
                label="Owner's title policy paid by (A-B)"
                value={dc.owners_title_payer_ab || 'Unknown'}
                onChange={(e) => setDC('owners_title_payer_ab', e.target.value)}
              >
                <option>Seller</option>
                <option>You</option>
                <option>Unknown</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">D) B-C (you SELL to end-buyer)</h4>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
              <InputField
                label="Pbc"
                type="number"
                prefix="$"
                value={Number.isFinite(dc.pbc) ? dc.pbc : ''}
                onChange={(e) => setDC('pbc', e.target.value)}
                placeholder="Enter Price"
              />
              <InputField
                label="Title/settlement B-C"
                type="number"
                prefix="$"
                value={dc.title_bc || ''}
                onChange={(e) => setDC('title_bc', e.target.value)}
              />
              <InputField
                label="Other fees B-C"
                type="number"
                prefix="$"
                value={dc.other_bc || ''}
                onChange={(e) => setDC('other_bc', e.target.value)}
              />
              <SelectField
                label="Owner's title policy paid by (B-C)"
                value={dc.owners_title_payer_bc || 'Unknown'}
                onChange={(e) => setDC('owners_title_payer_bc', e.target.value)}
              >
                <option>You</option>
                <option>End buyer</option>
                <option>Unknown</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">E) End-buyer funds</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <SelectField
                label="Buyer funds"
                value={dc.buyer_funds || 'Cash'}
                onChange={(e) => setDC('buyer_funds', e.target.value)}
              >
                <option>Cash</option>
                <option>Conventional</option>
                <option>DSCR/Investor</option>
                <option>Hard money</option>
                <option>FHA</option>
                <option>VA</option>
              </SelectField>
              <SelectField
                label="Lender known"
                value={dc.lender_known || 'N/A'}
                onChange={(e) => setDC('lender_known', e.target.value)}
              >
                <option>N/A</option>
                <option>Yes</option>
                <option>No</option>
              </SelectField>
              <InputField
                label="ARV (for fee check)"
                type="number"
                prefix="$"
                value={dc.arv_for_fee_check || (deal as any).market?.arv || ''}
                onChange={(e) => setDC('arv_for_fee_check', e.target.value)}
              />
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">F) Transactional Funding (A-B)</h4>
            <div className="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
              <ToggleSwitch
                label="Using Transactional Funding?"
                checked={!!dc.using_tf}
                onChange={() => setDC('using_tf', !dc.using_tf)}
              />
              <InputField
                label="TF principal"
                type="number"
                prefix="$"
                value={Number.isFinite(dc.tf_principal) ? dc.tf_principal : ''}
                onChange={(e) => setDC('tf_principal', e.target.value)}
                placeholder="Enter Amount"
              />
              <InputField
                label="TF points rate"
                type="number"
                placeholder="e.g., 0.02"
                value={dc.tf_points_rate || ''}
                onChange={(e) => setDC('tf_points_rate', e.target.value)}
              />
              <SelectField
                label="Note executed in FL?"
                value={dc.tf_note_executed_fl || 'No'}
                onChange={(e) => setDC('tf_note_executed_fl', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
                <option>Unsure</option>
              </SelectField>
              <SelectField
                label="Note secured by property?"
                value={dc.tf_secured || 'No'}
                onChange={(e) => setDC('tf_secured', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
                <option>Unsure</option>
              </SelectField>
              <InputField
                label="TF extra fees"
                type="number"
                prefix="$"
                value={dc.tf_extra_fees || ''}
                onChange={(e) => setDC('tf_extra_fees', e.target.value)}
              />
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">G) HOA / Condo (if applicable)</h4>
            <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
              <SelectField
                label="Association type"
                value={dc.association_type || 'HOA'}
                onChange={(e) => setDC('association_type', e.target.value)}
              >
                <option>HOA</option>
                <option>Condo</option>
                <option>N/A</option>
              </SelectField>
              <InputField
                label="Estoppel fee"
                type="number"
                prefix="$"
                value={dc.estoppel_fee || ''}
                onChange={(e) => setDC('estoppel_fee', e.target.value)}
              />
              <SelectField
                label="Rush estoppel ordered"
                value={dc.rush_estoppel || 'No'}
                onChange={(e) => setDC('rush_estoppel', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
              </SelectField>
              <InputField
                label="Transfer/application fees"
                type="number"
                prefix="$"
                value={dc.transfer_fees || ''}
                onChange={(e) => setDC('transfer_fees', e.target.value)}
              />
              <SelectField
                label="Board approval pre-closing"
                value={dc.board_approval || 'No'}
                onChange={(e) => setDC('board_approval', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
                <option>Unsure</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">H) Carry (if not same-day)</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <InputField
                label="Carry / holding cost"
                type="number"
                prefix="$"
                value={dc.carry_amount || ''}
                onChange={(e) => setDC('carry_amount', e.target.value)}
              />
              <SelectField
                label="Carry basis"
                value={dc.carry_basis || 'day'}
                onChange={(e) => setDC('carry_basis', e.target.value)}
              >
                <option>day</option>
                <option>month</option>
              </SelectField>
              <InputField
                label="Days held (again)"
                type="number"
                value={dc.days_held || ''}
                onChange={(e) => setDC('days_held', e.target.value)}
              />
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">I) Targets & Estimation</h4>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
              <InputField
                label="Minimum acceptable net spread (optional)"
                type="number"
                prefix="$"
                value={dc.min_net_spread || ''}
                onChange={(e) => setDC('min_net_spread', e.target.value)}
              />
              <SelectField
                label="Estimate with FL promulgated rates if missing?"
                value={dc.use_promulgated_estimates || 'No'}
                onChange={(e) => setDC('use_promulgated_estimates', e.target.value)}
              >
                <option>No</option>
                <option>Yes</option>
              </SelectField>
              <SelectField
                label="Assume owner's title payer A-B"
                value={dc.assumed_owner_payer_ab || 'Unknown'}
                onChange={(e) => setDC('assumed_owner_payer_ab', e.target.value)}
              >
                <option>Unknown</option>
                <option>Seller</option>
                <option>You</option>
              </SelectField>
              <SelectField
                label="Assume owner's title payer B-C"
                value={dc.assumed_owner_payer_bc || 'Unknown'}
                onChange={(e) => setDC('assumed_owner_payer_bc', e.target.value)}
              >
                <option>Unknown</option>
                <option>You</option>
                <option>End buyer</option>
              </SelectField>
            </div>
          </GlassCard>
          <GlassCard className="p-5 md:p-6 space-y-3">
            <h4 className="label-xs uppercase">J) Outputs & Apply</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 items-end">
              <ToggleSwitch
                label="Show items 1-13 full math"
                checked={dc.show_items_math === undefined ? true : !!dc.show_items_math}
                onChange={() => setDC('show_items_math', !dc.show_items_math)}
              />
              <ToggleSwitch
                label="Show fee target check"
                checked={dc.show_fee_target === undefined ? true : !!dc.show_fee_target}
                onChange={() => setDC('show_fee_target', !dc.show_fee_target)}
              />
              <ToggleSwitch
                label="Show FHA/VA 90-day flag"
                checked={dc.show_90d_flag === undefined ? true : !!dc.show_90d_flag}
                onChange={() => setDC('show_90d_flag', !dc.show_90d_flag)}
              />
              <ToggleSwitch
                label="Show notes/assumptions"
                checked={dc.show_notes === undefined ? true : !!dc.show_notes}
                onChange={() => setDC('show_notes', !dc.show_notes)}
              />
            </div>
          </GlassCard>
        </>
      )}

      <GlassCard className="p-5 md:p-6 space-y-3">
        <h3 className="text-text-primary font-semibold text-base">Double-Close Results</h3>
        {(dc.show_items_math === undefined || dc.show_items_math) && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div className="info-card space-y-1.5 text-sm">
              <div className="flex justify-between">
                <span>Deed Stamps (A-B)</span>
                <span className="font-semibold">{fmt$(dcCalcs.Deed_Stamps_AB, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Deed Stamps (B-C)</span>
                <span className="font-semibold">{fmt$(dcCalcs.Deed_Stamps_BC, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Title/Settlement A-B</span>
                <span className="font-semibold">{fmt$(dcCalcs.Title_AB, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Title/Settlement B-C</span>
                <span className="font-semibold">{fmt$(dcCalcs.Title_BC, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Other A-B</span>
                <span className="font-semibold">{fmt$(dcCalcs.Other_AB, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Other B-C</span>
                <span className="font-semibold">{fmt$(dcCalcs.Other_BC, 0)}</span>
              </div>
            </div>
            <div className="info-card space-y-1.5 text-sm">
              <div className="flex justify-between">
                <span>TF Points ($)</span>
                <span className="font-semibold">{fmt$(dcCalcs.TF_Points_$, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Doc Stamps on Note</span>
                <span className="font-semibold">{fmt$(dcCalcs.DocStamps_Note, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Intangible Tax</span>
                <span className="font-semibold">{fmt$(dcCalcs.Intangible_Tax, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Carry (daily)</span>
                <span className="font-semibold">{fmt$(dcCalcs.Carry_Daily, 0)}</span>
              </div>
              <div className="flex justify-between">
                <span>Carry (total)</span>
                <span className="font-semibold">{fmt$(dcCalcs.Carry_Total, 0)}</span>
              </div>
            </div>
          </div>
        )}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="highlight-card flex items-center justify-between">
            <span className="font-semibold text-text-secondary">Extra Closing Load</span>
            <span className="text-lg font-extrabold">{fmt$(dcCalcs.Extra_Closing_Load, 0)}</span>
          </div>
          <div className="info-card space-y-1.5 text-sm">
            <div className="flex justify-between">
              <span>Gross Spread (Pbc - Pab)</span>
              <span className="font-semibold">{fmt$(dcCalcs.Gross_Spread, 0)}</span>
            </div>
            <div className="flex justify-between">
              <span>Net Spread (before carry)</span>
              <span className="font-semibold">{fmt$(dcCalcs.Net_Spread_Before_Carry, 0)}</span>
            </div>
            <div className="flex justify-between">
              <span>Net Spread (after carry)</span>
              <span className="font-semibold">{fmt$(dcCalcs.Net_Spread_After_Carry, 0)}</span>
            </div>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {(dc.show_fee_target === undefined || dc.show_fee_target) && (
            <div className="info-card text-sm flex items-center justify-between">
              <div>
                <div className="label-xs">Fee Target ( 3% of ARV)</div>
                <div>
                  Threshold:{' '}
                  <span className="font-semibold">{fmt$(dcCalcs.Fee_Target_Threshold, 0)}</span>
                </div>
              </div>
              <Badge
                color={
                  dcCalcs.Fee_Target_Check === 'YES'
                    ? 'green'
                    : dcCalcs.Fee_Target_Check === 'NO'
                    ? 'orange'
                    : 'blue'
                }
              >
                {dcCalcs.Fee_Target_Check}
              </Badge>
            </div>
          )}
          {(dc.show_90d_flag === undefined || dc.show_90d_flag) && (
            <div className="info-card text-sm flex items-center justify-between">
              <div className="label-xs">FHA/VA 90-Day Seasoning</div>
              <Badge color={dcCalcs.Seasoning_Flag.startsWith('HIGH') ? 'orange' : 'green'}>
                {dcCalcs.Seasoning_Flag}
              </Badge>
            </div>
          )}
        </div>
        {(dc.show_notes === undefined || dc.show_notes) && (
          <div className="info-card text-xs text-text-secondary/80">
            <div className="label-xs mb-1">Notes / Assumptions</div>
            <ul className="list-disc pl-5 space-y-1">
              {dcCalcs.notes.map((n: string, i: number) => (
                <li key={i}>{n}</li>
              ))}
            </ul>
          </div>
        )}
      </GlassCard>
    </div>
  );
};

export default DoubleCloseCalculator;


===== FILE: apps/hps-dealengine/components/repairs/RepairsTab.tsx =====
import React, { useMemo, useState, useCallback } from "react";
import type { RepairRates } from "@hps-internal/contracts";
import type {
  Deal,
  EngineCalculations,
  EstimatorItem,
  EstimatorState,
} from "../../types";
import { fmt$ } from "../../utils/helpers";
import { estimatorSections, Icons } from "../../constants";
import { GlassCard, Button, Icon, SelectField } from "../ui";
import NumericInput from "../ui/NumericInput";
import { InfoTooltip } from "../ui/InfoTooltip";
import { computeSectionTotals, computeQuickEstimateTotal } from "@/lib/repairsMath";

// --- Interfaces ---

interface RepairsTabProps {
  deal: Deal;
  setDealValue: (path: string, value: any) => void;
  calc: EngineCalculations;
  estimatorState: EstimatorState;
  onCostChange: (
    sectionKey: string,
    itemKey: string,
    field: string,
    value: any
  ) => void;
  onQuantityChange: (itemKey: string, value: number | null) => void;
  onReset: () => void;
  repairRates?: RepairRates;
  marketCode?: string;
  activeProfileName?: string;
  posture?: string;
  ratesStatus?: "idle" | "loading" | "loaded" | "error";
  ratesError?: string;
  meta?: {
    profileId?: string | null;
    profileName?: string | null;
    marketCode?: string | null;
    posture?: string | null;
    asOf?: string | null;
    source?: string | null;
    version?: string | null;
  } | null;
  onQuickApply?: () => void;
  onDetailedApply?: () => void;
}

interface EstimatorRowProps {
  itemKey: string;
  item: EstimatorItem;
  value: any;
  quantity: number | null;
  onValueChange: (itemKey: string, field: string, value: any) => void;
  onQuantityChange: (itemKey: string, value: number | null) => void;
}

interface EstimatorSectionProps {
  sectionKey: string;
  section: (typeof estimatorSections)[string];
  // Costs for this specific section only
  costs: EstimatorState["costs"][string] | undefined;
  quantities: EstimatorState["quantities"];
  sectionTotal: number;
  onCostChange: (
    sectionKey: string,
    itemKey: string,
    field: string,
    value: any
  ) => void;
  onQuantityChange: (itemKey: string, value: number | null) => void;
}

// --- Sub-components ---

const RatesMetaBar: React.FC<{
  asOf?: string;
  market?: string;
  posture?: string;
  profileName?: string;
  version?: string;
  status?: "idle" | "loading" | "loaded" | "error";
  error?: string;
}> = ({
  asOf,
  market,
  posture,
  profileName,
  version,
  status = "idle",
  error,
}) => {
  const displayVersion = version
    ? version.startsWith("v")
      ? version
      : `v${version}`
    : "";

  if (status === "loading") {
    return (
      <div className="info-card flex items-center justify-between mb-2 border border-white/5">
        <div className="label-xs">Loading repair unit rates.</div>
        <div className="text-xs text-text-secondary/80">Market {market ?? "ORL"}</div>
      </div>
    );
  }

  return (
    <div className="info-card flex flex-col gap-1 md:flex-row md:items-center md:justify-between mb-2 border border-white/5 px-3 py-2">
      <div className="label-xs">
        Repair unit rates - {market ?? "ORL"} {displayVersion} - posture {posture ?? "base"} - last update:{" "}
        <strong className="text-text-primary/90">{asOf ?? "unknown"}</strong>
        {profileName ? ` - ${profileName}` : ""}
      </div>
      <div className="text-xs text-text-secondary/80">
        {status === "error"
          ? `Rates unavailable${error ? `: ${error}` : ""}`
          : "Sources: policy-backed rate sets (PSF tiers + Big 5)."}
      </div>
    </div>
  );
};

/**
 * QuickEstimate:
 * - reads sqft from both deal *and* calc (multiple likely paths)
 * - uses live PSF tiers + Big 5 $/sqft
 * - writes total into costs.repairs_base when applied
 */
const QuickEstimate: React.FC<{
  deal: Deal;
  calc: EngineCalculations;
  setDealValue: (path: string, value: any) => void;
  psfTiers: RepairRates["psfTiers"];
  big5Rates: RepairRates["big5"];
  onApply?: () => void;
}> = ({ deal, calc, setDealValue, psfTiers, big5Rates, onApply }) => {
  const [rehabLevel, setRehabLevel] = useState<string>("none");
  const [big5, setBig5] = useState<{
    roof: boolean;
    hvac: boolean;
    repipe: boolean;
    electrical: boolean;
    foundation: boolean;
  }>({
    roof: false,
    hvac: false,
    repipe: false,
    electrical: false,
    foundation: false,
  });
  const [hasInteracted, setHasInteracted] = useState(false);
  const hydratedRef = React.useRef(false);
  const persisted = (deal as any)?.repairs?.quickEstimate ?? null;
  const dealIdFromUrl =
    typeof window !== "undefined"
      ? new URLSearchParams(window.location.search).get("dealId")
      : null;
  const storageKey = dealIdFromUrl
    ? `hps-repairs-quick-estimate:${dealIdFromUrl}`
    : null;
  const effectiveRehabLevel = hasInteracted
    ? rehabLevel
    : persisted?.rehabLevel ?? rehabLevel;
  const effectiveBig5 = useMemo(
    () =>
      hasInteracted
        ? { ...(persisted?.big5 ?? {}), ...big5 }
        : { ...big5, ...(persisted?.big5 ?? {}) },
    [big5, hasInteracted, persisted],
  );

  /**
   * ROBUST SQFT RESOLUTION - FIXED VERSION
   * Checks multiple common paths in both calc and deal objects
   */
  const resolveSqft = () => {
    const d = deal as any;
    const c = calc as any;

    // Priority order: calc first (more likely normalized), then deal
    const candidates = [
      // Calc paths (most likely to be standardized)
      c?.subject_sqft,
      c?.subject?.sqft,
      c?.subject?.living_area,
      c?.property?.sqft,
      c?.property?.living_area,
      c?.property?.area,
      c?.sqft,

      // Deal paths (original input data)
      d?.property?.sqft,
      d?.property?.living_area,
      d?.property?.area,
      d?.subject?.sqft,
      d?.subject?.living_area,
      d?.subject?.area,
      d?.cma?.subject?.sqft,
      d?.cma?.subject?.area,
      d?.sqft,
      d?.living_area,
      d?.area,
    ];

    for (const cand of candidates) {
      // Check for valid number
      if (typeof cand === "number" && !isNaN(cand) && cand > 0) {
        return Math.max(0, cand);
      }

      // Check for string that can be parsed
      if (typeof cand === "string" && cand.trim() !== "") {
        const n = Number(cand.replace(/[^\d.]/g, ""));
        if (!isNaN(n) && n > 0) {
          return Math.max(0, n);
        }
      }
    }

    // If we get here, sqft is not found - log warning in development
    if (process.env.NODE_ENV === "development") {
      console.warn(
        " Square footage not found in deal or calc objects.",
        "\nSearched paths:",
        candidates.map((_, i) => `Candidate ${i}`),
        "\nDeal structure:",
        JSON.stringify(deal, null, 2),
        "\nCalc structure:",
        JSON.stringify(calc, null, 2)
      );
    }

    return 0;
  };

  const quickEstimateTotal = useMemo(() => {
    const sqft = resolveSqft();
    return computeQuickEstimateTotal({
      sqft,
      rehabLevel: effectiveRehabLevel as keyof typeof psfTiers,
      big5Selections: effectiveBig5,
      rates: { psfTiers, big5: big5Rates },
    });
  }, [effectiveRehabLevel, effectiveBig5, psfTiers, big5Rates, deal, calc]);

  const toggle = (k: keyof typeof big5, value: boolean) =>
    setBig5((prev) => ({ ...prev, [k]: value }));

  // Hydrate quick estimate selections from saved deal state without triggering apply
  React.useEffect(() => {
    const saved = (deal as any)?.repairs?.quickEstimate;
    if (!saved || hydratedRef.current) return;
    if (saved.rehabLevel) {
      setRehabLevel(saved.rehabLevel);
    }
    if (saved.big5) {
      setBig5((prev) => ({ ...prev, ...saved.big5 }));
    }
    hydratedRef.current = true;
  }, [deal]);

  React.useEffect(() => {
    if (!storageKey || persisted) return;
    try {
      const raw = sessionStorage.getItem(storageKey);
      if (!raw) return;
      const parsed = JSON.parse(raw) as any;
      if (parsed?.rehabLevel) {
        setRehabLevel(parsed.rehabLevel);
      }
      if (parsed?.big5) {
        setBig5((prev) => ({ ...prev, ...parsed.big5 }));
      }
    } catch {
      // ignore storage parse errors
    }
  }, [persisted, storageKey]);

  const applyBudgetWith = React.useCallback(
    (nextRehabLevel: string, nextBig5: typeof big5) => {
      const sqft = resolveSqft();
      const total = computeQuickEstimateTotal({
        sqft,
        rehabLevel: nextRehabLevel as keyof typeof psfTiers,
        big5Selections: nextBig5,
        rates: { psfTiers, big5: big5Rates },
      });
      const snapshot = {
        ...(persisted ?? {}),
        rehabLevel: nextRehabLevel,
        big5: nextBig5,
        sqft,
        total,
      };
      setDealValue("repairs.quickEstimate", snapshot);
      setDealValue("repairs.total", total);
      setDealValue("repairs_total", total);
      setDealValue("repairsTotal", total);
      setDealValue("costs.repairs_base", total);
      setDealValue("costs.repairs", total);
      if (storageKey) {
        try {
          sessionStorage.setItem(storageKey, JSON.stringify(snapshot));
        } catch {
          // ignore storage write errors
        }
      }
      if (onApply) {
        setTimeout(() => {
          onApply();
        }, 0);
      }
    },
    [big5Rates, onApply, persisted, psfTiers, resolveSqft, setDealValue, storageKey],
  );

  const applyBudget = React.useCallback(() => {
    applyBudgetWith(effectiveRehabLevel, effectiveBig5);
  }, [applyBudgetWith, effectiveBig5, effectiveRehabLevel]);

  // Auto-apply when the user has interacted with the calculator
  React.useEffect(() => {
    if (hasInteracted) {
      applyBudget();
    }
  }, [applyBudget, hasInteracted]);

  return (
    <GlassCard className="p-5 md:p-6 space-y-3">
      <h3 className="text-lg font-bold text-text-primary flex items-center gap-2">
        Quick Estimate Calculator
        <InfoTooltip helpKey="quick_estimate" />
      </h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <SelectField
          label="Rehab Level (PSF Tiers)"
          value={effectiveRehabLevel}
          dataTestId="repairs-rehab-level"
          onChange={(e: any) => {
            const nextValue = e.target.value;
            setHasInteracted(true);
            setRehabLevel(nextValue);
            applyBudgetWith(nextValue, effectiveBig5);
          }}
        >
          <option value="none">
            None (${psfTiers?.none ?? 0}/sqft)
          </option>
          <option value="light">
            Light Cosmetic (${psfTiers?.light ?? 0}/sqft)
          </option>
          <option value="medium">
            Medium / Full Rehab (${psfTiers?.medium ?? 0}/sqft)
          </option>
          <option value="heavy">
            Heavy Rehab (${psfTiers?.heavy ?? 0}/sqft)
          </option>
        </SelectField>
        <div>
          <label className="block text-xs font-medium text-text-secondary mb-1 flex items-center gap-1">
            Big 5 Budget Killers
            <InfoTooltip helpKey="big5_repairs" />
          </label>
          <div className="space-y-1">
            {(
              [
                "roof",
                "hvac",
                "repipe",
                "electrical",
                "foundation",
              ] as const
            ).map((item) => (
              <label
                key={item}
                className="flex items-center justify-between text-xs cursor-pointer"
              >
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    className="h-3.5 w-3.5 accent-accent-blue"
                    checked={Boolean(effectiveBig5[item])}
                    data-testid={item === "roof" ? "repairs-big5-roof" : undefined}
                    onChange={() => {
                      const currentValue = Boolean(effectiveBig5[item]);
                      const nextValue = !currentValue;
                      const nextBig5 = { ...effectiveBig5, [item]: nextValue };
                      setHasInteracted(true);
                      toggle(item, nextValue);
                      applyBudgetWith(effectiveRehabLevel, nextBig5);
                    }}
                  />
                  <span className="text-text-primary capitalize">
                    {item}
                  </span>
                </div>
                <span className="text-text-secondary">
                  +${big5Rates?.[item] ?? 0}/sqft
                </span>
              </label>
            ))}
          </div>
        </div>
      </div>
      <div className="highlight-card flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <div className="text-sm text-text-secondary font-bold uppercase">
            Quick Estimate Total
          </div>
          <div className="text-xl font-extrabold">
            {fmt$(quickEstimateTotal, 0)}
          </div>
        </div>
        <Button
          size="sm"
          onClick={() => {
            setHasInteracted(true);
            applyBudget();
          }}
        >
          Use as Repair Budget
        </Button>
      </div>
    </GlassCard>
  );
};

const EstimatorRow: React.FC<EstimatorRowProps> = ({
  itemKey,
  item,
  value,
  quantity,
  onValueChange,
  onQuantityChange,
}) => {
  const currentCondition =
    value?.condition || Object.keys(item.options ?? {})[0];
  const currentCost =
    value?.cost ??
    (item.options && currentCondition in item.options
      ? item.options[currentCondition]
      : 0);
  const currentNotes = value?.notes || "";

  const handleConditionChange = (
    e: React.ChangeEvent<HTMLSelectElement>
  ) => {
    const nextCondition = e.target.value;
    const nextCost =
      item.options && nextCondition in item.options
        ? item.options[nextCondition]
        : currentCost;

    onValueChange(itemKey, "condition", nextCondition);
    onValueChange(itemKey, "cost", nextCost);
  };

  const handleNotesChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    onValueChange(itemKey, "notes", e.target.value);
  };

  const handleQuantityChange = (nextQty: number | null) => {
    onQuantityChange(itemKey, nextQty);
  };

  const handleCostChange = (nextCost: number | null) => {
    const clamped =
      nextCost == null ? null : Math.max(0, nextCost);
    onValueChange(itemKey, "cost", clamped);
  };

  return (
    <tr>
      <td className="p-2">
        <div className="font-medium text-xs text-text-primary">
          {item.label}
        </div>
      </td>
      <td className="p-2">
        {item.options ? (
            <select
              className="input-base w-full"
              value={currentCondition}
              onChange={handleConditionChange}
            >
            {Object.keys(item.options).map((optKey) => (
              <option key={optKey} value={optKey}>
                {optKey}
              </option>
            ))}
          </select>
        ) : (
          <span className="muted text-xs"></span>
        )}
      </td>
      <td className="p-2">
        <input
          type="text"
          value={currentNotes}
          onChange={handleNotesChange}
          placeholder="Specifics..."
          className="input-base"
        />
      </td>
      <td className="p-2">
        <div className="flex items-center justify-end gap-2">
          {item.isPerUnit ? (
            <NumericInput
              value={quantity ?? null}
              onValueChange={handleQuantityChange}
              placeholder="0"
              min={0}
              className="w-16"
            />
          ) : (
            <span className="muted text-right w-full block pr-2">-</span>
          )}
          {item.unitName ? (
            <span className="text-xs muted w-14 text-left">
              {item.unitName}
            </span>
          ) : null}
        </div>
      </td>
      <td className="p-2">
        <div className="relative">
          <span className="absolute inset-y-0 left-0 pl-2 flex items-center text-sm text-text-primary/40">
            $
          </span>
          <NumericInput
            value={currentCost ?? null}
            onValueChange={handleCostChange}
            placeholder={item.isPerUnit ? "Unit $" : "Total $"}
            className="font-semibold"
          />
        </div>
      </td>
    </tr>
  );
};

const EstimatorSection: React.FC<EstimatorSectionProps> = ({
  sectionKey,
  section,
  costs,
  quantities,
  sectionTotal,
  onCostChange,
  onQuantityChange,
}) => {
  return (
    <GlassCard className="p-5 md:p-6">
      <div className="flex items-baseline justify-between mb-4">
        <div>
          <div className="label-sm text-text-primary">
            {section.title}
          </div>
        </div>
        <div className="text-right">
          <div className="label-xs text-text-secondary uppercase">
            Section Total
          </div>
          <div className="font-semibold text-sm text-text-primary">
            {fmt$(sectionTotal, 0)}
          </div>
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr>
              <th className="text-left p-2 label-xs">Item</th>
              <th className="text-left p-2 label-xs w-1/4">
                Condition / Tier
              </th>
              <th className="text-left p-2 label-xs w-1/5">Notes</th>
              <th className="text-right p-2 label-xs w-[120px]">
                Qty
              </th>
              <th className="text-right p-2 label-xs w-1/5">
                Unit Cost
              </th>
            </tr>
          </thead>
          <tbody>
            {Object.keys(section.items).map((itemKey) => (
              <EstimatorRow
                key={itemKey}
                itemKey={itemKey}
                item={section.items[itemKey]}
                value={costs?.[itemKey]}
                quantity={quantities?.[itemKey]}
                onValueChange={(itemKey, field, value) =>
                  onCostChange(sectionKey, itemKey, field, value)
                }
                onQuantityChange={onQuantityChange}
              />
            ))}
          </tbody>
        </table>
      </div>
    </GlassCard>
  );
};

// --- Main Component ---

const RepairsTab: React.FC<RepairsTabProps> = ({
  deal,
  setDealValue,
  calc,
  estimatorState,
  onCostChange,
  onQuantityChange,
  onReset,
  repairRates,
  marketCode,
  activeProfileName,
  posture,
  ratesStatus,
  ratesError,
  meta,
  onQuickApply,
  onDetailedApply,
}) => {
  const { costs, quantities } = estimatorState;
  const effectiveMarket = meta?.marketCode ?? repairRates?.marketCode ?? marketCode;
  const effectivePosture = meta?.posture ?? repairRates?.posture ?? posture;
  const effectiveProfileName =
    meta?.profileName ?? repairRates?.profileName ?? activeProfileName;
  const effectiveAsOf = meta?.asOf ?? repairRates?.asOf ?? "unknown";
  const effectiveVersion = meta?.version ?? repairRates?.version;
  console.log("[RepairsTab] props", {
    meta,
    estimatorState,
    repairRates,
    marketCode,
    posture,
  });

  // Debug: surface which rates are in use for Quick Estimate and Big5 display
  React.useEffect(() => {
    if (process.env.NODE_ENV !== "production") {
      console.debug("[RepairsTab] render rates state", {
        profileId: repairRates?.profileId ?? null,
        profileName: repairRates?.profileName ?? null,
        marketCode: effectiveMarket,
        posture: effectivePosture,
        big5: repairRates?.big5 ?? null,
        usingFallback: !repairRates,
      });
    }
  }, [repairRates, effectivePosture, effectiveMarket]);

  const psfTiers = repairRates?.psfTiers ?? {
    none: 0,
    light: 0,
    medium: 0,
    heavy: 0,
  };
  const big5Rates = repairRates?.big5 ?? {
    roof: 0,
    hvac: 0,
    repipe: 0,
    electrical: 0,
    foundation: 0,
  };

  const { sectionTotals, totalRepairCost } = useMemo(
    () =>
      computeSectionTotals(
        costs,
        quantities,
        (repairRates?.lineItemRates as any) ?? undefined
      ),
    [costs, quantities, repairRates?.lineItemRates]
  );

  const applyDetailedBudget = useCallback(() => {
    const applied = totalRepairCost || 0;
    setDealValue("repairs.total", applied);
    setDealValue("repairs_total", applied);
    setDealValue("repairsTotal", applied);
    setDealValue("costs.repairs_base", applied);
    setDealValue("costs.repairs", applied);
    onDetailedApply?.();
  }, [setDealValue, totalRepairCost, onDetailedApply]);

  return (
    <div className="space-y-4 repairs-scope">
      <RatesMetaBar
        asOf={effectiveAsOf}
        market={effectiveMarket}
        posture={effectivePosture}
        profileName={effectiveProfileName ?? undefined}
        version={effectiveVersion ?? undefined}
        status={ratesStatus}
        error={ratesError}
      />
      <QuickEstimate
        key={repairRates?.profileId ?? "quick-estimate"}
        deal={deal}
        calc={calc}
        setDealValue={setDealValue}
        psfTiers={psfTiers}
        big5Rates={big5Rates}
        onApply={onQuickApply}
      />
      <GlassCard className="p-5 md:p-6 space-y-4">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-lg font-bold text-text-primary flex items-center gap-2">
            <Icon d={Icons.wrench} size={18} className="text-accent-blue" />{" "}
            Detailed Repairs Estimator
          </h2>
          <Button size="sm" variant="ghost" onClick={onReset}>
            Reset Detailed
          </Button>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
          {Object.keys(estimatorSections).map((key) => (
            <div key={key} className="info-card">
              <div className="flex items-center gap-2 label-xs mb-0.5">
                <Icon
                  d={
                    Icons[
                      estimatorSections[key as keyof typeof estimatorSections]
                        .icon as keyof typeof Icons
                    ]
                  }
                  size={14}
                  className="text-accent-blue"
                />
                <span>
                  {estimatorSections[key as keyof typeof estimatorSections]
                    .title}
                </span>
              </div>
              <div className="text-base font-semibold">
                {fmt$(sectionTotals[key] ?? 0, 0)}
              </div>
            </div>
          ))}
          <div className="highlight-card col-span-2 md:col-span-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
              <div className="text-sm text-text-secondary font-bold">
                DETAILED REPAIR SUBTOTAL
              </div>
              <div className="text-xl font-extrabold">
                {fmt$(totalRepairCost, 0)}
              </div>
            </div>
            <Button size="sm" onClick={applyDetailedBudget}>
              Use as Repair Budget
            </Button>
          </div>
        </div>
        <div className="mt-3 text-xs text-text-secondary/80">
          Contingency auto-sets from risk. Final Repairs w/ Contingency:{" "}
          <span className="font-bold text-text-primary">
            {fmt$(calc.repairs_with_contingency, 0)}
          </span>
        </div>
      </GlassCard>
      {Object.keys(estimatorSections).map((sectionKey) => (
        <EstimatorSection
          key={sectionKey}
          sectionKey={sectionKey}
          section={estimatorSections[sectionKey as keyof typeof estimatorSections]}
          costs={estimatorState.costs[sectionKey]}
          quantities={quantities}
          sectionTotal={sectionTotals[sectionKey] ?? 0}
          onCostChange={onCostChange}
          onQuantityChange={onQuantityChange}
        />
      ))}
    </div>
  );
};

export default RepairsTab;


===== FILE: apps/hps-dealengine/app/(app)/repairs/page.tsx =====
// apps/hps-dealengine/app/repairs/page.tsx
"use client";

export const dynamic = "force-dynamic";

import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";
import type { Deal, EngineCalculations, EstimatorState } from "../../../types";
import RepairsTab from "@/components/repairs/RepairsTab";
import { useDealSession } from "@/lib/dealSessionContext";
import { estimatorSections } from "../../../lib/ui-v2-constants";
import type { RepairRates } from "@hps-internal/contracts";
import { createInitialEstimatorState } from "@/lib/repairsEstimator";
import { useUnsavedChanges } from "@/lib/useUnsavedChanges";
import { Button, GlassCard } from "@/components/ui";
import NumericInput from "@/components/ui/NumericInput";
import { Check } from "lucide-react";
import { Tooltip } from "@/components/ui/tooltip";
import { computeSectionTotals } from "@/lib/repairsMath";
import { AutosaveIndicator } from "@/components/shared/AutosaveIndicator";

/**
 * Safely set a nested property on the Deal by a dotted path, e.g. "market.arv".
 */
function setDealPath(prev: Deal, path: string, value: unknown): Deal {
  if (!prev || typeof prev !== "object") return prev;

  const clone: any =
    typeof structuredClone === "function"
      ? structuredClone(prev as any)
      : JSON.parse(JSON.stringify(prev));

  const parts = path.split(".");
  let cursor: any = clone;

  for (let i = 0; i < parts.length - 1; i++) {
    const key = parts[i];
    if (!cursor[key] || typeof cursor[key] !== "object") {
      cursor[key] = {};
    }
    cursor = cursor[key];
  }

  cursor[parts[parts.length - 1]] = value;
  return clone as Deal;
}

/**
 * FIXED: Get current sqft from deal/calc
 */
function getCurrentSqft(deal: Deal, calc: EngineCalculations): number {
  const d = deal as any;
  const c = calc as any;

  const candidates = [
    c?.subject_sqft,
    c?.subject?.sqft,
    c?.property?.sqft,
    d?.property?.sqft,
    d?.subject?.sqft,
    d?.sqft,
  ];

  for (const cand of candidates) {
    if (typeof cand === "number" && !isNaN(cand) && cand > 0) {
      return cand;
    }
    if (typeof cand === "string" && cand.trim() !== "") {
      const n = Number(cand.replace(/[^\d.]/g, ""));
      if (!isNaN(n) && n > 0) {
        return n;
      }
    }
  }
  return 0;
}

function deriveMarketCode(deal: Deal): string {
  const market: any = (deal as any)?.market ?? {};
  return (
    market.market_code ||
    market.market ||
    market.code ||
    market.msa ||
    "ORL"
  );
}

const USD_0 = new Intl.NumberFormat(undefined, {
  style: "currency",
  currency: "USD",
  maximumFractionDigits: 0,
});

const USD_2 = new Intl.NumberFormat(undefined, {
  style: "currency",
  currency: "USD",
  maximumFractionDigits: 2,
});

function fmtUsd0(value: number | null | undefined): string {
  if (value == null) return "";
  return Number.isFinite(value) ? USD_0.format(value) : "";
}

function fmtUsd2(value: number | null | undefined): string {
  if (value == null) return "";
  return Number.isFinite(value) ? USD_2.format(value) : "";
}

function fmtInt(value: number | null | undefined): string {
  if (value == null) return "-";
  return Number.isFinite(value) ? String(Math.round(value)) : "-";
}

export default function RepairsPage() {
  const {
    deal,
    setDeal,
    posture,
    refreshRepairRates,
    activeRepairProfile,
    activeRepairProfileId,
    lastAnalyzeResult,
    repairRates,
    repairRatesLoading,
    repairRatesError,
    dbDeal,
    autosaveStatus,
    saveWorkingStateNow,
  } = useDealSession();
  console.log("[Repairs] render", {
    activeRepairProfileId,
    activeRepairProfileName: activeRepairProfile?.name ?? null,
    repairRates,
  });

  const [estimatorState, setEstimatorState] = useState<EstimatorState>(() =>
    createInitialEstimatorState(),
  );
  const estimatorHydratedKeyRef = useRef<string | null>(null);

  const [localSqft, setLocalSqft] = useState<string>("");
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [sqftSaved, setSqftSaved] = useState(false);

  useUnsavedChanges(hasUnsavedChanges);

  const marketCode = deriveMarketCode(deal as Deal).toUpperCase();
  const rates: RepairRates | null = repairRates ?? null;
  const ratesStatus: "idle" | "loading" | "loaded" | "error" = repairRatesLoading
    ? "loading"
    : repairRatesError
    ? "error"
    : rates
    ? "loaded"
    : "idle";
  const repairMeta = rates
    ? {
        profileId: rates.profileId ?? null,
        profileName: rates.profileName ?? null,
        marketCode: rates.marketCode ?? marketCode,
        posture: rates.posture ?? posture,
        asOf: rates.asOf ?? undefined,
        source: rates.source ?? null,
        version: rates.version ?? undefined,
      }
    : activeRepairProfile
    ? {
        profileId: activeRepairProfile.id ?? null,
        profileName: activeRepairProfile.name ?? null,
        marketCode: activeRepairProfile.marketCode ?? marketCode,
        posture: activeRepairProfile.posture ?? posture,
        asOf: activeRepairProfile.asOf ?? undefined,
        source: activeRepairProfile.source ?? null,
        version: activeRepairProfile.version ?? undefined,
      }
    : null;
  const profileName =
    repairMeta?.profileName ?? activeRepairProfile?.name;

  useEffect(() => {
    if (process.env.NODE_ENV !== "production") {
      console.debug("[RepairsPage] refreshing repair rates", {
        marketCode,
        posture,
        activeRepairProfileId,
      });
    }
    void refreshRepairRates({
      profileId: activeRepairProfileId,
      marketCode,
      posture,
    });
  }, [refreshRepairRates, activeRepairProfileId, marketCode, posture]);

  const calc: EngineCalculations = useMemo(() => {
    const persisted = lastAnalyzeResult as any;
    return {
      ...(persisted?.calculations ?? {}),
      ...(persisted?.outputs ?? {}),
    } as EngineCalculations;
  }, [lastAnalyzeResult]);

  useEffect(() => {
    const currentSqft = getCurrentSqft(deal as Deal, calc);
    if (currentSqft > 0 && !localSqft) {
      setLocalSqft(String(currentSqft));
    }
  }, [deal, calc, localSqft]);

  useEffect(() => {
    const currentProfile = rates?.profileId ?? activeRepairProfileId ?? "default";
    const hydrationKey = `${dbDeal?.id ?? "none"}|${currentProfile}`;
    if (estimatorHydratedKeyRef.current === hydrationKey) return;

    const savedEstimator = (deal as any)?.repairs?.estimatorState;
    const savedProfileId = (deal as any)?.repairs?.estimatorProfileId ?? null;

    if (savedEstimator && savedProfileId === currentProfile) {
      setEstimatorState(savedEstimator as EstimatorState);
    } else {
      setEstimatorState(
        createInitialEstimatorState((rates?.lineItemRates as any) ?? undefined),
      );
    }
    setHasUnsavedChanges(false);
    estimatorHydratedKeyRef.current = hydrationKey;
  }, [
    dbDeal?.id,
    rates?.profileId,
    rates?.marketCode,
    rates?.posture,
    rates?.lineItemRates,
    activeRepairProfileId,
  ]);

  const setDealValue = useCallback(
    (path: string, value: unknown) => {
      setDeal((prev) => setDealPath(prev as Deal, path, value));
      setHasUnsavedChanges(true);
    },
    [setDeal],
  );

  const handleCostChange = useCallback(
    (
      sectionKey: string,
      itemKey: string,
      field: string,
      value: any,
    ) => {
      setEstimatorState((prev) => {
        const next: any =
          typeof structuredClone === "function"
            ? structuredClone(prev as any)
            : JSON.parse(JSON.stringify(prev));

        if (!next.costs) next.costs = {};
        if (!next.costs[sectionKey]) next.costs[sectionKey] = {};

        const item = (next.costs[sectionKey][itemKey] ?? {}) as any;
        item[field] = value;
        next.costs[sectionKey][itemKey] = item;

        return next;
      });
      setHasUnsavedChanges(true);
    },
    [],
  );

  const handleQuantityChange = useCallback((itemKey: string, qty: number | null) => {
    setEstimatorState((prev) => {
      const next: any =
        typeof structuredClone === "function"
          ? structuredClone(prev as any)
          : JSON.parse(JSON.stringify(prev));

      if (!next.quantities) next.quantities = {};
      next.quantities[itemKey] = qty;

      return next;
    });
    setHasUnsavedChanges(true);
  }, []);

  const handleReset = useCallback(() => {
    setEstimatorState(
      createInitialEstimatorState((rates?.lineItemRates as any) ?? undefined),
    );
    setHasUnsavedChanges(false);
  }, [rates?.lineItemRates]);

  const handleSqftSave = () => {
    const sqft = Number(localSqft.replace(/[^\d.]/g, ""));
    if (!isNaN(sqft) && sqft > 0) {
      setDealValue("property.sqft", sqft);
      setHasUnsavedChanges(false);
    }
  };

  const isNoRepairsNeeded = Boolean((deal as any)?.meta?.noRepairsNeeded);

  const handleMarkNoRepairs = useCallback(() => {
    const next = !Boolean((deal as any)?.meta?.noRepairsNeeded);
    setDealValue("meta.noRepairsNeeded", next);
    if (next) {
      setDealValue("repairs.total", 0);
      setDealValue("repairs_total", 0);
      setDealValue("repairsTotal", 0);
      setDealValue("quickEstimate.total", 0);
    }
    setEstimatorState((prev) => {
      const next: any =
        typeof structuredClone === "function"
          ? structuredClone(prev as any)
          : JSON.parse(JSON.stringify(prev));
      if (next) {
        next.costs = {};
        next.quantities = {};
      }
      return next;
    });
    setHasUnsavedChanges(true);
  }, [deal, setDealValue]);

  const effectiveSqft = getCurrentSqft(deal as Deal, calc) || Number(localSqft) || 0;
  const handleSqftChange = useCallback(
    (value: number | null) => {
      const nextText = value == null ? "" : String(value);
      setLocalSqft(nextText);
      if (value != null && Number.isFinite(value) && value > 0) {
        setDealValue("property.sqft", value);
        setHasUnsavedChanges(false);
        setSqftSaved(true);
      } else {
        setHasUnsavedChanges(true);
        setSqftSaved(false);
      }
    },
    [setDealValue],
  );

  const sqftInputValue = useMemo(() => {
    if (!localSqft || localSqft.trim() === "") return null;
    const parsed = Number(localSqft.replace(/[^\d.]/g, ""));
    return Number.isFinite(parsed) ? parsed : null;
  }, [localSqft]);

  const quickEstimateApplied = (deal as any)?.repairs?.quickEstimate?.total ?? null;

  const { sectionTotals, totalRepairCost } = useMemo(
    () =>
      computeSectionTotals(
        estimatorState.costs,
        estimatorState.quantities,
        (rates?.lineItemRates as any) ?? undefined,
      ),
    [estimatorState, rates?.lineItemRates],
  );

  useEffect(() => {
    const profileIdToPersist = rates?.profileId ?? activeRepairProfileId ?? null;
    const appliedTotal =
      totalRepairCost > 0
        ? totalRepairCost
        : quickEstimateApplied != null
        ? Number(quickEstimateApplied)
        : 0;

    const currentApplied = (deal as any)?.costs?.repairs_base ?? null;
    const savedEstimator = (deal as any)?.repairs?.estimatorState;
    const savedProfileId = (deal as any)?.repairs?.estimatorProfileId ?? null;

    const estimatorChanged =
      JSON.stringify(savedEstimator ?? {}) !==
      JSON.stringify(estimatorState ?? {});
    const shouldUpdateTotals = currentApplied !== appliedTotal;
    const shouldUpdateProfile = savedProfileId !== profileIdToPersist;

    if (!(shouldUpdateTotals || estimatorChanged || shouldUpdateProfile)) {
      return;
    }

    setDealValue("repairs.estimatorState", estimatorState);
    setDealValue("repairs.estimatorProfileId", profileIdToPersist);
    setDealValue("repairs.total", appliedTotal);
    setDealValue("repairs_total", appliedTotal);
    setDealValue("repairsTotal", appliedTotal);
    setDealValue("costs.repairs_base", appliedTotal);
    setDealValue("costs.repairs", appliedTotal);
  }, [
    estimatorState,
    totalRepairCost,
    quickEstimateApplied,
    rates?.profileId,
    activeRepairProfileId,
    setDealValue,
    deal,
  ]);
const resolvedSqft = useMemo(() => {
  const base = getCurrentSqft(deal as Deal, calc);
  if (base > 0) return base;
  const n = Number(String(localSqft ?? "").replace(/[^\d.]/g, ""));
  return Number.isFinite(n) && n > 0 ? n : 0;
}, [deal, calc, localSqft]);

const appliedTotal = useMemo(() => {
  if (isNoRepairsNeeded) return 0;
  if (totalRepairCost > 0) return totalRepairCost;
  if (quickEstimateApplied != null) {
    const n = Number(quickEstimateApplied);
    return Number.isFinite(n) ? n : 0;
  }
  return 0;
}, [isNoRepairsNeeded, totalRepairCost, quickEstimateApplied]);

const repairsPerSqft = useMemo(() => {
  if (!resolvedSqft || resolvedSqft <= 0) return null;
  if (!appliedTotal || appliedTotal <= 0) return null;
  return appliedTotal / resolvedSqft;
}, [appliedTotal, resolvedSqft]);

const sectionBreakdown = useMemo(() => {
  const entries = Object.entries(sectionTotals)
    .map(([key, total]) => ({ key, total }))
    .filter((row) => Number.isFinite(row.total) && row.total > 0.5)
    .sort((a, b) => b.total - a.total);

  return entries;
}, [sectionTotals]);


  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-center gap-2">
          <h1 className="text-2xl font-semibold tracking-tight text-white">
            Repairs
          </h1>
          <Tooltip
            content="Quick PSF tiers, Big 5 budget killers, and a detailed line-item estimator, all wired to the same deal session as Underwrite."
            side="top"
            align="start"
          >
            <button
              type="button"
              aria-label="Repairs info"
              className="inline-flex h-4 w-4 items-center justify-center rounded-full border border-white/15 bg-white/10 text-[10px] font-semibold text-text-secondary transition hover:border-white/25 hover:text-text-primary focus:outline-none focus:ring-2 focus:ring-accent-blue/60"
            >
              i
            </button>
          </Tooltip>
        </div>
        <div className="flex flex-col items-end gap-1">
          <AutosaveIndicator
            state={autosaveStatus.state}
            lastSavedAt={autosaveStatus.lastSavedAt}
            error={autosaveStatus.error}
          />
          <Button
            variant={isNoRepairsNeeded ? "primary" : "neutral"}
            size="sm"
            className="mt-1 flex items-center gap-2"
            onClick={handleMarkNoRepairs}
          >
            {isNoRepairsNeeded && <Check size={14} />}
            No Repairs Needed
          </Button>
          {isNoRepairsNeeded && (
            <span className="text-[12px] text-emerald-200">Repairs are set to $0</span>
          )}
        </div>
      </div>


<div className="space-y-6 lg:grid lg:grid-cols-12 lg:gap-6 lg:space-y-0">
  {/* Left rail (desktop): meta + key inputs/totals. Mobile/tablet remains unchanged. */}
  <div className="lg:col-span-3">
    <div className="space-y-6 lg:sticky lg:top-24">
      <GlassCard className="p-4">
        <div className="flex items-center gap-3 lg:flex-col lg:items-start lg:gap-2">
          <label className="flex items-center gap-2 text-sm font-medium text-white">
            <span>Property Square Footage</span>
            <Tooltip
              content="Square footage is required for Quick Estimate calculator. Please enter it above."
              side="top"
              align="start"
            >
              <button
                type="button"
                aria-label="Square footage info"
                className="inline-flex h-4 w-4 items-center justify-center rounded-full border border-white/15 bg-white/10 text-[10px] font-semibold text-text-secondary transition hover:border-white/25 hover:text-text-primary focus:outline-none focus:ring-2 focus:ring-accent-blue/60"
              >
                i
              </button>
            </Tooltip>
            {sqftSaved && (
              <Check
                size={14}
                className="text-emerald-400"
                aria-hidden="true"
              />
            )}
          </label>
          <NumericInput
            value={sqftInputValue}
            onValueChange={handleSqftChange}
            placeholder="Enter sqft"
            className="w-32"
            style={{ borderColor: "var(--accent-color)" }}
          />
        </div>

        <div className="mt-3 hidden lg:grid lg:grid-cols-2 lg:gap-3">
          <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
            <div className="text-[11px] uppercase tracking-wide text-text-secondary">
              Applied total
            </div>
            <div className="mt-0.5 text-sm font-semibold text-text-primary">
              {fmtUsd0(appliedTotal)}
            </div>
          </div>
          <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
            <div className="text-[11px] uppercase tracking-wide text-text-secondary">
              $ / sqft
            </div>
            <div className="mt-0.5 text-sm font-semibold text-text-primary">
              {repairsPerSqft != null ? fmtUsd2(repairsPerSqft) : ""}
            </div>
          </div>
        </div>
      </GlassCard>

      {/* Desktop-only: keep the rail intentional + information-dense */}
      <div className="hidden lg:block space-y-6">
        <GlassCard className="p-4">
          <div className="flex items-start justify-between gap-3">
            <div className="min-w-0">
              <div className="text-xs uppercase text-text-secondary">
                Rate profile
              </div>
              <div className="mt-1 truncate text-sm font-semibold text-text-primary">
                {profileName ?? "Repair rates"}
              </div>
              <div className="mt-1 text-xs text-text-secondary">
                {(repairMeta?.marketCode ?? marketCode).toUpperCase()}  posture{" "}
                {(repairMeta?.posture ?? posture) || "base"}
              </div>
            </div>
            <span
              className={`shrink-0 rounded-full border px-2 py-0.5 text-[11px] font-semibold ${
                ratesStatus === "loaded"
                  ? "border-emerald-400/30 bg-emerald-400/10 text-emerald-200"
                  : ratesStatus === "loading"
                  ? "border-white/15 bg-white/5 text-text-secondary"
                  : ratesStatus === "error"
                  ? "border-red-400/30 bg-red-400/10 text-red-200"
                  : "border-white/15 bg-white/5 text-text-secondary"
              }`}
            >
              {ratesStatus === "loaded"
                ? "Rates loaded"
                : ratesStatus === "loading"
                ? "Loading"
                : ratesStatus === "error"
                ? "Rates error"
                : "Rates idle"}
            </span>
          </div>

          <div className="mt-3 grid grid-cols-2 gap-3">
            <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <div className="text-[11px] uppercase tracking-wide text-text-secondary">
                As of
              </div>
              <div className="mt-0.5 text-xs text-text-primary">
                {repairMeta?.asOf ?? ""}
              </div>
            </div>
            <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <div className="text-[11px] uppercase tracking-wide text-text-secondary">
                Source
              </div>
              <div className="mt-0.5 truncate text-xs text-text-primary">
                {repairMeta?.source ?? ""}
              </div>
            </div>
          </div>

          {repairRatesError && (
            <div className="mt-3 rounded-lg border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200">
              {repairRatesError}
            </div>
          )}
        </GlassCard>

        <GlassCard className="p-4">
          <div className="flex items-start justify-between gap-3">
            <div>
              <div className="text-xs uppercase text-text-secondary">
                Key totals
              </div>
              <div className="mt-1 text-lg font-semibold text-text-primary">
                {fmtUsd0(appliedTotal)}
              </div>
              <div className="mt-0.5 text-xs text-text-secondary">
                Detailed estimator: {fmtUsd0(totalRepairCost)}
                {quickEstimateApplied != null && totalRepairCost === 0
                  ? `  Quick estimate: ${fmtUsd0(
                      Number(quickEstimateApplied),
                    )}`
                  : ""}
              </div>
            </div>
            <div className="text-right">
              <div className="text-xs uppercase text-text-secondary">
                Sqft
              </div>
              <div className="mt-1 text-sm font-semibold text-text-primary">
                {resolvedSqft > 0 ? fmtInt(resolvedSqft) : ""}
              </div>
            </div>
          </div>

          <div className="mt-3 grid grid-cols-2 gap-3">
            <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <div className="text-[11px] uppercase tracking-wide text-text-secondary">
                Sections
              </div>
              <div className="mt-0.5 text-xs text-text-primary">
                {sectionBreakdown.length}
              </div>
            </div>
            <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <div className="text-[11px] uppercase tracking-wide text-text-secondary">
                Status
              </div>
              <div className="mt-0.5 text-xs text-text-primary">
                {isNoRepairsNeeded ? "No repairs needed" : "Estimator active"}
              </div>
            </div>
          </div>
        </GlassCard>
      </div>
    </div>
  </div>

  {/* Center rail: primary repairs workflow */}
  <div className="lg:col-span-6 xl:col-span-7">
    <RepairsTab
      key={rates?.profileId ?? "repairs-tab"}
      deal={deal as Deal}
      setDealValue={setDealValue}
      calc={calc}
      estimatorState={estimatorState}
      onCostChange={handleCostChange}
      onQuantityChange={handleQuantityChange}
      onReset={handleReset}
      repairRates={rates ?? undefined}
      marketCode={repairMeta?.marketCode ?? marketCode}
      activeProfileName={
        repairMeta?.profileName ?? activeRepairProfile?.name ?? undefined
      }
      posture={repairMeta?.posture ?? posture}
      ratesStatus={ratesStatus}
      ratesError={repairRatesError ?? undefined}
      meta={repairMeta ?? undefined}
      onQuickApply={() => {
        void saveWorkingStateNow().catch(() => {
          /* status indicator handles error */
        });
      }}
      onDetailedApply={() => {
        void saveWorkingStateNow().catch(() => {
          /* status indicator handles error */
        });
      }}
    />
  </div>

  {/* Right rail (desktop): breakdown + alerts */}
  <div className="hidden lg:block lg:col-span-3 xl:col-span-2">
    <div className="space-y-6 lg:sticky lg:top-24">
      <GlassCard className="p-4">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="text-xs uppercase text-text-secondary">
              Breakdown
            </div>
            <div className="mt-1 text-sm font-semibold text-text-primary">
              By section
            </div>
          </div>
          <div className="text-right">
            <div className="text-xs uppercase text-text-secondary">
              Total
            </div>
            <div className="mt-1 text-sm font-semibold text-text-primary">
              {fmtUsd0(totalRepairCost)}
            </div>
          </div>
        </div>

        <div className="mt-4 space-y-3">
          {sectionBreakdown.length === 0 && (
            <div className="text-xs text-text-secondary">
              No detailed line items yet. Use Quick Estimate or add costs to see a breakdown.
            </div>
          )}

          {sectionBreakdown.slice(0, 8).map((row) => {
            const section = (estimatorSections as Record<string, { title?: string; label?: string }>)[row.key];
            const label =
              section?.title ??
              section?.label ??
              row.key.replace(/_/g, " ");
            const pct =
              totalRepairCost > 0
                ? Math.min(100, (row.total / totalRepairCost) * 100)
                : 0;

            return (
              <div key={row.key} className="space-y-1">
                <div className="flex items-center justify-between gap-3 text-xs">
                  <span className="truncate text-text-secondary">
                    {label}
                  </span>
                  <span className="shrink-0 font-medium text-text-primary">
                    {fmtUsd0(row.total)}
                  </span>
                </div>
                <div className="h-1.5 w-full overflow-hidden rounded-full bg-white/10">
                  <div
                    className="h-full rounded-full bg-accent-blue/60"
                    style={{ width: `${pct}%` }}
                    aria-hidden="true"
                  />
                </div>
              </div>
            );
          })}
        </div>
      </GlassCard>

      <GlassCard className="p-4">
        <div className="text-xs uppercase text-text-secondary">
          Alerts & sanity checks
        </div>
        <div className="mt-3 space-y-3 text-xs">
          {resolvedSqft <= 0 && (
            <div className="rounded-lg border border-amber-400/30 bg-amber-400/10 px-3 py-2 text-amber-200">
              Add square footage to unlock accurate Quick Estimate PSF math.
            </div>
          )}
          {ratesStatus === "error" && (
            <div className="rounded-lg border border-red-400/30 bg-red-400/10 px-3 py-2 text-red-200">
              Repair unit rates failed to load. You can still enter custom costs.
            </div>
          )}
          {isNoRepairsNeeded && (
            <div className="rounded-lg border border-emerald-400/30 bg-emerald-400/10 px-3 py-2 text-emerald-200">
              Repairs are marked as $0. Toggle off if you need line items.
            </div>
          )}
          {!isNoRepairsNeeded && appliedTotal === 0 && (
            <div className="rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-text-secondary">
              Start with Quick Estimate (PSF tiers + Big 5) or add line items to compute totals.
            </div>
          )}
        </div>
      </GlassCard>
    </div>
  </div>
</div>
    </div>
  );
}


===== FILE: scripts/seed-qa.ts =====
import { createClient, type SupabaseClient } from "@supabase/supabase-js";
import { execSync } from "node:child_process";
import crypto from "node:crypto";
import fs from "node:fs";
import path from "node:path";

type EnvMap = Record<string, string>;

type DealSeed = {
  id: string;
  name: string;
  address: string;
  city: string;
  state: string;
  zip: string;
  contactName: string;
  county?: string;
  occupancy?: string;
};

type RunSeed = {
  id: string;
  dealId: string;
  posture: string;
  input: Record<string, unknown>;
  output: Record<string, unknown>;
  trace: Record<string, unknown>[];
};

const ORG_ID = "ed6ae332-2d15-44be-a8fb-36005522ad60";
const ORG_NAME = "QA Org (ed6a)";

const QA_EMAIL = "qa@hps.test.local";
const QA_PASSWORD = "QaTest!2025";
const QA_POSTURE = "base";
const QA_READY_CLIENT_NAME = "QA Ready Client";
const QA_VALUATION_CLIENT_NAME = "QA Valuation Client";

const READY_DEAL_ID = "11111111-1111-4111-8111-111111111111";
const VALUATION_DEAL_ID = "66666666-6666-4666-8666-666666666666";
const TIMELINE_DEAL_ID = "22222222-2222-4222-8222-222222222222";
const STALE_DEAL_ID = "33333333-3333-4333-8333-333333333333";
const HARD_GATE_DEAL_ID = "44444444-4444-4444-8444-444444444444";

const TIMELINE_DTM_DAYS = 42;
const TIMELINE_CARRY_MONTHS = 3;
const TIMELINE_SPEED_BAND = "balanced";

function parseStatusEnv(): EnvMap {
  const raw = execSync("supabase status -o env", { encoding: "utf8" });
  const env: EnvMap = {};
  raw
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line && !line.startsWith("#"))
    .forEach((line) => {
      const normalized = line.replace(/^export\s+/, "");
      const [key, ...rest] = normalized.split("=");
      if (key && rest.length > 0) {
        const rawVal = rest.join("=").trim();
        env[key.trim()] = rawVal.replace(/^"+|"+$/g, "");
      }
    });
  // Normalize common aliases from supabase CLI output
  if (!env.SUPABASE_URL && env.API_URL) env.SUPABASE_URL = env.API_URL;
  if (!env.SUPABASE_ANON_KEY && env.ANON_KEY) env.SUPABASE_ANON_KEY = env.ANON_KEY;
  if (!env.SUPABASE_SERVICE_ROLE_KEY && env.SERVICE_ROLE_KEY) {
    env.SUPABASE_SERVICE_ROLE_KEY = env.SERVICE_ROLE_KEY;
  }
  return env;
}

function hashJson(value: unknown): string {
  return crypto.createHash("sha256").update(JSON.stringify(value)).digest("hex");
}

async function findUserId(
  client: SupabaseClient,
  email: string,
): Promise<string | null> {
  let page = 1;
  const perPage = 100;

  // listUsers pagination is cheap locally; stop once no results remain
  // eslint-disable-next-line no-constant-condition
  while (true) {
    const { data, error } = await client.auth.admin.listUsers({ page, perPage });
    if (error) throw error;
    const match =
      data?.users?.find(
        (u) => u.email?.toLowerCase() === email.toLowerCase(),
      ) ?? null;
    if (match) return match.id;
    if (!data?.users || data.users.length < perPage) break;
    page += 1;
  }
  return null;
}

async function ensureUser(
  client: SupabaseClient,
  email: string,
  password: string,
): Promise<string> {
  const existingId = await findUserId(client, email);
  if (existingId) return existingId;

  const { data, error } = await client.auth.admin.createUser({
    email,
    password,
    email_confirm: true,
  });
  if (error || !data?.user?.id) {
    throw error ?? new Error("Failed to create QA user");
  }
  return data.user.id;
}

async function ensureOrg(client: SupabaseClient): Promise<void> {
  const { error } = await client
    .from("organizations")
    .upsert({ id: ORG_ID, name: ORG_NAME }, { onConflict: "id" });
  if (error) {
    throw error;
  }
}

async function ensureMembership(
  client: SupabaseClient,
  userId: string,
): Promise<void> {
  const { error } = await client
    .from("memberships")
    .upsert(
      { org_id: ORG_ID, user_id: userId, role: "owner" },
      { onConflict: "org_id,user_id" },
    );
  if (error) {
    throw error;
  }
}

function buildDeals(): DealSeed[] {
  return [
    {
      id: READY_DEAL_ID,
      name: QA_READY_CLIENT_NAME,
      address: "123 Ready St",
      city: "Orlando",
      state: "FL",
      zip: "32801",
      contactName: QA_READY_CLIENT_NAME,
      county: "Orange",
      occupancy: "tenant",
    },
    {
      id: VALUATION_DEAL_ID,
      name: "QA Valuation Deal",
      address: "654 Valuation Ave",
      city: "Orlando",
      state: "FL",
      zip: "32805",
      contactName: QA_VALUATION_CLIENT_NAME,
      county: "Orange",
      occupancy: "owner",
    },
    {
      id: TIMELINE_DEAL_ID,
      name: "QA Timeline Deal",
      address: "456 Timeline Ave",
      city: "Orlando",
      state: "FL",
      zip: "32802",
      contactName: "Timeline Client",
      county: "Orange",
      occupancy: "vacant",
    },
    {
      id: STALE_DEAL_ID,
      name: "QA Stale Evidence Deal",
      address: "789 Evidence Rd",
      city: "Orlando",
      state: "FL",
      zip: "32803",
      contactName: "Evidence Client",
      county: "Orange",
      occupancy: "vacant",
    },
    {
      id: HARD_GATE_DEAL_ID,
      name: "QA Hard Gate Deal",
      address: "321 Gate Ln",
      city: "Orlando",
      state: "FL",
      zip: "32804",
      contactName: "Gate Client",
      county: "Orange",
      occupancy: "owner",
    },
  ];
}

function buildTraceFrames(params: {
  evidence: Record<string, unknown>;
  risk: Record<string, unknown>;
  confidence: Record<string, unknown>;
  workflow: Record<string, unknown>;
  marketProvenance?: Record<string, unknown>;
}): Record<string, unknown>[] {
  const frame = (key: string, label: string, details: Record<string, unknown>) => ({
    key,
    rule: key,
    label,
    details,
  });

  return [
    frame("EVIDENCE_FRESHNESS_POLICY", "Evidence Freshness Policy", params.evidence),
    frame("RISK_GATES_POLICY", "Risk Gates Policy", params.risk),
    frame("CONFIDENCE_POLICY", "Confidence Policy", params.confidence),
    frame("WORKFLOW_STATE_POLICY", "Workflow State Policy", params.workflow),
    frame("MARKET_PROVENANCE", "Market Provenance", params.marketProvenance ?? {}),
  ];
}

function buildRuns(): RunSeed[] {
  const commonInput = (dealId: string) => ({
    dealId,
    posture: QA_POSTURE,
    deal: { market: { arv: 320000, aiv: 300000, dom_zip_days: 30 } },
    sandbox: {},
    repairProfile: null,
    meta: {},
  });

  const readyEvidenceFreshness = {
    freshness_by_kind: {
      payoff_letter: { status: "fresh", age_days: 5, blocking_for_ready: false },
      title_quote: { status: "fresh", age_days: 2, blocking_for_ready: false },
      comps: { status: "fresh", age_days: 7, blocking_for_ready: false },
    },
    allow_placeholders_when_evidence_missing: false,
    placeholders_used: false,
    placeholder_kinds: [],
  };

  const staleEvidenceFreshness = {
    freshness_by_kind: {
      payoff_letter: { status: "missing", age_days: null, blocking_for_ready: true },
      title_quote: { status: "stale", age_days: 120, blocking_for_ready: true },
      comps: { status: "stale", age_days: 90, blocking_for_ready: false },
    },
    allow_placeholders_when_evidence_missing: true,
    placeholders_used: true,
    placeholder_kinds: ["payoff_letter"],
  };

  const readyRun: RunSeed = {
    id: "55555555-1111-4111-8111-111111111111",
    dealId: READY_DEAL_ID,
    posture: QA_POSTURE,
    input: commonInput(READY_DEAL_ID),
    output: {
      outputs: {
        primary_offer: 215000,
        instant_cash_offer: 210000,
        timeline_summary: {
          days_to_money: 30,
          carry_months: 2,
          carry_months_raw: 2,
          speed_band: TIMELINE_SPEED_BAND,
          urgency: "normal",
          hold_monthly_dollars: 3000,
          carry_total_dollars: 6000,
          dtm_selected_days: 30,
          dom_zip_days: 30,
          carry_months_capped: 2,
        },
        risk_summary: {
          overall: "pass",
          per_gate: {
            insurability: { status: "pass" },
            payoff: { status: "pass" },
          },
          reasons: ["All gates passing"],
        },
        evidence_summary: {
          confidence_grade: "A",
          confidence_reasons: ["All evidence fresh"],
          freshness_by_kind: readyEvidenceFreshness.freshness_by_kind,
        },
        workflow_state: "ReadyForOffer",
        workflow_reasons: ["Evidence complete", "Risk gates passing"],
        confidence_grade: "A",
        confidence_reasons: ["Policy confidence A"],
      },
    },
    trace: buildTraceFrames({
      evidence: readyEvidenceFreshness,
      risk: {
        per_gate: {
          insurability: { status: "pass", enabled: true, reasons: [] },
          payoff: { status: "pass", enabled: true, reasons: [] },
        },
      },
      confidence: {
        grade: "A",
        reasons: ["Evidence fresh"],
        rubric_raw: '{"A":"excellent","B":"strong"}',
      },
        workflow: {
          workflow_state: "ReadyForOffer",
          reasons: ["All signals green"],
          allow_placeholders_when_evidence_missing: false,
          placeholders_used: false,
        },
        marketProvenance: commonInput(READY_DEAL_ID).deal?.market as Record<string, unknown>,
      }),
  };

  const valuationRun: RunSeed = {
    id: "55555555-6666-4666-8666-666666666666",
    dealId: VALUATION_DEAL_ID,
    posture: QA_POSTURE,
    input: commonInput(VALUATION_DEAL_ID),
    output: {
      outputs: {
        primary_offer: 212000,
        instant_cash_offer: 208000,
        timeline_summary: {
          days_to_money: 32,
          carry_months: 2,
          carry_months_raw: 2,
          speed_band: TIMELINE_SPEED_BAND,
          urgency: "normal",
          hold_monthly_dollars: 2900,
          carry_total_dollars: 5800,
          dtm_selected_days: 32,
          dom_zip_days: 32,
          carry_months_capped: 2,
        },
        risk_summary: {
          overall: "pass",
          per_gate: {
            insurability: { status: "pass" },
            payoff: { status: "pass" },
          },
          reasons: ["All gates passing"],
        },
        evidence_summary: {
          confidence_grade: "A",
          confidence_reasons: ["All evidence fresh"],
          freshness_by_kind: readyEvidenceFreshness.freshness_by_kind,
        },
        workflow_state: "ReadyForOffer",
        workflow_reasons: ["Evidence complete", "Risk gates passing"],
        confidence_grade: "A",
        confidence_reasons: ["Policy confidence A"],
      },
    },
    trace: buildTraceFrames({
      evidence: readyEvidenceFreshness,
      risk: {
        per_gate: {
          insurability: { status: "pass", enabled: true, reasons: [] },
          payoff: { status: "pass", enabled: true, reasons: [] },
        },
      },
      confidence: {
        grade: "A",
        reasons: ["Evidence fresh"],
        rubric_raw: '{"A":"excellent","B":"strong"}',
      },
      workflow: {
        workflow_state: "ReadyForOffer",
        reasons: ["All signals green"],
        allow_placeholders_when_evidence_missing: false,
        placeholders_used: false,
      },
      marketProvenance: commonInput(VALUATION_DEAL_ID).deal?.market as Record<string, unknown>,
    }),
  };

  const timelineRun: RunSeed = {
    id: "55555555-2222-4222-8222-222222222222",
    dealId: TIMELINE_DEAL_ID,
    posture: QA_POSTURE,
    input: commonInput(TIMELINE_DEAL_ID),
    output: {
      outputs: {
        primary_offer: 205000,
        timeline_summary: {
          days_to_money: TIMELINE_DTM_DAYS,
          dtm_selected_days: TIMELINE_DTM_DAYS,
          carry_months: TIMELINE_CARRY_MONTHS,
          carry_months_raw: TIMELINE_CARRY_MONTHS,
          carry_months_capped: TIMELINE_CARRY_MONTHS,
          speed_band: TIMELINE_SPEED_BAND,
          urgency: "standard",
          hold_monthly_dollars: 2500,
          carry_total_dollars: TIMELINE_CARRY_MONTHS * 2500,
          dom_zip_days: 45,
        },
        risk_summary: {
          overall: "pass",
          per_gate: { insurability: { status: "pass" } },
          reasons: [],
        },
        evidence_summary: {
          confidence_grade: "B",
          freshness_by_kind: readyEvidenceFreshness.freshness_by_kind,
        },
        workflow_state: "ReadyForOffer",
        workflow_reasons: ["Timeline seeded"],
        confidence_grade: "B",
        confidence_reasons: ["Timeline QA run"],
      },
    },
    trace: buildTraceFrames({
      evidence: readyEvidenceFreshness,
      risk: { per_gate: { insurability: { status: "pass", enabled: true } } },
      confidence: { grade: "B", reasons: ["Timeline QA run"] },
      workflow: {
        workflow_state: "ReadyForOffer",
        reasons: ["Timeline QA run"],
        allow_placeholders_when_evidence_missing: false,
        placeholders_used: false,
      },
    }),
  };

  const staleRun: RunSeed = {
    id: "55555555-3333-4333-8333-333333333333",
    dealId: STALE_DEAL_ID,
    posture: QA_POSTURE,
    input: commonInput(STALE_DEAL_ID),
    output: {
      outputs: {
        primary_offer: 180000,
        risk_summary: {
          overall: "watch",
          per_gate: {
            insurability: { status: "watch", reasons: ["Title quote stale"] },
            payoff: { status: "watch", reasons: ["Payoff letter missing"] },
          },
          reasons: ["Evidence stale or missing"],
        },
        evidence_summary: {
          confidence_grade: "B",
          confidence_reasons: ["Stale evidence present"],
          freshness_by_kind: staleEvidenceFreshness.freshness_by_kind,
        },
        workflow_state: "NeedsReview",
        workflow_reasons: ["Evidence stale or missing"],
        confidence_grade: "B",
        confidence_reasons: ["Stale evidence"],
      },
    },
    trace: buildTraceFrames({
      evidence: staleEvidenceFreshness,
      risk: {
        per_gate: {
          insurability: { status: "watch", enabled: true, reasons: ["Title quote stale"] },
          payoff: { status: "watch", enabled: true, reasons: ["Payoff letter missing"] },
        },
        reasons: ["Evidence stale or missing"],
      },
      confidence: {
        grade: "B",
        reasons: ["Stale evidence"],
      },
      workflow: {
        workflow_state: "NeedsReview",
        reasons: ["Evidence stale or missing"],
        allow_placeholders_when_evidence_missing: true,
        placeholders_used: true,
        placeholder_kinds: ["payoff_letter"],
      },
    }),
  };

  const hardGateRun: RunSeed = {
    id: "55555555-4444-4444-8444-444444444444",
    dealId: HARD_GATE_DEAL_ID,
    posture: QA_POSTURE,
    input: commonInput(HARD_GATE_DEAL_ID),
    output: {
      outputs: {
        primary_offer: 165000,
        risk_summary: {
          overall: "fail",
          per_gate: {
            insurability: {
              status: "fail",
              reasons: ["Flood zone high risk"],
              enabled: true,
            },
            payoff: { status: "watch", reasons: ["Pending payoff clarification"], enabled: true },
          },
          reasons: ["Insurability gate failed"],
        },
        evidence_summary: {
          confidence_grade: "C",
          confidence_reasons: ["Hard gate failure"],
          freshness_by_kind: {
            payoff_letter: { status: "fresh", age_days: 10, blocking_for_ready: false },
            insurance: { status: "fresh", age_days: 5, blocking_for_ready: false },
          },
        },
        workflow_state: "NeedsReview",
        workflow_reasons: ["Risk gates failing"],
        confidence_grade: "C",
        confidence_reasons: ["Hard gate failure"],
      },
    },
    trace: buildTraceFrames({
      evidence: {
        freshness_by_kind: {
          payoff_letter: { status: "fresh", age_days: 10, blocking_for_ready: false },
          insurance: { status: "fresh", age_days: 5, blocking_for_ready: false },
        },
        allow_placeholders_when_evidence_missing: false,
        placeholders_used: false,
      },
      risk: {
        per_gate: {
          insurability: { status: "fail", enabled: true, reasons: ["Flood zone high risk"] },
          payoff: { status: "watch", enabled: true, reasons: ["Pending payoff clarification"] },
        },
        reasons: ["Insurability gate failed"],
      },
      confidence: { grade: "C", reasons: ["Hard gate failure"] },
      workflow: {
        workflow_state: "NeedsReview",
        reasons: ["Risk gates failing"],
        allow_placeholders_when_evidence_missing: false,
        placeholders_used: false,
      },
    }),
  };

  return [readyRun, valuationRun, timelineRun, staleRun, hardGateRun];
}

async function upsertDeals(
  client: SupabaseClient,
  deals: DealSeed[],
  userId: string,
): Promise<void> {
  const rows = deals.map((deal) => ({
    id: deal.id,
    org_id: ORG_ID,
    created_by: userId,
    client_name: deal.contactName,
    client_phone: "407-555-0100",
    client_email: "seller@test.local",
    address: deal.address,
    city: deal.city,
    state: deal.state,
    zip: deal.zip,
    payload: {
      contact: {
        name: deal.contactName,
        phone: "407-555-0100",
        email: "seller@test.local",
        owner: { name: deal.contactName, phone: "407-555-0100", email: "seller@test.local" },
      },
      client: {
        name: deal.contactName,
        phone: "407-555-0100",
        email: "seller@test.local",
      },
      property: {
        address: deal.address,
        city: deal.city,
        state: deal.state,
        zip: deal.zip,
        county: deal.county ?? null,
        occupancy: deal.occupancy ?? null,
      },
    },
  }));

  const { error } = await client.from("deals").upsert(rows, { onConflict: "id" });
  if (error) {
    throw error;
  }
}

async function upsertRuns(
  client: SupabaseClient,
  runs: RunSeed[],
  userId: string,
): Promise<void> {
  const rows = runs.map((run) => {
    const createdAt = new Date().toISOString();
    const inputHash = hashJson(run.input);
    const outputHash = hashJson(run.output);
    return {
      id: run.id,
      org_id: ORG_ID,
      deal_id: run.dealId,
      created_by: userId,
      posture: run.posture,
      input: run.input,
      input_hash: inputHash,
      output: run.output,
      output_hash: outputHash,
      policy_hash: hashJson({ policy: "qa-v1" }),
      policy_snapshot: {},
      trace: run.trace,
      created_at: createdAt,
    };
  });

  const { error } = await client.from("runs").upsert(rows, { onConflict: "id" });
  if (error) {
    throw error;
  }
}

async function computeBorderlineExpectations(apiUrl: string, anonKey: string) {
  const userClient = createClient(apiUrl, anonKey, {
    auth: { autoRefreshToken: false, persistSession: false },
  });

  const { data: session, error: signInError } = await userClient.auth.signInWithPassword({
    email: QA_EMAIL,
    password: QA_PASSWORD,
  });
  if (signInError || !session?.session?.access_token) {
    throw signInError ?? new Error("Failed to sign in QA user for borderline expectations");
  }

  const accessToken = session.session.access_token;

  const response = await fetch(`${apiUrl}/functions/v1/v1-analyze`, {
    method: "POST",
    headers: {
      apikey: anonKey,
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      org_id: ORG_ID,
      posture: QA_POSTURE,
      deal: {
        aiv: 180000,
        arv: 180000,
        dom: 30,
        payoff: 99000,
      },
    }),
  });

  if (!response.ok) {
    throw new Error(`v1-analyze call failed (${response.status})`);
  }
  const body = (await response.json()) as any;
  const outputs = (body?.result?.outputs ?? {}) as Record<string, any>;
  return {
    minSpread: Number(outputs.min_spread_required ?? outputs.min_spread ?? 0),
    spreadCash: Number(outputs.spread_cash ?? 0),
    flag: Boolean(outputs.borderline_flag ?? outputs.borderline ?? false),
  };
}

function writeEnvFile(env: EnvMap, overrides: Record<string, string | number | boolean>) {
  const lines = [
    `PLAYWRIGHT_ENABLE=true`,
    `NEXT_PUBLIC_SUPABASE_URL=${env.SUPABASE_URL}`,
    `NEXT_PUBLIC_SUPABASE_ANON_KEY=${env.SUPABASE_ANON_KEY}`,
    `SUPABASE_URL=${env.SUPABASE_URL}`,
    `SUPABASE_ANON_KEY=${env.SUPABASE_ANON_KEY}`,
    `DEALENGINE_QA_API_URL=${env.SUPABASE_URL}`,
    `DEALENGINE_QA_USER_EMAIL=${QA_EMAIL}`,
    `DEALENGINE_QA_USER_PASSWORD=${QA_PASSWORD}`,
    `DEALENGINE_QA_ORG_ID=${ORG_ID}`,
    `DEALENGINE_QA_POSTURE=${QA_POSTURE}`,
    `DEALENGINE_QA_READY_DEAL_ID=${READY_DEAL_ID}`,
    `DEALENGINE_QA_READY_CLIENT_NAME=${QA_READY_CLIENT_NAME}`,
    `DEALENGINE_QA_VALUATION_DEAL_ID=${VALUATION_DEAL_ID}`,
    `DEALENGINE_QA_TIMELINE_DEAL_ID=${TIMELINE_DEAL_ID}`,
    `DEALENGINE_QA_TIMELINE_DTM_DAYS=${TIMELINE_DTM_DAYS}`,
    `DEALENGINE_QA_TIMELINE_CARRY_MONTHS=${TIMELINE_CARRY_MONTHS}`,
    `DEALENGINE_QA_TIMELINE_SPEED_BAND=${TIMELINE_SPEED_BAND}`,
    `DEALENGINE_QA_STALE_EVIDENCE_DEAL_ID=${STALE_DEAL_ID}`,
    `DEALENGINE_QA_HARD_GATE_DEAL_ID=${HARD_GATE_DEAL_ID}`,
    `DEALENGINE_QA_BORDERLINE_MIN_SPREAD=${overrides.DEALENGINE_QA_BORDERLINE_MIN_SPREAD}`,
    `DEALENGINE_QA_BORDERLINE_SPREAD_CASH=${overrides.DEALENGINE_QA_BORDERLINE_SPREAD_CASH}`,
    `DEALENGINE_QA_BORDERLINE_AIV=180000`,
    `DEALENGINE_QA_BORDERLINE_ARV=180000`,
    `DEALENGINE_QA_BORDERLINE_DOM=30`,
    `DEALENGINE_QA_BORDERLINE_PAYOFF=99000`,
    `DEALENGINE_QA_BORDERLINE_FLAG=${overrides.DEALENGINE_QA_BORDERLINE_FLAG}`,
  ];

  const envPath = path.join(process.cwd(), ".env.qa");
  fs.writeFileSync(envPath, lines.join("\n") + "\n", "utf8");
}

async function main() {
  const env = parseStatusEnv();
  const required = ["SUPABASE_URL", "SUPABASE_ANON_KEY", "SUPABASE_SERVICE_ROLE_KEY"];
  for (const key of required) {
    if (!env[key]) {
      throw new Error(`Missing ${key} from supabase status -o env output.`);
    }
  }

  const supabase = createClient(env.SUPABASE_URL, env.SUPABASE_SERVICE_ROLE_KEY, {
    auth: { autoRefreshToken: false, persistSession: false },
  });

  await ensureOrg(supabase);
  const userId = await ensureUser(supabase, QA_EMAIL, QA_PASSWORD);
  await ensureMembership(supabase, userId);

  const deals = buildDeals();
  await upsertDeals(supabase, deals, userId);
  const runs = buildRuns();
  await upsertRuns(supabase, runs, userId);

  const borderline = await computeBorderlineExpectations(
    env.SUPABASE_URL,
    env.SUPABASE_ANON_KEY,
  );
  writeEnvFile(env, {
    DEALENGINE_QA_BORDERLINE_MIN_SPREAD: borderline.minSpread.toString(),
    DEALENGINE_QA_BORDERLINE_SPREAD_CASH: borderline.spreadCash.toString(),
    DEALENGINE_QA_BORDERLINE_FLAG: String(borderline.flag),
  });

  console.log("Seeded QA fixtures for org", ORG_ID);
  console.log("User:", QA_EMAIL);
  console.log(
    "Deals:",
    `READY=${READY_DEAL_ID}, TIMELINE=${TIMELINE_DEAL_ID}, STALE_EVIDENCE=${STALE_DEAL_ID}, HARD_GATE=${HARD_GATE_DEAL_ID}`,
  );
  console.log("Wrote .env.qa with QA variables (values not shown).");
}

main().catch((err) => {
  console.error("QA seed failed:", err.message ?? err);
  process.exit(1);
});


===== FILE: apps/hps-dealengine/app/(app)/trace/page.tsx =====
"use client";

import React, { useEffect, useState } from "react";
import { getSupabase } from "@/lib/supabaseClient";
import { listEvidence, getEvidenceUrl, type Evidence } from "@/lib/evidence";
import {
  listPolicyOverridesForDealOrRun,
  type PolicyOverride,
} from "@/lib/policyOverrides";
import { GlassCard } from "@/components/ui";
import { InfoTooltip } from "@/components/ui/InfoTooltip";
import { useDealSession } from "@/lib/dealSessionContext";
import { SANDBOX_V1_KNOBS } from "@/constants/sandboxKnobs";
import { evidenceLabel } from "@/lib/evidenceFreshness";
import KnobFamilySummary from "@/components/overview/KnobFamilySummary";
import CalibrationChip from "@/components/trace/CalibrationChip";

type SimpleUser = {
  id: string;
  email?: string | null;
};

type RunRow = {
  id: string;
  org_id: string;
  posture: string;
  created_at: string;
  deal_id?: string | null;
  input: unknown;
  output: unknown;
  trace: unknown[] | null;
  input_hash: string | null;
  output_hash: string | null;
  policy_hash: string | null;
};

type StatusState =
  | { kind: "idle" }
  | { kind: "loading" }
  | { kind: "loaded" }
  | { kind: "not-signed-in" }
  | { kind: "no-deal" }
  | { kind: "empty" }
  | { kind: "error"; message: string };

function pretty(value: unknown): string {
  try {
    return JSON.stringify(value, null, 2);
  } catch {
    return String(value);
  }
}

function formatDate(iso: string): string {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString(undefined, {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function isRecord(value: unknown): value is Record<string, unknown> {
  return typeof value === "object" && value !== null && !Array.isArray(value);
}

function extractCalibrationFromRunOutput(output: any): any | null {
  const candidates = [
    output?.calibration,
    output?.outputs?.calibration,
    output?.outputs?.valuation?.calibration,
  ];

  for (const candidate of candidates) {
    if (isRecord(candidate) && typeof (candidate as any).applied === "boolean") {
      return candidate;
    }
  }

  return null;
}

export default function TracePage() {
  const [status, setStatus] = useState<StatusState>({ kind: "idle" });
  const [user, setUser] = useState<SimpleUser | null>(null);
  const [runs, setRuns] = useState<RunRow[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [evidence, setEvidence] = useState<Evidence[]>([]);
  const [evidenceError, setEvidenceError] = useState<string | null>(null);
  const [overrides, setOverrides] = useState<PolicyOverride[]>([]);
  const [overrideError, setOverrideError] = useState<string | null>(null);
  const { dbDeal, lastAnalyzeResult, lastRunId, lastRunAt, posture } = useDealSession();

  useEffect(() => {
    const supabase = getSupabase();

    const load = async () => {
      setStatus({ kind: "loading" });

      const { data: userData, error: userError } =
        await supabase.auth.getUser();

      if (userError || !userData?.user) {
        setStatus({ kind: "not-signed-in" });
        return;
      }

      const u = userData.user as { id: string; email?: string | null };
      setUser({ id: u.id, email: u.email ?? null });

      if (!dbDeal?.id || !dbDeal.org_id) {
        setRuns([]);
        setSelectedId(null);
        setStatus({ kind: "no-deal" });
        return;
      }

      const { data, error } = await supabase
        .from("runs")
        .select(
          "id, org_id, deal_id, posture, created_at, input, output, trace, input_hash, output_hash, policy_hash",
        )
        .eq("org_id", dbDeal.org_id)
        .or(`deal_id.eq.${dbDeal.id},input->>dealId.eq.${dbDeal.id}`)
        .order("created_at", { ascending: false })
        .limit(50);

      if (error) {
        setStatus({ kind: "error", message: error.message });
        return;
      }

      const safeRuns: RunRow[] = (data ?? []).map((row: any) => ({
        id: row.id as string,
        org_id: row.org_id as string,
        deal_id: (row.deal_id as string | null) ?? null,
        posture: row.posture as string,
        created_at: row.created_at as string,
        input: row.input,
        output: row.output,
        trace: (row.trace as unknown[]) ?? [],
        input_hash: (row.input_hash as string | null) ?? null,
        output_hash: (row.output_hash as string | null) ?? null,
        policy_hash: (row.policy_hash as string | null) ?? null,
      }));

      if (safeRuns.length === 0) {
        setRuns([]);
        setSelectedId(null);
        setStatus({ kind: "empty" });
        return;
      }

      setRuns(safeRuns);
      setSelectedId(safeRuns[0]?.id ?? null);
      setStatus({ kind: "loaded" });
    };

    void load();
  }, [dbDeal?.id, dbDeal?.org_id]);

  const fallbackRun: RunRow | null =
    runs.length === 0 && lastAnalyzeResult
      ? {
          id: lastRunId ?? `derived-${dbDeal?.id ?? "run"}`,
          org_id: dbDeal?.org_id ?? "",
          deal_id: dbDeal?.id ?? null,
          posture: posture ?? "base",
          created_at: lastRunAt ?? new Date().toISOString(),
          input: {},
          output: lastAnalyzeResult,
          trace: (lastAnalyzeResult as any)?.trace ?? [],
          input_hash: null,
          output_hash: null,
          policy_hash: null,
        }
      : null;

  const displayedRuns = runs.length > 0 ? runs : fallbackRun ? [fallbackRun] : [];

  useEffect(() => {
    if (!selectedId && fallbackRun) {
      setSelectedId(fallbackRun.id);
    }
  }, [fallbackRun, selectedId]);

  const selected = displayedRuns.find((r) => r.id === selectedId) ?? null;
  const selectedDealId =
    selected?.deal_id ??
    (selected?.input as any)?.dealId ??
    dbDeal?.id ??
    null;
  const selectedOrgId = selected?.org_id ?? dbDeal?.org_id ?? null;
  const sandboxSnapshot = (selected?.input as any)?.sandbox ?? {};
  const repairSnapshot = (selected?.input as any)?.repairProfile ?? null;
  const evidenceAttachments = selected
    ? evidence.map((row) => ({
        id: row.id,
        kind: row.kind,
        label: row.storageKey.split("/").pop() ?? row.kind ?? "evidence",
        uri: undefined,
      }))
    : [];
  const outputs = (selected?.output as any)?.outputs ?? null;
  const calibration = selected ? extractCalibrationFromRunOutput(selected.output) : null;
  const riskSummary = outputs?.risk_summary ?? null;
  const evidenceFreshness = outputs?.evidence_summary ?? null;
  const workflowState = outputs?.workflow_state ?? null;
  const workflowReasons = outputs?.workflow_reasons ?? [];
  const confidenceGrade = outputs?.confidence_grade ?? null;
  const confidenceReasons = outputs?.confidence_reasons ?? [];
  const riskGates = (riskSummary?.per_gate as Record<string, any>) ?? {};
  const freshnessByKind = (evidenceFreshness?.freshness_by_kind as Record<string, any>) ?? {};
  const traceFrames = Array.isArray(selected?.trace) ? ((selected?.trace as any[]) ?? []) : [];
  const findTrace = (rule: string) => traceFrames.find((t: any) => t?.rule === rule);
  const evidenceTrace = findTrace("EVIDENCE_FRESHNESS_POLICY");
  const riskTrace = findTrace("RISK_GATES_POLICY");
  const confidenceTrace = findTrace("CONFIDENCE_POLICY");
  const workflowTrace = findTrace("WORKFLOW_STATE_POLICY");
  const knobSummaryOutput = selected ? { ...(selected.output as any), trace: traceFrames } : null;

  useEffect(() => {
    if (!selected) {
      setEvidence([]);
      setOverrides([]);
      return;
    }

    setEvidenceError(null);
    setOverrideError(null);

    // Evidence scoped to run_id
    listEvidence({ runId: selected.id })
      .then(setEvidence)
      .catch((err) => setEvidenceError(err.message));

    const dealId = selectedDealId ?? selected.id;
    listPolicyOverridesForDealOrRun({
      dealId,
      runId: selected.id,
      orgId: selectedOrgId ?? undefined,
      posture: selected?.posture ?? undefined,
      approvedOnly: true,
      includeDealIdNullForPosture: true,
    })
      .then(setOverrides)
      .catch((err) => {
        setOverrideError(err.message);
        setOverrides([]);
      });
  }, [selected, selectedDealId, selectedOrgId]);

  const handleCopyLink = async (id: string) => {
    try {
      const url = await getEvidenceUrl(id);
      await navigator.clipboard.writeText(url);
    } catch (err: unknown) {
      const msg = err instanceof Error ? err.message : "Unable to sign URL";
      setEvidenceError(msg);
    }
  };

  const statusBadge = (s: string | null | undefined, testId?: string) => {
    const sharedProps = testId ? { "data-testid": testId } : {};
    switch (s) {
      case "pass":
        return (
          <span
            className="rounded bg-green-900/40 px-2 py-0.5 text-[11px] text-green-200"
            {...sharedProps}
          >
            Pass
          </span>
        );
      case "watch":
        return (
          <span
            className="rounded bg-amber-900/40 px-2 py-0.5 text-[11px] text-amber-200"
            {...sharedProps}
          >
            Watch
          </span>
        );
      case "fail":
        return (
          <span className="rounded bg-red-900/40 px-2 py-0.5 text-[11px] text-red-200" {...sharedProps}>
            Fail
          </span>
        );
      default:
        return (
          <span
            className="rounded bg-slate-800/80 px-2 py-0.5 text-[11px] text-text-secondary"
            {...sharedProps}
          >
            Unknown
          </span>
        );
    }
  };

  return (
    <div className="flex flex-col gap-5 lg:gap-6">
      <GlassCard className="p-4 md:p-5 space-y-2">
        <div className="flex flex-col gap-1 md:flex-row md:items-baseline md:justify-between">
          <div>
            <h1 className="text-2xl font-semibold text-text-primary tracking-tight">Runs Trace</h1>
            <p className="text-sm text-text-secondary">
              Last 50 runs for the active deal. Select a run to inspect envelopes, trace,
              overrides, and evidence.
            </p>
            <p className="text-xs text-text-secondary">
              Deal:{" "}
              {dbDeal?.address
                ? `${dbDeal.address} (${dbDeal.id.slice(0, 8)}...)`
                : dbDeal?.id ?? "Select a deal on /deals"}
            </p>
          </div>
          <div className="text-xs text-text-secondary text-right">
            {user ? (
              <span className="block">
                User: <span className="font-mono">{user.email ?? user.id}</span>
              </span>
            ) : (
              <span>{status.kind === "loading" ? "Loading." : ""}</span>
            )}
          </div>
        </div>
        {status.kind === "not-signed-in" && (
          <p className="rounded-md bg-red-950/40 px-3 py-2 text-xs text-red-300">
            No Supabase auth session detected. Sign in to view runs.
          </p>
        )}
        {status.kind === "error" && (
          <p className="rounded-md bg-red-950/40 px-3 py-2 text-xs text-red-300">
            Error loading runs: {status.message}
          </p>
        )}
        {status.kind === "no-deal" && (
          <p className="rounded-md bg-amber-900/40 px-3 py-2 text-xs text-amber-200">
            Select a deal on /deals to view its runs and trace.
          </p>
        )}
        {status.kind === "empty" && (
          <p className="rounded-md bg-slate-900/60 px-3 py-2 text-xs text-text-secondary">
            No runs found yet for your orgs. Run an analysis to populate this view.
          </p>
        )}
      </GlassCard>

      <div className="grid gap-4 md:grid-cols-[minmax(0,1.05fr)_minmax(0,1.95fr)] lg:grid-cols-[minmax(0,0.9fr)_minmax(0,2.1fr)] lg:gap-6">
        <GlassCard className="p-3 md:p-4">
          <div className="mb-2 flex items-center justify-between">
            <h2 className="label-xs uppercase">Runs</h2>
            <span className="text-[11px] text-text-secondary">
              {displayedRuns.length} {displayedRuns.length === 1 ? "row" : "rows"}
            </span>
          </div>
          <div className="max-h-[420px] overflow-auto rounded-lg border border-border/40">
            <table className="min-w-full text-[11px]">
              <thead className="bg-slate-900/80 text-[10px] uppercase tracking-wide text-text-secondary">
                <tr>
                  <th className="px-2 py-1 text-left">Created</th>
                  <th className="px-2 py-1 text-left">Deal</th>
                  <th className="px-2 py-1 text-left">Org</th>
                  <th className="px-2 py-1 text-left">Posture</th>
                  <th className="px-2 py-1 text-left">Input hash</th>
                  <th className="px-2 py-1 text-left">Policy hash</th>
                </tr>
              </thead>
              <tbody>
                {displayedRuns.map((run) => {
                  const isSelected = run.id === selectedId;
                  return (
                    <tr
                      key={run.id}
                      className={
                        "cursor-pointer border-b border-border/30 last:border-b-0 " +
                        (isSelected ? "bg-blue-950/40" : "hover:bg-slate-900/60")
                      }
                      onClick={() => setSelectedId(run.id)}
                    >
                      <td className="px-2 py-1 align-top font-mono">{formatDate(run.created_at)}</td>
                      <td className="px-2 py-1 align-top font-mono">
                        {(run.deal_id ?? "").slice(0, 8) || "-"}
                      </td>
                      <td className="px-2 py-1 align-top font-mono">{run.org_id.slice(0, 8)}.</td>
                      <td className="px-2 py-1 align-top">{run.posture}</td>
                      <td className="px-2 py-1 align-top font-mono">{run.input_hash ?? "-"}</td>
                      <td className="px-2 py-1 align-top font-mono">{run.policy_hash ?? "-"}</td>
                    </tr>
                  );
                })}
                {displayedRuns.length === 0 && (
                  <tr>
                    <td
                      colSpan={5}
                      className="px-2 py-4 text-center text-[11px] text-text-secondary"
                    >
                      {status.kind === "loading" ? "Loading runs." : "No runs available yet."}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </GlassCard>

        <div className="flex flex-col gap-3 lg:grid lg:grid-cols-2 lg:gap-4 lg:items-start">
          <GlassCard className="p-3 md:p-4">
            <h2 className="mb-1 label-xs uppercase">Input envelope</h2>
            <pre className="max-h-[180px] overflow-auto whitespace-pre-wrap break-words rounded-lg bg-black/60 p-2 text-[11px] font-mono leading-relaxed text-text-primary/90">
              {selected ? pretty(selected.input) : "// Select a run"}
            </pre>
          </GlassCard>

          <GlassCard className="p-3 md:p-4">
            <h2 className="mb-1 label-xs uppercase">Output envelope</h2>
            <pre className="max-h-[140px] overflow-auto whitespace-pre-wrap break-words rounded-lg bg-black/60 p-2 text-[11px] font-mono leading-relaxed text-text-primary/90">
              {selected ? pretty(selected.output) : "// Select a run"}
            </pre>
          </GlassCard>

          <GlassCard className="p-3 md:p-4 lg:col-span-2">
            <h2 className="mb-1 label-xs uppercase">Calibration</h2>
            <CalibrationChip calibration={calibration} />
          </GlassCard>

          <GlassCard className="p-3 md:p-4 lg:col-span-2">
            <h2 className="mb-1 label-xs uppercase">Valuation & Profit (raw trace)</h2>
            <pre className="max-h-[160px] overflow-auto whitespace-pre-wrap break-words rounded-lg bg-black/60 p-2 text-[11px] font-mono leading-relaxed text-text-primary/90">
              {selected ? pretty(selected.trace) : "// Select a run"}
            </pre>
            <div className="sr-only">
              {traceFrames.map((frame, idx) => {
                const frameKey =
                  typeof (frame as any)?.key === "string"
                    ? (frame as any).key
                    : typeof (frame as any)?.rule === "string"
                      ? (frame as any).rule
                      : null;
                if (!frameKey) return null;
                return (
                  <span key={`${frameKey}-${idx}`} data-testid={`trace-frame-${frameKey}`} />
                );
              })}
            </div>
          </GlassCard>

          <GlassCard className="p-3 md:p-4 space-y-2">
            <h2 className="label-xs uppercase">Timeline &amp; Carry (trace summary)</h2>
            {selected?.output && (selected.output as any)?.outputs?.timeline_summary ? (
              <div className="space-y-1 text-[11px]">
                {(() => {
                  const ts = (selected.output as any).outputs.timeline_summary;
                  const rows: Array<[string, string]> = [
                    ["Speed band", ts.speed_band ?? "-"],
                    ["DOM / MOI", `${ts.dom_zip_days ?? "-"} / ${ts.moi_zip_months ?? "-"}`],
                    ["Days to money", ts.days_to_money ?? ts.dtm_selected_days ?? "-"],
                    ["Urgency", ts.urgency ?? "-"],
                    ["Carry months (raw/capped)", `${ts.carry_months_raw ?? "-"} / ${ts.carry_months ?? ts.carry_months_capped ?? "-"}`],
                    ["Hold monthly", ts.hold_monthly_dollars ?? "-"],
                    ["Carry total", ts.carry_total_dollars ?? "-"],
                    ["DTM source", ts.dtm_source ?? "-"],
                  ];
                  return rows.map(([label, value]) => (
                    <div key={label} className="flex items-center justify-between">
                      <span className="text-text-secondary">{label}</span>
                      <span className="font-mono text-text-primary">{value}</span>
                    </div>
                  ));
                })()}
              </div>
            ) : (
              <p className="text-[11px] text-text-secondary">
                {selected ? "No timeline summary on this run." : "// Select a run"}
              </p>
            )}
          </GlassCard>

          <GlassCard className="p-3 md:p-4 space-y-3 lg:col-span-2">
            <h2 className="label-xs uppercase">Risk, Evidence &amp; Workflow (trace summary)</h2>
            {outputs ? (
              <div className="space-y-3 text-[11px]">
                <div className="flex flex-wrap items-center gap-2">
                  <div className="flex items-center gap-1">
                    <span className="font-semibold text-text-primary">Workflow:</span>
                    <span
                      className="rounded bg-white/5 px-2 py-0.5 text-[11px] uppercase tracking-wide text-text-primary"
                      data-testid="trace-workflow-state"
                    >
                      {workflowState ?? "Unknown"}
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="font-semibold text-text-primary">Confidence:</span>
                    <span
                      className="rounded bg-white/5 px-2 py-0.5 text-[11px] uppercase tracking-wide text-text-primary"
                      data-testid="trace-confidence-grade"
                    >
                      {confidenceGrade ?? "?"}
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="font-semibold text-text-primary">Risk:</span>
                    {statusBadge((riskSummary as any)?.overall ?? null, "trace-risk-overall")}
                  </div>
                </div>

                {Array.isArray(workflowReasons) && workflowReasons.length > 0 && (
                  <div className="space-y-1">
                    <p className="label-xxs uppercase text-text-secondary">Workflow reasons</p>
                    <ul className="list-disc pl-4 space-y-0.5 text-text-primary">
                      {workflowReasons.map((reason, idx) => (
                        <li key={idx}>{reason}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {Array.isArray(confidenceReasons) && confidenceReasons.length > 0 && (
                  <div className="space-y-1">
                    <p className="label-xxs uppercase text-text-secondary">Confidence reasons</p>
                    <ul className="list-disc pl-4 space-y-0.5 text-text-primary">
                      {confidenceReasons.map((reason: string, idx: number) => (
                        <li key={idx}>{reason}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {Array.isArray(riskSummary?.reasons) && riskSummary.reasons.length > 0 && (
                  <div className="space-y-1">
                    <p className="label-xxs uppercase text-text-secondary">Risk reasons</p>
                    <ul className="list-disc pl-4 space-y-0.5 text-text-primary">
                      {riskSummary.reasons.map((reason: string, idx: number) => (
                        <li key={idx}>{reason}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {Object.keys(riskGates).length > 0 && (
                  <div>
                    <p className="label-xxs uppercase text-text-secondary mb-1">Gates</p>
                    <div className="grid gap-2 sm:grid-cols-2">
                      {Object.entries(riskGates).map(([key, value]) => {
                        const reasons =
                          (Array.isArray((value as any)?.reasons) ? ((value as any).reasons as string[]) : []) ?? [];
                        return (
                          <div
                            key={key}
                            className="flex items-center justify-between rounded bg-white/5 px-2 py-1"
                            data-testid={`trace-gate-${key}`}
                          >
                            <div className="flex flex-col">
                              <span className="font-semibold text-text-primary">
                                {key.replace(/_/g, " ")}
                              </span>
                              {reasons.length > 0 ? (
                                <span className="text-[10px] text-text-secondary">{reasons[0]}</span>
                              ) : null}
                            </div>
                            {statusBadge((value as any)?.status)}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {Object.keys(freshnessByKind).length > 0 && (
                  <div className="space-y-2">
                    <p className="label-xxs uppercase text-text-secondary mb-1">Evidence freshness</p>
                    <div className="grid gap-2 sm:grid-cols-2">
                      {Object.entries(freshnessByKind).map(([kind, value]) => {
                        const status = (value as any)?.status ?? value;
                        const blocking = Boolean((value as any)?.blocking_for_ready);
                        const age = (value as any)?.age_days;
                        const reasons =
                          (Array.isArray((value as any)?.reasons) ? ((value as any).reasons as string[]) : []) ?? [];
                        return (
                          <div
                            key={kind}
                            className="flex items-center justify-between rounded bg-white/5 px-2 py-1"
                            data-testid={`trace-evidence-${kind}`}
                          >
                            <div className="flex flex-col">
                              <span className="font-semibold text-text-primary">{evidenceLabel(kind)}</span>
                              <span className="text-[10px] text-text-secondary">
                                {age != null ? `${age}d` : "-"} {blocking ? "- blocking" : ""}
                              </span>
                              {reasons.length > 0 ? (
                                <span className="text-[10px] text-text-secondary">{reasons[0]}</span>
                              ) : null}
                            </div>
                            <span className="rounded bg-white/5 px-2 py-0.5 text-[11px] text-text-primary capitalize">
                              {String(status ?? "unknown")}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-[11px] text-text-secondary">Select a run to view risk and evidence.</p>
            )}
          </GlassCard>

          <div className="lg:col-span-2">
            <KnobFamilySummary runOutput={knobSummaryOutput} title="Policy & Knob Coverage" />
          </div>

          <div className="grid gap-3 md:grid-cols-2 lg:col-span-2">
            <GlassCard className="p-3 md:p-4 space-y-2">
            <h2 className="label-xs uppercase flex items-center gap-1">
              Confidence policy trace
              <InfoTooltip helpKey="confidence_grade" />
            </h2>
              {confidenceTrace ? (
                (() => {
                  const details = (confidenceTrace as any).details ?? {};
                  const reasons = Array.isArray(details.reasons) ? (details.reasons as string[]) : [];
                  let rubricSummary = null;
                  if (typeof details.rubric_raw === "string") {
                    try {
                      const parsed = JSON.parse(details.rubric_raw);
                      const entries = Object.entries(parsed)
                        .map(([grade, range]: any) => `${grade}: ${Array.isArray(range) ? range.join("-") : range}`)
                        .join("; ");
                      rubricSummary = entries;
                    } catch {
                      rubricSummary = details.rubric_raw;
                    }
                  }
                  return (
                    <div className="space-y-1 text-[11px]">
                      <div className="flex items-center justify-between">
                        <span className="text-text-secondary">Grade</span>
                        <span className="font-mono text-text-primary">{details.grade ?? confidenceGrade ?? "?"}</span>
                      </div>
                      {rubricSummary && (
                        <div className="text-[11px] text-text-secondary">
                          Rubric: {rubricSummary}
                        </div>
                      )}
                      {reasons.length > 0 && (
                        <ul className="list-disc pl-4 space-y-0.5 text-text-primary">
                          {reasons.map((r, idx) => (
                            <li key={idx}>{r}</li>
                          ))}
                        </ul>
                      )}
                    </div>
                  );
                })()
              ) : (
                <p className="text-[11px] text-text-secondary">No confidence trace on this run.</p>
              )}
            </GlassCard>

            <GlassCard className="p-3 md:p-4 space-y-2">
              <h2 className="label-xs uppercase">Evidence freshness trace</h2>
              {evidenceTrace ? (
                (() => {
                  const details = (evidenceTrace as any).details ?? {};
                  const freshness = (details.freshness_by_kind as Record<string, any>) ?? {};
                  const placeholdersAllowed = details.allow_placeholders_when_evidence_missing === true;
                  const placeholdersUsed = details.placeholders_used === true;
                  const placeholderKinds =
                    Array.isArray(details.placeholder_kinds) && details.placeholder_kinds.length > 0
                      ? (details.placeholder_kinds as string[])
                      : [];
                  return Object.keys(freshness).length === 0 ? (
                    <p className="text-[11px] text-text-secondary">No freshness entries.</p>
                  ) : (
                    <div className="space-y-2 text-[11px]">
                      <div className="rounded bg-white/5 px-2 py-1 text-[11px] text-text-secondary">
                        Placeholders: allowed {placeholdersAllowed ? "Yes" : "No"} - used{" "}
                        {placeholdersUsed ? "Yes" : "No"}
                        {placeholderKinds.length > 0 ? ` - kinds: ${placeholderKinds.join(", ")}` : ""}
                      </div>
                      {Object.entries(freshness).map(([kind, value]) => (
                        <div key={kind} className="flex items-center justify-between rounded bg-white/5 px-2 py-1">
                          <div className="flex flex-col">
                            <span className="font-semibold text-text-primary">{evidenceLabel(kind)}</span>
                            <span className="text-[10px] text-text-secondary">
                              {(value as any)?.age_days ?? "-"}d - {(value as any)?.as_of_date ?? "n/a"}
                            </span>
                          </div>
                          <span className="rounded bg-white/5 px-2 py-0.5 text-[11px] text-text-primary capitalize">
                            {(value as any)?.status ?? "unknown"}
                          </span>
                        </div>
                      ))}
                    </div>
                  );
                })()
              ) : (
                <p className="text-[11px] text-text-secondary">No evidence freshness trace on this run.</p>
              )}
            </GlassCard>

            <GlassCard className="p-3 md:p-4 space-y-2">
              <h2 className="label-xs uppercase">Risk gates trace</h2>
              {riskTrace ? (
                (() => {
                  const details = (riskTrace as any).details ?? {};
                  const gates = (details.per_gate as Record<string, any>) ?? {};
                  return Object.keys(gates).length === 0 ? (
                    <p className="text-[11px] text-text-secondary">No gate decisions recorded.</p>
                  ) : (
                    <div className="space-y-1 text-[11px]">
                      {Object.entries(gates).map(([key, value]) => {
                        const reasons =
                          (Array.isArray((value as any)?.reasons) ? ((value as any).reasons as string[]) : []) ?? [];
                        const enabled = (value as any)?.enabled !== false;
                        return (
                          <div key={key} className="flex items-center justify-between rounded bg-white/5 px-2 py-1">
                            <div className="flex flex-col">
                              <span className="font-semibold text-text-primary">
                                {key.replace(/_/g, " ")}
                                {!enabled ? " (disabled)" : ""}
                              </span>
                              {reasons.length > 0 ? (
                                <span className="text-[10px] text-text-secondary">{reasons[0]}</span>
                              ) : null}
                            </div>
                            {enabled ? statusBadge((value as any)?.status) : statusBadge("unknown")}
                          </div>
                        );
                      })}
                    </div>
                  );
                })()
              ) : (
                <p className="text-[11px] text-text-secondary">No risk gates trace on this run.</p>
              )}
            </GlassCard>

            <GlassCard className="p-3 md:p-4 space-y-2">
              <h2 className="label-xs uppercase">Workflow state trace</h2>
              {workflowTrace ? (
                (() => {
                  const details = (workflowTrace as any).details ?? {};
                  const reasons = Array.isArray(details.reasons) ? (details.reasons as string[]) : [];
                  const placeholderNote =
                    details.placeholders_used === true
                      ? "Placeholders used for missing evidence."
                      : details.allow_placeholders_when_evidence_missing === true
                      ? "Placeholders allowed if needed."
                      : "Placeholders disabled by policy.";
                  return (
                    <div className="space-y-1 text-[11px]">
                      <div className="flex items-center justify-between">
                        <span className="text-text-secondary">Workflow</span>
                        <span className="font-mono text-text-primary">{details.workflow_state ?? "Unknown"}</span>
                      </div>
                      <div className="text-text-secondary">
                        {`Borderline band >= ${
                          details.workflow_policy?.analyst_review_borderline_threshold ?? "n/a"
                        }; Cash gate spread >= ${
                          details.workflow_policy?.cash_presentation_min_spread_over_payoff ?? "n/a"
                        }.`}
                      </div>
                      <div className="text-text-secondary">{placeholderNote}</div>
                      {reasons.length > 0 && (
                        <ul className="list-disc pl-4 space-y-0.5 text-text-primary">
                          {reasons.map((r, idx) => (
                            <li key={idx}>{r}</li>
                          ))}
                        </ul>
                      )}
                    </div>
                  );
                })()
              ) : (
                <p className="text-[11px] text-text-secondary">No workflow trace on this run.</p>
              )}
            </GlassCard>
          </div>

          <GlassCard className="p-3 md:p-4">
            <h2 className="mb-1 label-xs uppercase">Repairs Snapshot</h2>
            {repairSnapshot ? (
              <div className="space-y-1 text-[11px]">
                <div className="flex items-center justify-between">
                  <span className="text-text-secondary">Profile</span>
                  <span className="font-mono text-text-primary">
                    {repairSnapshot.profileName ?? repairSnapshot.name ?? "n/a"}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-text-secondary">Market</span>
                  <span className="font-mono text-text-primary">
                    {repairSnapshot.marketCode ?? "n/a"}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-text-secondary">As of</span>
                  <span className="font-mono text-text-primary">
                    {repairSnapshot.asOf ?? "n/a"}
                  </span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-text-secondary">Version</span>
                  <span className="font-mono text-text-primary">
                    {repairSnapshot.version ?? "n/a"}
                  </span>
                </div>
              </div>
            ) : (
              <p className="text-[11px] text-text-secondary">
                No repair profile captured for this run.
              </p>
            )}
          </GlassCard>

          <GlassCard className="p-3 md:p-4 lg:col-span-2">
            <h2 className="mb-1 label-xs uppercase">Sandbox Snapshot</h2>
            {SANDBOX_V1_KNOBS.map((k) => {
              const val = (sandboxSnapshot as any)?.[k.key];
              return (
                <div key={k.key} className="flex items-center justify-between text-[11px]">
                  <span className="text-text-secondary">{k.label}</span>
                  <span className="font-mono text-text-primary">
                    {typeof val === "undefined" ? "-" : JSON.stringify(val)}
                  </span>
                </div>
              );
            })}
          </GlassCard>

          <GlassCard className="p-3 md:p-4 space-y-2 lg:col-span-2">
            <h2 className="label-xs uppercase">Policy Overrides (this run)</h2>
            {overrideError && (
              <div className="rounded-md border border-red-500/40 bg-red-500/5 px-3 py-2 text-[11px] text-red-200">
                {overrideError}
              </div>
            )}
            {overrides.filter((o) => o.status === "approved").length === 0 ? (
              <p className="text-[11px] text-text-secondary">
                {selected ? "No approved overrides for this run yet." : "// Select a run"}
              </p>
            ) : (
              <div className="max-h-56 overflow-auto rounded-lg border border-border/40">
                <table className="min-w-full text-[11px]">
                  <thead className="bg-slate-900/80 text-[10px] uppercase tracking-wide text-text-secondary">
                    <tr>
                      <th className="px-2 py-1 text-left">Token</th>
                      <th className="px-2 py-1 text-left">Old -&gt; New</th>
                      <th className="px-2 py-1 text-left">Approved By</th>
                      <th className="px-2 py-1 text-left">Approved At</th>
                      <th className="px-2 py-1 text-left">Justification</th>
                    </tr>
                  </thead>
                  <tbody>
                    {overrides
                      .filter((row) => row.status === "approved")
                      .map((row) => (
                      <tr key={row.id} className="border-b border-border/30 last:border-b-0">
                        <td className="px-2 py-1 align-top font-mono">{row.tokenKey}</td>
                        <td className="px-2 py-1 align-top">
                          <div className="rounded bg-black/40 p-1 font-mono text-[11px]">
                            {JSON.stringify(row.oldValue)}
                          </div>
                          <div className="mt-1 rounded bg-black/40 p-1 font-mono text-[11px]">
                            {JSON.stringify(row.newValue)}
                          </div>
                        </td>
                        <td className="px-2 py-1 align-top text-text-secondary">
                          {row.approvedBy ?? row.requestedBy ?? "-"}
                        </td>
                        <td className="px-2 py-1 align-top text-text-secondary">
                          {row.approvedAt
                            ? new Date(row.approvedAt).toLocaleString()
                            : "-"}
                        </td>
                        <td className="px-2 py-1 align-top text-text-secondary">
                          <div className="mb-1 text-text-primary">{row.justification || "-"}</div>
                          <div className="rounded bg-black/40 p-2 font-mono">
                            {pretty(row.newValue)}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </GlassCard>

          <GlassCard className="p-3 md:p-4 space-y-2 lg:col-span-2">
            <h2 className="label-xs uppercase flex items-center gap-1">
              Evidence
              <InfoTooltip helpKey="evidence_freshness" />
            </h2>
            {evidenceError && (
              <div className="rounded-md border border-red-500/40 bg-red-500/5 px-3 py-2 text-[11px] text-red-200">
                {evidenceError}
              </div>
            )}
            {evidence.length === 0 ? (
              <p className="text-[11px] text-text-secondary">
                {selected ? "No evidence for this run yet." : "// Select a run"}
              </p>
            ) : (
              <div className="max-h-56 overflow-auto rounded-lg border border-border/40">
                <table className="min-w-full text-[11px]">
                  <thead className="bg-slate-900/80 text-[10px] uppercase tracking-wide text-text-secondary">
                    <tr>
                      <th className="px-2 py-1 text-left">Kind</th>
                      <th className="px-2 py-1 text-left">File</th>
                      <th className="px-2 py-1 text-left">Added</th>
                      <th className="px-2 py-1 text-left">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {evidence.map((row) => (
                      <tr key={row.id} className="border-b border-border/30 last:border-b-0">
                        <td className="px-2 py-1 align-top">{row.kind}</td>
                        <td className="px-2 py-1 align-top font-mono">
                          {row.storageKey.split("/").pop()}
                        </td>
                        <td className="px-2 py-1 align-top text-text-secondary">
                          {new Date(row.createdAt).toLocaleString()}
                        </td>
                        <td className="px-2 py-1 align-top">
                          <button
                            type="button"
                            className="text-[11px] text-accent-blue hover:underline"
                            onClick={() => void handleCopyLink(row.id)}
                          >
                            Copy link
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </GlassCard>
        </div>
      </div>
    </div>
  );
}


===== FILE: tests/e2e/pre-v2-offer-and-contract.spec.ts =====
import { test, expect } from "@playwright/test";
import { getQaDealIdsOrThrow, loginAsQa } from "./_helpers/qaAuth";

const QA_EMAIL =
  process.env.DEALENGINE_QA_USER_EMAIL ?? process.env.DEALENGINE_TEST_USER_EMAIL;
const QA_PASSWORD =
  process.env.DEALENGINE_QA_USER_PASSWORD ?? process.env.DEALENGINE_TEST_USER_PASSWORD;
const QA_READY_DEAL_ID = process.env.DEALENGINE_QA_READY_DEAL_ID;
const QA_VALUATION_DEAL_ID = process.env.DEALENGINE_QA_VALUATION_DEAL_ID;

const CONTRACT_PRICE = "123456";

test.describe("Pre-V2 valuation rails", () => {
  test.skip(
    !QA_EMAIL || !QA_PASSWORD || !QA_READY_DEAL_ID,
    "Set DEALENGINE_QA_USER_EMAIL, DEALENGINE_QA_USER_PASSWORD, and DEALENGINE_QA_READY_DEAL_ID to run this test.",
  );

  test("offer package flow", async ({ page }) => {
    const { readyDealId } = getQaDealIdsOrThrow();
    await loginAsQa(page);

    await page.goto(`/overview?dealId=${readyDealId}`);
    await page.waitForURL("**/overview**", { timeout: 60_000 });

    const workflowPill = page.getByTestId("workflow-pill");
    await expect(workflowPill).toBeVisible();
    await expect(workflowPill).toContainText(/Ready/i);

    const clientButton = page.getByRole("button", { name: /view/i }).first();
    await expect(clientButton).toBeVisible();
    await clientButton.click();

    const sendOfferButton = page.getByTestId("cta-send-offer");
    await expect(sendOfferButton).toBeEnabled();
    await sendOfferButton.click();

    await page.waitForURL(/\/offer-packages\//, { timeout: 60_000 });

    const offerPackagePage = page.getByTestId("offer-package-page");
    await expect(offerPackagePage).toBeVisible();

    const offerAmount = page.getByTestId("offer-package-amount");
    await expect(offerAmount).toBeVisible();
    const amountText = (await offerAmount.textContent())?.trim() ?? "";
    expect(amountText).not.toEqual("");
    expect(amountText).not.toEqual("-");
  });

  test("under contract capture flow", async ({ page }) => {
    const { readyDealId } = getQaDealIdsOrThrow();
    await loginAsQa(page);

    await page.goto(`/overview?dealId=${readyDealId}`);
    await page.waitForURL("**/overview**", { timeout: 60_000 });

    const markUnderContract = page.getByTestId("cta-mark-under-contract");
    await expect(markUnderContract).toBeVisible();
    await markUnderContract.click();

    const contractPriceInput = page.getByTestId("contract-executed-price");
    await expect(contractPriceInput).toBeVisible();
    await contractPriceInput.fill(CONTRACT_PRICE);

    const submitButton = page.getByTestId("contract-submit");
    await submitButton.click();
    await expect(page.getByText("Deal marked under contract.")).toBeVisible({ timeout: 20_000 });

    await page.goto(`/underwrite?dealId=${readyDealId}`);
    await page.waitForURL(new RegExp(`/underwrite\\?dealId=${readyDealId}`), {
      timeout: 60_000,
    });

    const executedPrice = page.getByTestId("executed-contract-price");
    await expect(executedPrice).toBeVisible();
    await expect
      .poll(
        async () => {
          const text = (await executedPrice.textContent()) ?? "";
          return text.replace(/\D/g, "");
        },
        { timeout: 20_000 },
      )
      .toContain(CONTRACT_PRICE);
    const executedText = (await executedPrice.textContent()) ?? "";
    expect(executedText).toContain("$");
  });

  test("market provenance trace present", async ({ page }) => {
    const { readyDealId } = getQaDealIdsOrThrow();
    const valuationDealId = QA_VALUATION_DEAL_ID ?? readyDealId;
    await loginAsQa(page);

    await page.goto(`/trace?dealId=${valuationDealId}`);
    await page.waitForURL("**/trace**", { timeout: 60_000 });

    const provenanceTrace = page.getByTestId("trace-frame-MARKET_PROVENANCE");
    await expect(provenanceTrace).toBeAttached();
  });
});


===== FILE: scripts/qa-preflight.ps1 =====
$ErrorActionPreference = "Stop"

$requiredVars = @(
  "NEXT_PUBLIC_SUPABASE_URL",
  "NEXT_PUBLIC_SUPABASE_ANON_KEY",
  "DEALENGINE_QA_API_URL",
  "DEALENGINE_QA_USER_EMAIL",
  "DEALENGINE_QA_USER_PASSWORD",
  "DEALENGINE_QA_READY_DEAL_ID"
)

$missing = @()
foreach ($name in $requiredVars) {
  $value = [Environment]::GetEnvironmentVariable($name)
  if ([string]::IsNullOrWhiteSpace($value)) {
    $missing += $name
  }
}

if ($missing.Count -gt 0) {
  Write-Host "QA preflight failed: missing required env vars."
  $missing | ForEach-Object { Write-Host " - $_" }
  exit 1
}

# ---- Local Supabase reachability (API gateway) ----
$portCheck = Test-NetConnection -ComputerName "127.0.0.1" -Port 54321
if (-not $portCheck.TcpTestSucceeded) {
  Write-Host "QA preflight failed: 127.0.0.1:54321 is not reachable."
  exit 1
}

$apiUrl = $env:DEALENGINE_QA_API_URL.TrimEnd("/")
$tokenUrl = "$apiUrl/auth/v1/token?grant_type=password"
$anonKey = $env:NEXT_PUBLIC_SUPABASE_ANON_KEY

$payload = @{
  email = $env:DEALENGINE_QA_USER_EMAIL
  password = $env:DEALENGINE_QA_USER_PASSWORD
} | ConvertTo-Json

$headers = @{
  apikey = $anonKey
  Authorization = "Bearer $anonKey"
}

# ---- Auth token check ----
try {
  $response = Invoke-WebRequest -Method Post -Uri $tokenUrl -Headers $headers -Body $payload -ContentType "application/json" -TimeoutSec 20
} catch {
  $statusCode = $null
  $body = $null

  if ($_.Exception.Response) {
    try {
      $statusCode = [int]$_.Exception.Response.StatusCode
      $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
      $body = $reader.ReadToEnd()
    } catch {
      $body = $_.Exception.Message
    }
  } else {
    $body = $_.Exception.Message
  }

  Write-Host "QA preflight failed: auth token request errored."
  if ($statusCode) { Write-Host "Status: $statusCode" }
  if ($body) { Write-Host "Response: $body" }
  exit 1
}

if ($response.StatusCode -lt 200 -or $response.StatusCode -ge 300) {
  Write-Host "QA preflight failed: auth token request returned $($response.StatusCode)."
  if ($response.Content) { Write-Host "Response: $($response.Content)" }
  exit 1
}

try {
  $tokenBody = $response.Content | ConvertFrom-Json
} catch {
  Write-Host "QA preflight failed: auth token response is not valid JSON."
  Write-Host "Response: $($response.Content)"
  exit 1
}

if (-not $tokenBody.access_token) {
  Write-Host "QA preflight failed: auth token response missing access_token."
  Write-Host "Response: $($response.Content)"
  exit 1
}

# ---- Edge Functions sanity check (catches the exact 503 you hit) ----
# NOTE: We intentionally use GET so it should be "safe" (no side effects).
# v1-analyze is POST-only, so a healthy setup often returns 401/405/400 here  thats OK.
function Test-EdgeFunctionReachable {
  param(
    [string]$FunctionName,
    [hashtable]$Headers,
    [string]$ApiUrl
  )

  $fnUrl = "$ApiUrl/functions/v1/$FunctionName"

  try {
    $fnResp = Invoke-WebRequest -Method Get -Uri $fnUrl -Headers $Headers -TimeoutSec 15
    Write-Host "Edge Functions reachable: GET $fnUrl returned $($fnResp.StatusCode)."
    return
  } catch {
    $statusCode = $null
    $body = $null

    if ($_.Exception.Response) {
      try {
        $statusCode = [int]$_.Exception.Response.StatusCode
        $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
        $body = $reader.ReadToEnd()
      } catch {
        $body = $_.Exception.Message
      }
    } else {
      $body = $_.Exception.Message
    }

    # Pass conditions: function runtime is up and responding (even if method/auth is wrong).
    if ($statusCode -in @(400, 401, 403, 405, 415)) {
      Write-Host "Edge Functions reachable: $FunctionName responded HTTP $statusCode (expected for GET)."
      return
    }
    elseif ($statusCode -eq 404) {
      Write-Host "QA preflight failed: $FunctionName not found at $fnUrl (HTTP 404)."
      if ($body) { Write-Host "Response: $body" }
      exit 1
    }
    else {
      Write-Host "QA preflight failed: Edge Functions check errored for $FunctionName."
      if ($statusCode) { Write-Host "Status: $statusCode" }
      if ($body) { Write-Host "Response: $body" }
      exit 1
    }
  }
}

$fnHeaders = @{
  apikey = $anonKey
  Authorization = "Bearer $($tokenBody.access_token)"
}

Test-EdgeFunctionReachable -FunctionName "v1-analyze" -Headers $fnHeaders -ApiUrl $apiUrl
Test-EdgeFunctionReachable -FunctionName "v1-offer-package-generate" -Headers $fnHeaders -ApiUrl $apiUrl
Test-EdgeFunctionReachable -FunctionName "v1-deal-contract-upsert" -Headers $fnHeaders -ApiUrl $apiUrl

Write-Host "QA preflight OK."


