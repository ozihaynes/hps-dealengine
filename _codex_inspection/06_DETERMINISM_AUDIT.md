# Determinism Audit

Sources of nondeterminism (evidence → impact → suggested fix):
- External data without versioning: RentCast AVM/comps/market fetched live each run (supabase/functions/_shared/valuationSnapshot.ts:69-187) with no request hashing or provider as-of; TTL default 24h but after expiry outputs drift. Fix: persist provider response with effective_date and require explicit as_of parameter or snapshot reuse until policy-driven cutoff; optionally pin to provider-supplied as_of if available.
- Current time embedded in snapshot data: buildStubComps sets as_of=new Date() (lines 37-67); fetchRentcast/fetchRentcastMarket set as_of=new Date() for comps/market (lines 69-155, 158-187); ensureSnapshotForDeal uses now for expires_at (lines 300-333). This makes hashes differ across reruns when TTL expired or stub hit. Fix: derive as_of from provider payload or truncate to policy effective date; avoid per-comp now() (use snapshot as_of for all rows) and freeze stub timestamps per fingerprint.
- Unstable comp ordering: comparables array from RentCast is stored in received order (lines 114-143) before canonicalJson hashing; provider ordering may vary and changes hash/run results. Fix: sort comps deterministically (e.g., by close_date desc then distance/id) before hashing/storage.
- No retries/backoff or rate-limit handling: fetchRentcast/market do single call then stub on failure (lines 92-111, 158-186). Transient errors flip between live/stub payloads producing different ARV/confidence. Fix: add limited retries/backoff and classify failures separately from stub mode; optionally persist failure reason separately without changing comps.
- Confidence depends on correlation field which may be missing: stats.median_correlation null forces grade C (v1-valuation-run/index.ts:157-207) regardless of comp quality; provider may omit field unpredictably. Fix: add deterministic default (e.g., 0) or policy toggle; record provenance when correlation absent and avoid grade shifts based on provider field presence.
- Manual overrides timestamped with now(): v1-valuation-override-market/index.ts:119-136 stamps arv_as_of/as_is_value_as_of with current time; repeated overrides around same value change hashes and engine behavior over time. Fix: allow user-provided effective_date or reuse valuation_run as_of when linking to a run.
- Suggested ARV selection time-dependent when AVM missing: fallback to median of all comp prices (v1-valuation-run/index.ts:147-174) without date/quality filtering. New comps entering provider feed changes output even within TTL. Fix: add deterministic filters (age/distance/size) and sort before median; optionally lock to top-N by correlation/distance to stabilize.
- Engine reliance on deal.market fields without provenance: compute_underwriting.ts:2102-2182 caps ARV/AIV but trusts whatever value is present; if deal.market updated outside valuation flow, outputs drift with time/user input. Fix: require valuation_run_id/as_of in deal before compute or include valuation hash in run input to tie outputs to specific snapshot.