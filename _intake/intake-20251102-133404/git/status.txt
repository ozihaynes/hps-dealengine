On branch intake/gemini-app-review
Changes not staged for commit:
  (use "git add/rm <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   .gitignore
	modified:   .npmrc
	deleted:    apps/hps-dealengine/__trash_20251027_200430/src/app/compute_underwriting.ts
	deleted:    apps/hps-dealengine/__trash_20251027_200430/src/app/favicon.ico
	deleted:    apps/hps-dealengine/__trash_20251027_200430/src/app/globals.css
	deleted:    apps/hps-dealengine/__trash_20251027_200430/src/app/layout.tsx
	deleted:    apps/hps-dealengine/__trash_20251027_200430/src/app/page.tsx
	deleted:    apps/hps-dealengine/app/api/double-close/route.ts
	deleted:    apps/hps-dealengine/app/api/double-close/route.ts.bak
	modified:   apps/hps-dealengine/app/api/health/route.ts
	deleted:    apps/hps-dealengine/app/api/run-underwrite/route.ts
	deleted:    apps/hps-dealengine/app/api/underwrite/route.ts
	deleted:    apps/hps-dealengine/app/api/underwrite/route.ts.bak
	modified:   apps/hps-dealengine/app/api/version/route.ts
	modified:   apps/hps-dealengine/app/globals.css
	modified:   apps/hps-dealengine/app/layout.tsx
	modified:   apps/hps-dealengine/app/page.tsx
	deleted:    apps/hps-dealengine/app/playground/page.tsx
	modified:   apps/hps-dealengine/app/underwrite/page.tsx
	deleted:    apps/hps-dealengine/app/underwrite/run/page.tsx
	modified:   apps/hps-dealengine/components/UnderwriteTab.tsx
	modified:   apps/hps-dealengine/lib/api.ts
	modified:   apps/hps-dealengine/middleware.ts
	modified:   apps/hps-dealengine/package.json
	modified:   apps/hps-dealengine/tsconfig.json
	modified:   package.json
	modified:   packages/engine/dist/double_close.d.ts
	modified:   packages/engine/dist/double_close.js
	modified:   packages/engine/dist/index.d.ts
	modified:   packages/engine/dist/index.js
	deleted:    packages/engine/middleware.ts
	modified:   packages/engine/package.json
	modified:   packages/engine/src/compute_underwriting.ts
	modified:   packages/engine/src/index.ts
	deleted:    packages/engine/src/run_underwrite.ts
	modified:   packages/engine/src/types.ts
	deleted:    packages/engine/tests/double-close.math.test.ts
	deleted:    packages/engine/tests/double-close.test.ts
	deleted:    packages/engine/tests/respect-floor.test.ts
	deleted:    packages/engine/tests/underwrite.ceiling.test.ts
	deleted:    packages/engine/tests/underwrite.rf.test.ts
	deleted:    packages/engine/tests/underwrite.smoke.test.ts
	modified:   packages/engine/tsconfig.build.json
	modified:   packages/engine/tsconfig.json
	modified:   pnpm-lock.yaml
	modified:   pnpm-workspace.yaml
	modified:   tsconfig.json

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	.env.local
	.tmp/
	System.Management.Automation.Internal.Host.InternalHost
	_intake/
	apps/hps-dealengine/.data/
	apps/hps-dealengine/app/api/analyze/
	apps/hps-dealengine/app/api/policy/
	apps/hps-dealengine/app/api/tokens.ts
	apps/hps-dealengine/app/api/tokens/
	apps/hps-dealengine/app/api/user-prefs/
	apps/hps-dealengine/app/settings/
	apps/hps-dealengine/app/sources/
	apps/hps-dealengine/app/styles/
	apps/hps-dealengine/app/trace/
	apps/hps-dealengine/app/underwrite/ui-defaults.ts
	apps/hps-dealengine/components/CarryPreview.tsx
	apps/hps-dealengine/components/MAOPreview.tsx
	apps/hps-dealengine/components/PolicyEditor.tsx
	apps/hps-dealengine/components/PresetBar.tsx
	apps/hps-dealengine/components/SandboxButton.tsx
	apps/hps-dealengine/components/SettingsPrefs.tsx
	apps/hps-dealengine/components/SettingsTokens.tsx
	apps/hps-dealengine/components/StrategistPanel.tsx
	apps/hps-dealengine/components/TokensEditor.tsx
	apps/hps-dealengine/components/gemini/
	apps/hps-dealengine/components/overview/
	apps/hps-dealengine/components/repairs/
	apps/hps-dealengine/components/settings/
	apps/hps-dealengine/components/shared/
	apps/hps-dealengine/components/ui.tsx
	apps/hps-dealengine/constants.ts
	apps/hps-dealengine/middleware.ts.bak.20251101-025340
	apps/hps-dealengine/middleware.ts.bak.20251101-025700
warning: in the working copy of '.gitignore', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of '.npmrc', CRLF will be replaced by LF the next time Git touches it
	apps/hps-dealengine/services/
	apps/hps-dealengine/shims/
	apps/hps-dealengine/styles/
	apps/hps-dealengine/types.ts
	apps/hps-dealengine/types.ts.bak-20251031-232014
	apps/hps-dealengine/types.ts.bak-20251031-232147
	apps/hps-dealengine/types.ts.bak-20251031-232633
	apps/hps-dealengine/types/
	apps/hps-dealengine/utils/
	packages/contracts/
	packages/engine/src-legacy/
	packages/engine/tests.skip/
	witch main

--------------------------------------------------
Changes not staged for commit:
diff --git i/.gitignore w/.gitignore
index 0ef0a3e..4455913 100644
--- i/.gitignore
+++ w/.gitignore
@@ -2,3 +2,7 @@ node_modules
 
 packages/**/dist
 .vercel
+
+# local sandbox data
+apps/hps-dealengine/app/data/
+
diff --git i/.npmrc w/.npmrc
index fc08f16..6c59086 100644
--- i/.npmrc
+++ w/.npmrc
@@ -1 +1 @@
-only-built-dependencies=false
+enable-pre-post-scripts=true
diff --git i/apps/hps-dealengine/__trash_20251027_200430/src/app/compute_underwriting.ts w/apps/hps-dealengine/__trash_20251027_200430/src/app/compute_underwriting.ts
deleted file mode 100644
index 21fd5d0..0000000
--- i/apps/hps-dealengine/__trash_20251027_200430/src/app/compute_underwriting.ts
+++ /dev/null
@@ -1,7 +0,0 @@
-// A placeholder to fix the typecheck error.
-// We can add the real underwriting logic here later.
-
-export function computeUnderwriting() {
-  console.log('computeUnderwriting function called');
-  return {};
-}
diff --git i/apps/hps-dealengine/__trash_20251027_200430/src/app/favicon.ico w/apps/hps-dealengine/__trash_20251027_200430/src/app/favicon.ico
deleted file mode 100644
index 718d6fe..0000000
Binary files i/apps/hps-dealengine/__trash_20251027_200430/src/app/favicon.ico and /dev/null differ
diff --git i/apps/hps-dealengine/__trash_20251027_200430/src/app/globals.css w/apps/hps-dealengine/__trash_20251027_200430/src/app/globals.css
deleted file mode 100644
index 37d72f8..0000000
--- i/apps/hps-dealengine/__trash_20251027_200430/src/app/globals.css
+++ /dev/null
@@ -1,26 +0,0 @@
-@import 'tailwindcss';
-
-:root {
-  --background: #ffffff;
-  --foreground: #171717;
-}
-
-@theme inline {
-  --color-background: var(--background);
-  --color-foreground: var(--foreground);
-  --font-sans: var(--font-geist-sans);
-  --font-mono: var(--font-geist-mono);
-}
-
-@media (prefers-color-scheme: dark) {
-  :root {
-    --background: #0a0a0a;
-    --foreground: #ededed;
-  }
-}
-
-body {
-  background: var(--background);
-  color: var(--foreground);
-  font-family: Arial, Helvetica, sans-serif;
-}
diff --git i/apps/hps-dealengine/__trash_20251027_200430/src/app/layout.tsx w/apps/hps-dealengine/__trash_20251027_200430/src/app/layout.tsx
deleted file mode 100644
index 29a47ae..0000000
--- i/apps/hps-dealengine/__trash_20251027_200430/src/app/layout.tsx
+++ /dev/null
@@ -1,24 +0,0 @@
-import type { Metadata } from 'next';
-import { Inter, Roboto_Mono } from 'next/font/google';
-import './globals.css';
-
-const geistSans = Inter({ subsets: ['latin'], variable: '--font-sans' });
-
-const geistMono = Roboto_Mono({ subsets: ['latin'], variable: '--font-mono' });
-
-export const metadata: Metadata = {
-  title: 'Create Next App',
-  description: 'Generated by create next app',
-};
-
-export default function RootLayout({
-  children,
-}: Readonly<{
-  children: React.ReactNode;
-}>) {
-  return (
-    <html lang="en">
-      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>{children}</body>
-    </html>
-  );
-}
diff --git i/apps/hps-dealengine/__trash_20251027_200430/src/app/page.tsx w/apps/hps-dealengine/__trash_20251027_200430/src/app/page.tsx
deleted file mode 100644
index 6571b39..0000000
--- i/apps/hps-dealengine/__trash_20251027_200430/src/app/page.tsx
+++ /dev/null
@@ -1,65 +0,0 @@
-import Image from 'next/image';
-
-export default function Home() {
-  return (
-    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
-      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
-        <Image
-          className="dark:invert"
-          src="/next.svg"
-          alt="Next.js logo"
-          width={100}
-          height={20}
-          priority
-        />
-        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
-          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
-            To get started, edit the page.tsx file.
-          </h1>
-          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
-            Looking for a starting point or more instructions? Head over to{' '}
-            <a
-              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
-              className="font-medium text-zinc-950 dark:text-zinc-50"
-            >
-              Templates
-            </a>{' '}
-            or the{' '}
-            <a
-              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
-              className="font-medium text-zinc-950 dark:text-zinc-50"
-            >
-              Learning
-            </a>{' '}
-            center.
-          </p>
-        </div>
-        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
-          <a
-            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
-            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
-            target="_blank"
-            rel="noopener noreferrer"
-          >
-            <Image
-              className="dark:invert"
-              src="/vercel.svg"
-              alt="Vercel logomark"
-              width={16}
-              height={16}
-            />
-            Deploy Now
-          </a>
-          <a
-            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
-            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
-            target="_blank"
-            rel="noopener noreferrer"
-          >
-            Documentation
-          </a>
-        </div>
-      </main>
-    </div>
-  );
-}
diff --git i/apps/hps-dealengine/app/api/double-close/route.ts w/apps/hps-dealengine/app/api/double-close/route.ts
deleted file mode 100644
index 83eb18c..0000000
--- i/apps/hps-dealengine/app/api/double-close/route.ts
+++ /dev/null
@@ -1,50 +0,0 @@
-import { NextResponse } from 'next/server';
-import { z } from 'zod';
-import { doubleClose } from '@hps-internal/engine';
-import { checkRateLimit } from '@/lib/rateLimit';
-
-// Simple math variant
-const SimpleSchema = z.object({
-  sellerPrice: z.number().finite().nonnegative(),
-  buyerPrice: z.number().finite().nonnegative(),
-  aToBCloseCosts: z.number().finite().nonnegative(),
-  bToCCloseCosts: z.number().finite().nonnegative(),
-  holdingDays: z.number().finite().nonnegative(),
-  carryPerDay: z.number().finite().nonnegative(),
-});
-
-export async function POST(req: Request) {
-  const rl = checkRateLimit(req, 'api:double-close', 60, 60_000);
-  if (!rl.allowed) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'RATE_LIMIT', message: 'Too many requests' } },
-      { status: 429, headers: rl.headers }
-    );
-  }
-
-  try {
-    const json = await req.json().catch(() => ({}));
-    const parsed = SimpleSchema.safeParse(json);
-    if (!parsed.success) {
-      return NextResponse.json(
-        {
-          ok: false,
-          error: {
-            code: 'BAD_REQUEST',
-            message: 'Invalid payload for simple double-close',
-            details: parsed.error.flatten(),
-          },
-        },
-        { status: 400, headers: rl.headers }
-      );
-    }
-
-    const results = doubleClose(parsed.data);
-    return NextResponse.json({ ok: true, results }, { status: 200, headers: rl.headers });
-  } catch (err: any) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'SERVER_ERROR', message: err?.message ?? 'Unexpected' } },
-      { status: 500, headers: rl.headers }
-    );
-  }
-}
diff --git i/apps/hps-dealengine/app/api/double-close/route.ts.bak w/apps/hps-dealengine/app/api/double-close/route.ts.bak
deleted file mode 100644
index aab7204..0000000
--- i/apps/hps-dealengine/app/api/double-close/route.ts.bak
+++ /dev/null
@@ -1,20 +0,0 @@
-import { computeDoubleClose } from "@hps-internal/engine";
-import { NextResponse } from 'next/server';
-import { computeDoubleClose } from '@hps-internal/engine';
-
-export async function GET() {
-  return NextResponse.json({ ok: true, route: "double-close" });
-});
-}
-
-export async function POST(req: Request) {
-  const body = await req.json().catch(() => ({}));
-  const out = computeDoubleClose(body);
-  return NextResponse.json({ ok: true, out });
-});
-    return NextResponse.json({ ok: true, data });
-  } catch (err: any) {
-    return NextResponse.json({ ok: false, error: String(err?.message ?? err) }, { status: 400 });
-  }
-}
-
diff --git i/apps/hps-dealengine/app/api/health/route.ts w/apps/hps-dealengine/app/api/health/route.ts
index 23ee53b..6080b93 100644
--- i/apps/hps-dealengine/app/api/health/route.ts
+++ w/apps/hps-dealengine/app/api/health/route.ts
@@ -1,8 +1,7 @@
+// health/route.ts
 import { NextResponse } from 'next/server';
 export const dynamic = 'force-dynamic';
-
 const START = Date.now();
-
 export async function GET() {
   const uptime_s = Math.round((Date.now() - START) / 1000);
   return NextResponse.json({ ok: true, uptime_s }, { status: 200 });
diff --git i/apps/hps-dealengine/app/api/run-underwrite/route.ts w/apps/hps-dealengine/app/api/run-underwrite/route.ts
deleted file mode 100644
index a209520..0000000
--- i/apps/hps-dealengine/app/api/run-underwrite/route.ts
+++ /dev/null
@@ -1,39 +0,0 @@
-import { NextResponse } from 'next/server';
-import { z } from 'zod';
-import { computeUnderwriting } from '@hps-internal/engine';
-import { checkRateLimit } from '@/lib/rateLimit';
-
-const BodySchema = z.object({ deal: z.unknown() });
-
-export async function POST(req: Request) {
-  // Rate limit: 60/min per IP
-  const rl = checkRateLimit(req, 'api:run-underwrite', 60, 60_000);
-  if (!rl.allowed) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'RATE_LIMIT', message: 'Too many requests' } },
-      { status: 429, headers: rl.headers }
-    );
-  }
-
-  try {
-    const json = await req.json().catch(() => ({}));
-    const parsed = BodySchema.safeParse(json);
-    if (!parsed.success) {
-      return NextResponse.json(
-        {
-          ok: false,
-          error: { code: 'BAD_REQUEST', message: 'Invalid body', details: parsed.error.flatten() },
-        },
-        { status: 400, headers: rl.headers }
-      );
-    }
-
-    const results = computeUnderwriting(parsed.data.deal as any);
-    return NextResponse.json({ ok: true, results }, { status: 200, headers: rl.headers });
-  } catch (err: any) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'SERVER_ERROR', message: err?.message ?? 'Unexpected' } },
-      { status: 500, headers: rl.headers }
-    );
-  }
-}
diff --git i/apps/hps-dealengine/app/api/underwrite/route.ts w/apps/hps-dealengine/app/api/underwrite/route.ts
deleted file mode 100644
index 565d1a9..0000000
--- i/apps/hps-dealengine/app/api/underwrite/route.ts
+++ /dev/null
@@ -1,53 +0,0 @@
-import { NextResponse } from 'next/server';
-import { z } from 'zod';
-import { computeUnderwriting } from '@hps-internal/engine';
-import { checkRateLimit } from '@/lib/rateLimit';
-
-const HEADER = 'x-internal-key';
-const BodySchema = z.object({ deal: z.unknown() });
-
-export async function POST(req: Request) {
-  // Require internal key
-  const requiredKey = process.env.INTERNAL_API_KEY;
-  if (!requiredKey) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'CONFIG', message: 'INTERNAL_API_KEY not set' } },
-      { status: 500 }
-    );
-  }
-  const gotKey = req.headers.get(HEADER);
-  if (gotKey !== requiredKey) {
-    return NextResponse.json({ ok: false, error: { code: 'UNAUTHORIZED' } }, { status: 401 });
-  }
-
-  // Rate limit (separate bucket for internal)
-  const rl = checkRateLimit(req, 'api:underwrite', 120, 60_000);
-  if (!rl.allowed) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'RATE_LIMIT', message: 'Too many requests' } },
-      { status: 429, headers: rl.headers }
-    );
-  }
-
-  try {
-    const json = await req.json().catch(() => ({}));
-    const parsed = BodySchema.safeParse(json);
-    if (!parsed.success) {
-      return NextResponse.json(
-        {
-          ok: false,
-          error: { code: 'BAD_REQUEST', message: 'Invalid body', details: parsed.error.flatten() },
-        },
-        { status: 400, headers: rl.headers }
-      );
-    }
-
-    const results = computeUnderwriting(parsed.data.deal as any);
-    return NextResponse.json({ ok: true, results }, { status: 200, headers: rl.headers });
-  } catch (err: any) {
-    return NextResponse.json(
-      { ok: false, error: { code: 'SERVER_ERROR', message: err?.message ?? 'Unexpected' } },
-      { status: 500, headers: rl.headers }
-    );
-  }
-}
diff --git i/apps/hps-dealengine/app/api/underwrite/route.ts.bak w/apps/hps-dealengine/app/api/underwrite/route.ts.bak
deleted file mode 100644
index d65fca1..0000000
--- i/apps/hps-dealengine/app/api/underwrite/route.ts.bak
+++ /dev/null
@@ -1,111 +0,0 @@
-/* apps/dealengine/app/api/underwrite/route.ts */
-import { NextResponse } from "next/server";
-import { z } from "zod";
-import { uiToEngine, type EngineDeal } from "../../../lib/contract-adapter";
-
-const MoneyRow = z.object({ label: z.string().optional(), amount: z.number().finite() });
-
-const EngineDealSchema = z.object({
-  market: z.object({
-    aiv: z.number().min(0),
-    arv: z.number().min(0),
-    dom_zip: z.number(),
-    moi_zip: z.number(),
-    "price-to-list-pct": z.number().min(0).max(1).optional(),
-  }),
-  costs: z.object({
-    repairs_base: z.number().min(0),
-    contingency_pct: z.number().min(0).max(1),
-    monthly: z.object({
-      taxes: z.number().min(0),
-      insurance: z.number().min(0),
-      hoa: z.number().min(0),
-      utilities: z.number().min(0),
-    }),
-    close_cost_items_seller: z.array(MoneyRow).optional(),
-    close_cost_items_buyer: z.array(MoneyRow).optional(),
-    essentials_moveout_cash: z.number().min(0).optional(),
-    concessions_pct: z.number().min(0).max(1).optional(),
-  }),
-  debt: z.object({
-    senior_principal: z.number().min(0),
-    senior_per_diem: z.number().min(0),
-    good_thru_date: z.string().nullable().optional(),
-    juniors: z.array(MoneyRow).optional(),
-  }),
-  timeline: z.object({
-    days_to_ready_list: z.number().min(0),
-    days_to_sale_manual: z.number().min(0),
-    timeline_total_days: z.number().min(0).optional(),
-  }),
-}).passthrough();
-
-const sum = (xs: number[]) => xs.reduce((a, b) => a + b, 0);
-const n = (x: unknown) => (typeof x === "number" && Number.isFinite(x) ? x : 0);
-const clamp = (x: number, lo: number, hi: number) => Math.min(hi, Math.max(lo, x));
-
-function computeDTM(deal: EngineDeal) {
-  const manual_days = Math.max(0, n(deal.timeline.days_to_sale_manual));
-  const default_cash_close_days = Math.max(0, Math.round(n(deal.market.dom_zip) + 35)); // SOT default
-  const useManual = manual_days > 0 && manual_days <= default_cash_close_days;
-
-  return {
-    manual_days,
-    default_cash_close_days,
-    chosen_days: useManual ? manual_days : default_cash_close_days,
-    reason: useManual ? "manual" as const : "dom+35" as const,
-  };
-}
-
-function computeDealMath(deal: EngineDeal) {
-  // DTM first (earliest-of)
-  const dtm = computeDTM(deal);
-
-  // Carry (cap 5.0 mo)
-  const hold_monthly =
-    n(deal.costs.monthly.taxes) +
-    n(deal.costs.monthly.insurance) +
warning: in the working copy of 'apps/hps-dealengine/app/globals.css', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'apps/hps-dealengine/app/layout.tsx', CRLF will be replaced by LF the next time Git touches it
-    n(deal.costs.monthly.hoa) +
-    n(deal.costs.monthly.utilities);
-
-  const total_days = n(deal.timeline.days_to_ready_list) + dtm.chosen_days;
-  const hold_months = clamp(total_days / 30, 0, 5);
-
-  // Respect Floor pieces
-  const juniors = sum((deal.debt.juniors ?? []).map((j) => n(j.amount)));
-  const payoff_plus_essentials =
-    n(deal.debt.senior_principal) + juniors + n(deal.costs.essentials_moveout_cash);
-
-  // Investor floors will be filled from ZIP dataset; scaffold now
-  const investor: null | { p20_floor: number; typical_floor: number } = null;
-  const investorFloor =
-  (typeof investor === "object" && investor &&
-   "typical_floor" in (investor as any) &&
-   typeof (investor as any).typical_floor === "number")
-    ? (investor as any).typical_floor
-    : 0;
-const operational = Math.max(payoff_plus_essentials, investorFloor);return {
-    dtm,
-    carry: { hold_monthly, hold_months, total_days },
-    floors: { payoff_plus_essentials, investor, operational },
-  };
-}
-
-export async function POST(req: Request) {
-  try {
-    const raw = await req.json().catch(() => ({}));
-    const deal = uiToEngine(raw?.deal ?? raw ?? {});
-    const parsed = EngineDealSchema.safeParse(deal);
-    if (!parsed.success) {
-      return NextResponse.json({ ok: false, issues: parsed.error.format() }, { status: 400 });
-    }
-    const math = computeDealMath(parsed.data);
-    return NextResponse.json({ ok: true, math, echoes: { deal: parsed.data } });
-  } catch (err: any) {
-    return NextResponse.json({ ok: false, error: err?.message ?? "Bad Request" }, { status: 400 });
-  }
-}
-
-export async function GET() {
-  return NextResponse.json({ ok: true, route: "underwrite" });
-}
diff --git i/apps/hps-dealengine/app/api/version/route.ts w/apps/hps-dealengine/app/api/version/route.ts
index 30faa2a..48a58bc 100644
--- i/apps/hps-dealengine/app/api/version/route.ts
+++ w/apps/hps-dealengine/app/api/version/route.ts
@@ -1,6 +1,6 @@
+// version/route.ts
 import { NextResponse } from 'next/server';
 export const dynamic = 'force-dynamic';
-
 export async function GET() {
   const sha = process.env.VERCEL_GIT_COMMIT_SHA ?? process.env.GIT_COMMIT_SHA ?? null;
   const ref = process.env.VERCEL_GIT_COMMIT_REF ?? process.env.GIT_COMMIT_REF ?? null;
diff --git i/apps/hps-dealengine/app/globals.css w/apps/hps-dealengine/app/globals.css
index df1df25..f5ecb95 100644
--- i/apps/hps-dealengine/app/globals.css
+++ w/apps/hps-dealengine/app/globals.css
@@ -9,3 +9,6 @@ body {
   color: var(--fg);
   min-height: 100%;
 }
+/* Pixel clarity additions */
+html, body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; }
+.metric, .card, .panel { -webkit-font-smoothing: antialiased; text-rendering: geometricPrecision; }
diff --git i/apps/hps-dealengine/app/layout.tsx w/apps/hps-dealengine/app/layout.tsx
index 36d6c2f..6d675ef 100644
--- i/apps/hps-dealengine/app/layout.tsx
+++ w/apps/hps-dealengine/app/layout.tsx
@@ -1,8 +1,37 @@
-import './globals.css';
+import "@/components/gemini/globals.css";
+import "../styles/tokens.css";
+import type { Metadata } from "next";
+
+export const metadata: Metadata = {
+  title: "HPS DealEngine",
+  description: "Investor Underwriting Sandbox",
+};
+
+function NavItem({ href, label }: { href: string; label: string }) {
+  const isActive = typeof window !== "undefined" && window.location.pathname.startsWith(href);
+  return <a className={"tab" + (isActive ? " active" : "")} href={href}>{label}</a>;
+}
+
 export default function RootLayout({ children }: { children: React.ReactNode }) {
   return (
     <html lang="en">
-      <body className="min-h-dvh bg-black text-white">{children}</body>
+      <body className="app-shell">
+        <header className="shell-header">
+          <div className="brand">HPS DealEngine</div>
+          <span className="badge">Sandbox</span>
+        </header>
+        <nav className="shell-nav">
+          <a className="tab" href="/underwrite">Underwrite</a>
warning: in the working copy of 'apps/hps-dealengine/app/page.tsx', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'apps/hps-dealengine/app/underwrite/page.tsx', CRLF will be replaced by LF the next time Git touches it
+          <a className="tab" href="/settings">Settings</a>
+          <a className="tab" href="/sources">Sources</a>
+          <a className="tab" href="/trace">Trace</a>
+        </nav>
+        <main className="shell-main">{children}</main>
+      </body>
     </html>
   );
 }
+
+
+
+
diff --git i/apps/hps-dealengine/app/page.tsx w/apps/hps-dealengine/app/page.tsx
index 265c75a..a150fc0 100644
--- i/apps/hps-dealengine/app/page.tsx
+++ w/apps/hps-dealengine/app/page.tsx
@@ -1,4 +1,2 @@
-import GeminiApp from '../components/GeminiApp';
-export default function Page() {
-  return <GeminiApp activeTab="overview" />;
-}
+import { redirect } from "next/navigation";
+export default function Page(){ redirect("/underwrite"); }
diff --git i/apps/hps-dealengine/app/playground/page.tsx w/apps/hps-dealengine/app/playground/page.tsx
deleted file mode 100644
index 9e6ec19..0000000
--- i/apps/hps-dealengine/app/playground/page.tsx
+++ /dev/null
@@ -1,77 +0,0 @@
-'use client';
-
-import * as React from 'react';
-import { runUnderwriteClient } from '@/lib/client/runUnderwrite';
-
-const DEFAULT_DEAL = {
-  market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-  costs: {
-    repairs_base: 40000,
-    contingency_pct: 0.15,
-    monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-    essentials_moveout_cash: 2000,
-  },
-  debt: { senior_principal: 180000, juniors: [{ label: 'HELOC', amount: 10000 }] },
-  timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-  status: { insurance_bindable: true },
-};
-
-export default function PlaygroundPage() {
-  const [text, setText] = React.useState(JSON.stringify(DEFAULT_DEAL, null, 2));
-  const [out, setOut] = React.useState<any>(null);
-  const [loading, setLoading] = React.useState(false);
-  const [err, setErr] = React.useState<string | null>(null);
-
-  async function onRun() {
-    setLoading(true);
-    setErr(null);
-    try {
-      const deal = JSON.parse(text);
-      const results = await runUnderwriteClient(deal);
-      setOut(results);
-    } catch (e: any) {
-      setErr(e?.message ?? 'Failed to run');
-    } finally {
-      setLoading(false);
-    }
-  }
-
-  return (
-    <main style={{ padding: 24 }}>
-      <h2 style={{ marginBottom: 12 }}>Underwrite Playground</h2>
-      <p style={{ opacity: 0.8, marginBottom: 12 }}>
-        Paste/edit deal JSON on the left, hit <b>Run</b>, see <b>headlines / floors / ceilings</b>.
-      </p>
-      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
-        <section>
-          <textarea
-            value={text}
-            onChange={(e) => setText(e.target.value)}
-            style={{ width: '100%', height: 420, fontFamily: 'monospace', fontSize: 13 }}
-          />
-          <div style={{ marginTop: 12 }}>
-            <button onClick={onRun} disabled={loading} style={{ padding: '8px 12px' }}>
-              {loading ? 'RunningΓÇª' : 'Run'}
-            </button>
-            {err && <div style={{ color: 'crimson', marginTop: 8 }}>{err}</div>}
-          </div>
-        </section>
-        <section>
-          <pre
-            style={{
-              width: '100%',
-              height: 470,
-              padding: 12,
-              background: '#0a0a0a',
-              color: '#d7ffd7',
-              overflow: 'auto',
-              borderRadius: 8,
-            }}
-          >
-            {out ? JSON.stringify(out, null, 2) : 'ΓÇö no results yet ΓÇö'}
-          </pre>
-        </section>
-      </div>
-    </main>
-  );
-}
diff --git i/apps/hps-dealengine/app/underwrite/page.tsx w/apps/hps-dealengine/app/underwrite/page.tsx
index eddcffb..7fdea5c 100644
--- i/apps/hps-dealengine/app/underwrite/page.tsx
+++ w/apps/hps-dealengine/app/underwrite/page.tsx
@@ -1,12 +1,9 @@
-// Server wrapper that mounts the real client tab
-import UnderwriteTab from '@/components/UnderwriteTab';
+import UnderwriteTab from "@/components/UnderwriteTab";
 
 export default function UnderwritePage() {
   return (
-    <main className="app-container" style={{ padding: 24 }}>
-      <h2 className="title" style={{ marginBottom: 12 }}>
-        Underwrite
-      </h2>
+    <main className="p-6">
+      <h2 className="text-2xl font-semibold mb-4">Underwrite</h2>
       <UnderwriteTab />
     </main>
   );
diff --git i/apps/hps-dealengine/app/underwrite/run/page.tsx w/apps/hps-dealengine/app/underwrite/run/page.tsx
deleted file mode 100644
index ef89a94..0000000
--- i/apps/hps-dealengine/app/underwrite/run/page.tsx
+++ /dev/null
@@ -1,82 +0,0 @@
-// apps/hps-dealengine/app/underwrite/run/page.tsx
-'use client';
-
-import { useState } from 'react';
-import { runUnderwrite } from '@/lib/api';
-
-const sampleDeal = {
-  market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-  costs: {
-    repairs_base: 40000,
-    contingency_pct: 0.15,
-    monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-    essentials_moveout_cash: 2000,
-  },
-  debt: { senior_principal: 180000, juniors: [{ label: 'HELOC', amount: 10000 }] },
-  timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-  status: { insurance_bindable: true },
-};
-
-export default function UnderwriteRunPage() {
-  const [dealJson, setDealJson] = useState<string>(JSON.stringify(sampleDeal, null, 2));
-  const [out, setOut] = useState<any>(null);
-  const [err, setErr] = useState<string | null>(null);
-  const [busy, setBusy] = useState(false);
-
-  async function onRun() {
-    setBusy(true);
-    setErr(null);
-    setOut(null);
-    try {
-      const parsed = JSON.parse(dealJson);
-      const res = await runUnderwrite(parsed);
-      if (!res.ok) throw new Error('Underwrite failed');
-      setOut(res.results);
-    } catch (e: any) {
-      setErr(e?.message ?? String(e));
-    } finally {
-      setBusy(false);
-    }
-  }
-
-  function resetSample() {
-    setDealJson(JSON.stringify(sampleDeal, null, 2));
-  }
-
-  return (
-    <main className="app-container">
-      <h2 className="title" style={{ marginBottom: 12 }}>
-        Underwrite ΓÇö Run
-      </h2>
-      <p className="opacity-80 text-sm">Paste or edit the deal JSON, then click Run.</p>
-
-      <textarea
-        className="w-full h-64 p-3 rounded border font-mono"
-        value={dealJson}
-        onChange={(e) => setDealJson(e.target.value)}
-      />
-
-      <div className="mt-3 flex gap-2">
-        <button onClick={onRun} disabled={busy} className="rounded-xl px-4 py-2 border">
-          {busy ? 'RunningΓÇª' : 'Run Underwrite'}
-        </button>
-        <button onClick={resetSample} disabled={busy} className="rounded-xl px-3 py-2 border">
-          Reset sample
-        </button>
-      </div>
-
-      {err && (
-        <pre className="mt-4 p-3 rounded-xl border text-red-600 whitespace-pre-wrap">{err}</pre>
-      )}
-
-      {out && (
-        <details open className="mt-4">
-          <summary className="cursor-pointer font-medium">Results</summary>
-          <pre className="mt-2 p-3 rounded-xl border overflow-auto text-sm">
-            {JSON.stringify(out, null, 2)}
-          </pre>
-        </details>
-      )}
-    </main>
-  );
-}
diff --git i/apps/hps-dealengine/components/UnderwriteTab.tsx w/apps/hps-dealengine/components/UnderwriteTab.tsx
index 1a9a091..9913b2d 100644
--- i/apps/hps-dealengine/components/UnderwriteTab.tsx
+++ w/apps/hps-dealengine/components/UnderwriteTab.tsx
@@ -1,245 +1,330 @@
-'use client';
+"use client";
 
-import { useEffect, useMemo, useState } from 'react';
-import { runUnderwrite } from '@/lib/api';
+import { useEffect, useMemo, useRef, useState } from "react";
 
-type UiDeal = {
-  market: {
-    aiv: number | string;
-    arv: number | string;
-    dom_zip: number | string;
-    moi_zip: number | string;
+type Json = string | number | boolean | null | Json[] | { [k: string]: Json };
+
+type InfoNeeded = {
+  path: string;
+  token?: string | null;
+  reason: string;
+  source_of_truth?: "investor_set" | "team_policy_set" | "external_feed" | "unknown";
+};
+
+type TraceEntry = {
+  rule: string;
+  used: string[];
+  details?: Record<string, unknown>;
+};
+
+type UnderwriteOutputs = {
+  caps: { aivCapApplied: boolean; aivCapValue: number | null };
+  carry: {
+    monthsRule: string | null;
+    monthsCap: number | null;
+    rawMonths: number | null;
+    carryMonths: number | null;
   };
-  costs: {
-    repairs_base: number | string;
-    contingency_pct: number | string;
-    monthly: {
-      taxes: number | string;
-      insurance: number | string;
-      hoa: number | string;
-      utilities: number | string;
+  fees?: {
+    rates: {
+      list_commission_pct: number;
+      concessions_pct: number;
+      sell_close_pct: number;
+    };
+    preview: {
+      base_price: number;
+      list_commission_amount: number;
+      concessions_amount: number;
+      sell_close_amount: number;
+      total_seller_side_costs: number;
     };
-    essentials_moveout_cash: number | string;
-  };
-  debt: {
-    senior_principal: number | string;
-    juniors?: Array<{ label: string; amount: number | string }>;
   };
-  timeline: { days_to_ready_list: number | string; days_to_sale_manual: number | string };
-  status: { insurance_bindable: boolean };
+  summaryNotes: string[];
 };
 
+type AnalyzeResult = {
+  ok: true;
+  infoNeeded: InfoNeeded[];
+  trace: TraceEntry[];
+  outputs: UnderwriteOutputs;
+};
+
+type AnalyzeResponse = { ok: true; result: AnalyzeResult };
+
+type DebugHeaders = {
+  tokenRegistryPath?: string | null;
+  tokenRegistryExists?: string | null;
+  tokenResolvedCount?: string | null;
+  capType?: string | null;
+  capValue?: string | null;
+  feeListCommissionPct?: string | null;
+  feeConcessionsPct?: string | null;
+  feeSellClosePct?: string | null;
+};
+
+function useDebouncedCallback(cb: () => void, delayMs: number) {
+  const t = useRef<ReturnType<typeof setTimeout> | null>(null);
+  useEffect(() => () => { if (t.current) clearTimeout(t.current); }, []);
+  return () => {
+    if (t.current) clearTimeout(t.current);
+    t.current = setTimeout(cb, delayMs);
+  };
+}
+
+function usd(n: number | null | undefined) {
+  if (typeof n !== "number" || !Number.isFinite(n)) return "ΓÇö";
+  return n.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
+}
+
+function pct(n: number | null | undefined) {
+  if (typeof n !== "number" || !Number.isFinite(n)) return "ΓÇö";
+  return `${(n * 100).toFixed(2)}%`;
+}
+
 export default function UnderwriteTab() {
-  const [deal, setDeal] = useState<UiDeal>({
-    market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-    costs: {
-      repairs_base: 40000,
-      contingency_pct: 0.15,
-      monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-      essentials_moveout_cash: 2000,
-    },
-    debt: { senior_principal: 180000, juniors: [{ label: 'HELOC', amount: 10000 }] },
-    timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-    status: { insurance_bindable: true },
-  });
-
-  const [auto, setAuto] = useState(true);
+  // Inputs (MVP)
+  const [aiv, setAiv] = useState<number | "">("");
+  const [domZip, setDomZip] = useState<number | "">("");
+
+  // Live data & status
+  const [prefs, setPrefs] = useState<any>(null);
+  const [policy, setPolicy] = useState<any>(null);
+  const [policyPath, setPolicyPath] = useState<string>("");
   const [loading, setLoading] = useState(false);
-  const [error, setErr] = useState<string | null>(null);
-  const [results, setResults] = useState<any>(null);
-
-  function setDealValue(path: string, v: any) {
-    setDeal((prev) => {
-      const next: any = structuredClone(prev);
-      const parts = path.split('.');
-      let ref = next;
-      for (let i = 0; i < parts.length - 1; i++) ref = ref[parts[i]];
-      ref[parts.at(-1)!] = v;
-      return next;
-    });
-  }
+  const [result, setResult] = useState<AnalyzeResult | null>(null);
+  const [error, setError] = useState<string | null>(null);
+  const [debug, setDebug] = useState<DebugHeaders | null>(null);
+
+  // Debounce from prefs (fallback 400ms)
+  const debounceMs = useMemo(() => {
+    const v = Number(prefs?.autorun_debounce_ms);
+    return Number.isFinite(v) ? v : 400;
+  }, [prefs]);
+
+  const debouncedRun = useDebouncedCallback(runAnalyze, debounceMs);
+
+  // Boot: prefs + policy (+ policy path header)
+  useEffect(() => {
+    let alive = true;
+    async function boot() {
+      try {
+        const prefsResp = await fetch("/api/user-prefs", { headers: { Accept: "application/json" }});
+        if (!prefsResp.ok) throw new Error("Failed to load user prefs");
+        const prefsJson = await prefsResp.json();
+        if (alive) setPrefs(prefsJson?.prefs ?? {});
+
+        const policyResp = await fetch("/api/policy", { headers: { Accept: "application/json" }});
+        if (!policyResp.ok) throw new Error("Failed to load policy");
+        const px = await policyResp.json();
+        if (alive) setPolicy(px?.policy ?? {});
+        const path = policyResp.headers.get("x-policy-path") ?? "";
+        if (alive) setPolicyPath(path);
+      } catch (err: any) {
+        if (alive) setError(err?.message ?? "Failed to initialize");
+      }
+    }
+    boot();
+    return () => { alive = false; };
+  }, []);
+
+  // Auto-run when inputs change (after policy present)
+  useEffect(() => {
+    if (!policy) return;
+    if (aiv === "" && domZip === "") return;
+    debouncedRun();
+    // eslint-disable-next-line react-hooks/exhaustive-deps
+  }, [aiv, domZip, policy, debounceMs]);
 
-  async function onRun() {
+  async function runAnalyze() {
+    if (!policy) return;
     setLoading(true);
-    setErr(null);
+    setError(null);
     try {
-      // Convert numeric strings to numbers where possible
-      const normalized = JSON.parse(JSON.stringify(deal), (_k, val) =>
-        typeof val === 'string' && val.trim() !== '' && !isNaN(Number(val)) ? Number(val) : val
-      );
-      const out = await runUnderwrite(normalized);
-      if (!out.ok) throw new Error(out.error || 'Engine returned !ok');
-      setResults(out.results ?? null);
-    } catch (e: any) {
-      setErr(e.message || String(e));
-      setResults(null);
+      const deal: any = { market: {} };
+      if (aiv !== "") deal.market.aiv = aiv;
+      if (domZip !== "") deal.market.dom_zip = domZip;
+
+      const payload = { deal, policy, options: { provenance: true } };
+      const r = await fetch("/api/analyze", {
+        method: "POST",
+        headers: { "content-type": "application/json" },
+        body: JSON.stringify(payload)
+      });
+
+      if (!r.ok) throw new Error(`Analyze failed (${r.status})`);
+
+      // Capture debug headers from server (if present)
+      const dbg: DebugHeaders = {
+        tokenRegistryPath: r.headers.get("x-token-registry-path"),
+        tokenRegistryExists: r.headers.get("x-token-registry-exists"),
+        tokenResolvedCount: r.headers.get("x-token-resolved-count"),
+        capType: r.headers.get("x-cap-type"),
+        capValue: r.headers.get("x-cap-value"),
+        feeListCommissionPct: r.headers.get("x-fee-list-commission-pct"),
+        feeConcessionsPct: r.headers.get("x-fee-concessions-pct"),
+        feeSellClosePct: r.headers.get("x-fee-sell-close-pct"),
+      };
+      setDebug(dbg);
+
+      const data = (await r.json()) as AnalyzeResponse;
+      setResult(data.result);
+    } catch (err: any) {
+      setError(err?.message ?? "Analyze error");
     } finally {
       setLoading(false);
     }
   }
 
-  // Auto-run with debounce when inputs change
-  useEffect(() => {
-    if (!auto) return;
-    const t = setTimeout(() => onRun(), 400);
-    return () => clearTimeout(t);
-    // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [deal, auto]);
-
-  const headline = useMemo(() => results?.headlines ?? {}, [results]);
-
   return (
-    <div style={{ display: 'grid', gap: 16 }}>
-      <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
-        <button onClick={onRun} disabled={loading} style={{ padding: '8px 12px', borderRadius: 8 }}>
-          {loading ? 'RunningΓÇª' : 'Run Underwrite'}
-        </button>
-        <label style={{ display: 'inline-flex', gap: 8, alignItems: 'center' }}>
-          <input type="checkbox" checked={auto} onChange={(e) => setAuto(e.target.checked)} />
-          Auto-run
-        </label>
-        {error && <span style={{ color: 'tomato' }}>Error: {error}</span>}
-      </div>
-
-      {/* Basic inputs (add more as needed) */}
-      <section
-        style={{ display: 'grid', gridTemplateColumns: 'repeat(4, minmax(160px, 1fr))', gap: 12 }}
-      >
-        <Field
-          label="AIV"
-          value={deal.market.aiv}
-          onChange={(v) => setDealValue('market.aiv', v)}
-        />
-        <Field
-          label="ARV"
-          value={deal.market.arv}
-          onChange={(v) => setDealValue('market.arv', v)}
-        />
-        <Field
-          label="DOM (ZIP)"
-          value={deal.market.dom_zip}
-          onChange={(v) => setDealValue('market.dom_zip', v)}
-        />
-        <Field
-          label="MOI (ZIP)"
-          value={deal.market.moi_zip}
-          onChange={(v) => setDealValue('market.moi_zip', v)}
-        />
-
-        <Field
-          label="Repairs Base"
-          value={deal.costs.repairs_base}
-          onChange={(v) => setDealValue('costs.repairs_base', v)}
-        />
-        <Field
-          label="Contingency %"
-          value={deal.costs.contingency_pct}
-          onChange={(v) => setDealValue('costs.contingency_pct', v)}
-        />
-        <Field
-          label="Taxes (yr)"
-          value={deal.costs.monthly.taxes}
-          onChange={(v) => setDealValue('costs.monthly.taxes', v)}
-        />
-        <Field
-          label="Insurance (yr)"
-          value={deal.costs.monthly.insurance}
-          onChange={(v) => setDealValue('costs.monthly.insurance', v)}
-        />
-
-        <Field
-          label="Senior Principal"
-          value={deal.debt.senior_principal}
-          onChange={(v) => setDealValue('debt.senior_principal', v)}
-        />
-        <Field
-          label="Ready-to-List (days)"
-          value={deal.timeline.days_to_ready_list}
-          onChange={(v) => setDealValue('timeline.days_to_ready_list', v)}
-        />
-        <Field
-          label="Days-to-Sale (manual)"
-          value={deal.timeline.days_to_sale_manual}
-          onChange={(v) => setDealValue('timeline.days_to_sale_manual', v)}
-        />
-        <Field
-          label="Essentials / Move-out $"
-          value={deal.costs.essentials_moveout_cash}
-          onChange={(v) => setDealValue('costs.essentials_moveout_cash', v)}
-        />
-      </section>
+    <div className="w-full space-y-6">
+      {/* Inputs */}
+      <section className="rounded-2xl p-5 border border-white/10 bg-white/5 backdrop-blur">
+        <div className="mb-3 text-xl font-semibold">Inputs</div>
+        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
+          <label className="flex flex-col gap-2">
+            <span className="text-sm opacity-80">AIV (number)</span>
+            <input
+              className="rounded-xl px-3 py-2 bg-black/30 border border-white/10 focus:outline-none"
+              type="number"
+              placeholder="e.g., 300000"
+              value={aiv}
+              onChange={(e) => setAiv(e.target.value === "" ? "" : Number(e.target.value))}
+            />
+          </label>
+          <label className="flex flex-col gap-2">
+            <span className="text-sm opacity-80">DOM (ZIP) days (number)</span>
+            <input
+              className="rounded-xl px-3 py-2 bg-black/30 border border-white/10 focus:outline-none"
+              type="number"
+              placeholder="e.g., 45"
+              value={domZip}
+              onChange={(e) => setDomZip(e.target.value === "" ? "" : Number(e.target.value))}
+            />
+          </label>
+        </div>
 
-      {/* Quick headline snapshot */}
-      <section
-        style={{ display: 'grid', gridTemplateColumns: 'repeat(3, minmax(200px, 1fr))', gap: 12 }}
-      >
-        <Metric title="Buyer Ceiling" value={headline?.buyer_ceiling} />
-        <Metric title="Respect Floor" value={headline?.respect_floor} />
-        <Metric title="Recommendation" value={headline?.recommendation} />
+        <div className="mt-4 flex items-center gap-3">
+          <button
+            onClick={runAnalyze}
+            className="rounded-2xl px-4 py-2 border border-white/10 bg-white/10 hover:bg-white/20 active:scale-[0.99]"
+            disabled={loading || !policy}
+          >
+            {loading ? "RunningΓÇª" : "Run analyze"}
+          </button>
+          <div className="text-xs opacity-60">
+            Autorun debounce: {debounceMs} ms ΓÇó Policy file: {policyPath || "in-memory"}
+          </div>
+        </div>
       </section>
 
-      {/* Raw JSON (dev) */}
-      <details>
-        <summary>Show full results JSON</summary>
-        <pre
-          style={{
-            background: '#0b1220',
-            color: '#d2f2ff',
-            padding: 12,
-            borderRadius: 8,
-            overflow: 'auto',
-          }}
-        >
-          {JSON.stringify(results ?? {}, null, 2)}
-        </pre>
-      </details>
-    </div>
-  );
-}
+      {/* Results */}
+      <section className="rounded-2xl p-5 border border-white/10 bg-white/5 backdrop-blur">
+        <div className="mb-3 text-xl font-semibold">Results</div>
+        {error && (
+          <div className="mb-3 rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-sm">
+            {error}
+          </div>
+        )}
+        {!result && !error && (
+          <div className="text-sm opacity-70">Change an input or press ΓÇ£Run analyzeΓÇ¥.</div>
+        )}
+        {result && (
+          <div className="space-y-6">
+            <div>
+              <div className="font-semibold mb-2">Summary</div>
+              <ul className="list-disc pl-6 text-sm">
+                {result.outputs.summaryNotes.map((s, i) => (
+                  <li key={i}>{s}</li>
+                ))}
+              </ul>
+            </div>
 
-function Field({
-  label,
-  value,
-  onChange,
-}: {
-  label: string;
-  value: string | number;
-  onChange: (v: string) => void;
-}) {
-  return (
-    <label style={{ display: 'grid', gap: 6 }}>
-      <span style={{ fontSize: 12, opacity: 0.9 }}>{label}</span>
-      <input
-        value={String(value ?? '')}
-        onChange={(e) => onChange(e.target.value)}
-        style={{
-          padding: '8px 10px',
-          border: '1px solid #234',
-          background: '#06101e',
-          color: 'white',
-          borderRadius: 8,
-        }}
-      />
-    </label>
-  );
-}
+            <div>
+              <div className="font-semibold mb-2">Caps</div>
+              <div className="text-sm grid grid-cols-1 sm:grid-cols-2 gap-2">
+                <div>AIV Cap Applied: <span className="opacity-80">{String(result.outputs.caps.aivCapApplied)}</span></div>
+                <div>AIV Cap Value: <span className="opacity-80">{result.outputs.caps.aivCapValue === null ? "ΓÇö" : usd(result.outputs.caps.aivCapValue)}</span></div>
+              </div>
+            </div>
 
-function Metric({ title, value }: { title: string; value: any }) {
-  const v = value ?? 'ΓÇö';
-  return (
-    <div
-      style={{
-        padding: 12,
-        border: '1px solid #234',
-        background: '#06101e',
-        color: 'white',
-        borderRadius: 10,
-      }}
-    >
-      <div style={{ fontSize: 12, opacity: 0.8 }}>{title}</div>
-      <div style={{ fontSize: 18, marginTop: 4 }}>
-        {typeof v === 'number' ? v.toLocaleString() : String(v)}
-      </div>
+            <div>
+              <div className="font-semibold mb-2">Carry Months</div>
+              <div className="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
+                <div>Rule: <span className="opacity-80">{result.outputs.carry.monthsRule ?? "ΓÇö"}</span></div>
+                <div>Cap: <span className="opacity-80">{result.outputs.carry.monthsCap ?? "ΓÇö"}</span></div>
+                <div>Raw months: <span className="opacity-80">{result.outputs.carry.rawMonths == null ? "ΓÇö" : result.outputs.carry.rawMonths.toFixed(2)}</span></div>
+                <div>Carry months: <span className="opacity-80">{result.outputs.carry.carryMonths == null ? "ΓÇö" : result.outputs.carry.carryMonths.toFixed(2)}</span></div>
+              </div>
+            </div>
+
+            {result.outputs.fees && (
+              <>
+                <div>
+                  <div className="font-semibold mb-2">Fee Rates</div>
+                  <div className="text-sm grid grid-cols-1 sm:grid-cols-3 gap-2">
+                    <div>List commission: <span className="opacity-80">{pct(result.outputs.fees.rates.list_commission_pct)}</span></div>
+                    <div>Concessions: <span className="opacity-80">{pct(result.outputs.fees.rates.concessions_pct)}</span></div>
+                    <div>Seller close: <span className="opacity-80">{pct(result.outputs.fees.rates.sell_close_pct)}</span></div>
+                  </div>
+                </div>
+
+                <div>
+                  <div className="font-semibold mb-2">Fee Preview</div>
+                  <div className="text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
+                    <div>Base price: <span className="opacity-80">{usd(result.outputs.fees.preview.base_price)}</span></div>
+                    <div>List commission: <span className="opacity-80">{usd(result.outputs.fees.preview.list_commission_amount)}</span></div>
+                    <div>Concessions: <span className="opacity-80">{usd(result.outputs.fees.preview.concessions_amount)}</span></div>
+                    <div>Seller close: <span className="opacity-80">{usd(result.outputs.fees.preview.sell_close_amount)}</span></div>
+                    <div className="col-span-1 lg:col-span-4">Total seller-side: <span className="opacity-80">{usd(result.outputs.fees.preview.total_seller_side_costs)}</span></div>
+                  </div>
+                </div>
+              </>
+            )}
+
+            {/* Debug */}
+            <div>
+              <div className="font-semibold mb-2">Debug (Analyze headers)</div>
+              <div className="text-xs grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
+                <div>Token registry path: <span className="opacity-80">{debug?.tokenRegistryPath ?? "ΓÇö"}</span></div>
+                <div>Registry exists: <span className="opacity-80">{debug?.tokenRegistryExists ?? "ΓÇö"}</span></div>
+                <div>Tokens resolved: <span className="opacity-80">{debug?.tokenResolvedCount ?? "0"}</span></div>
+                <div>Cap type: <span className="opacity-80">{debug?.capType ?? "ΓÇö"}</span></div>
+                <div>Cap value: <span className="opacity-80">{debug?.capValue ?? "ΓÇö"}</span></div>
+                <div>List commission pct: <span className="opacity-80">{debug?.feeListCommissionPct ?? "ΓÇö"}</span></div>
+                <div>Concessions pct: <span className="opacity-80">{debug?.feeConcessionsPct ?? "ΓÇö"}</span></div>
+                <div>Sell-close pct: <span className="opacity-80">{debug?.feeSellClosePct ?? "ΓÇö"}</span></div>
+              </div>
+            </div>
+
+            <div>
+              <div className="font-semibold mb-2">Trace ({result.trace.length})</div>
+              <div className="text-xs overflow-auto max-h-64 rounded-lg border border-white/10">
+                <table className="w-full">
+                  <thead className="bg-white/10">
+                    <tr>
+                      <th className="text-left p-2">Rule</th>
+                      <th className="text-left p-2">Used</th>
+                      <th className="text-left p-2">Details</th>
+                    </tr>
+                  </thead>
+                  <tbody>
+                    {result.trace.map((t, i) => (
+                      <tr key={i} className="odd:bg-white/5 align-top">
+                        <td className="p-2">{t.rule}</td>
+                        <td className="p-2 font-mono text-[11px]">{t.used.join(", ")}</td>
+                        <td className="p-2 font-mono text-[11px]">
+                          {t.details ? JSON.stringify(t.details) : "ΓÇö"}
+                        </td>
+                      </tr>
+                    ))}
+                  </tbody>
+                </table>
+              </div>
warning: in the working copy of 'apps/hps-dealengine/lib/api.ts', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'apps/hps-dealengine/middleware.ts', CRLF will be replaced by LF the next time Git touches it
+            </div>
+
+          </div>
+        )}
+      </section>
     </div>
   );
 }
diff --git i/apps/hps-dealengine/lib/api.ts w/apps/hps-dealengine/lib/api.ts
index e06445e..0b0df48 100644
--- i/apps/hps-dealengine/lib/api.ts
+++ w/apps/hps-dealengine/lib/api.ts
@@ -1,13 +1,31 @@
-// apps/hps-dealengine/lib/api.ts
+import type { Settings } from "@hps-internal/contracts";
 
-export type RunUnderwriteResult = { ok: boolean; results?: any; error?: string };
+export async function fetchPolicy(): Promise<Settings> {
+  const res = await fetch("/api/policy", { method: "GET" });
+  const data = await res.json();
+  if (!data?.ok) throw new Error("Failed to load policy");
+  return data.policy as Settings;
+}
+
+export async function putPolicy(policy: Settings): Promise<Settings> {
+  const res = await fetch("/api/policy", {
+    method: "PUT",
+    headers: { "Content-Type": "application/json" },
+    body: JSON.stringify({ policy })
+  });
+  const data = await res.json();
+  if (!data?.ok) throw new Error("Failed to save policy");
+  return data.policy as Settings;
+}
 
-export async function runUnderwrite(deal: any): Promise<RunUnderwriteResult> {
-  const res = await fetch('/api/run-underwrite', {
-    method: 'POST',
-    headers: { 'content-type': 'application/json' },
-    body: JSON.stringify({ deal }),
+/** Post to /api/analyze and normalize the response shape */
+export async function analyze(deal: any, policy?: Settings | null): Promise<any> {
+  const res = await fetch("/api/analyze", {
+    method: "POST",
+    headers: { "Content-Type": "application/json" },
+    body: JSON.stringify({ deal, policy: policy ?? undefined })
   });
-  if (!res.ok) throw new Error(`HTTP ${res.status}`);
-  return (await res.json()) as RunUnderwriteResult;
+  const data = await res.json();
+  // Our route returns { ok, result }, but tolerate direct objects too.
+  return (data && typeof data === "object" && "result" in data) ? (data.result ?? null) : data;
 }
diff --git i/apps/hps-dealengine/middleware.ts w/apps/hps-dealengine/middleware.ts
index 9a5fe97..1e1d37c 100644
--- i/apps/hps-dealengine/middleware.ts
+++ w/apps/hps-dealengine/middleware.ts
@@ -1,43 +1,40 @@
-import { NextResponse, type NextRequest } from 'next/server';
-
-const PUBLIC_PREFIXES = ['/api/health', '/api/version'];
+import { NextResponse } from "next/server";
+import type { NextRequest } from "next/server";
 
+/**
+ * Dev: skip auth entirely.
+ * Prod: enforce Basic Auth for app pages; exclude /api, /_next, static assets, and common file types.
+ */
 export function middleware(req: NextRequest) {
-  const { pathname } = req.nextUrl;
-
-  if (
-    pathname.startsWith('/_next/') ||
-    pathname === '/favicon.ico' ||
-    PUBLIC_PREFIXES.some((p) => pathname.startsWith(p))
-  ) {
+  if (process.env.NODE_ENV !== "production") {
     return NextResponse.next();
   }
 
-  const user = process.env.APP_BASIC_AUTH_USER || process.env.BASIC_AUTH_USER;
-  const pass = process.env.APP_BASIC_AUTH_PASS || process.env.BASIC_AUTH_PASS;
+  const auth = req.headers.get("authorization") || "";
+  const [scheme, encoded] = auth.split(" ");
 
-  if (!user || !pass) return NextResponse.next();
+  if (scheme !== "Basic" || !encoded) {
+    return new NextResponse("Authentication required.", {
+      status: 401,
+      headers: { "WWW-Authenticate": 'Basic realm="Secure Area"' },
+    });
+  }
 
-  const header = req.headers.get('authorization') || '';
-  if (!header.startsWith('Basic ')) return unauthorized();
+  const [user, pass] = Buffer.from(encoded, "base64").toString().split(":");
 
-  try {
-    const decoded = atob(header.slice(6));
-    const [u, p] = decoded.split(':');
-    if (u === user && p === pass) return NextResponse.next();
-    return unauthorized();
-  } catch {
-    return unauthorized();
+  const USER = process.env.BASIC_AUTH_USER || "ozi";
+  const PASS = process.env.BASIC_AUTH_PASS || "Password";
+
+  if (user !== USER || pass !== PASS) {
+    return new NextResponse("Access denied.", { status: 401 });
   }
-}
 
-function unauthorized() {
warning: in the working copy of 'apps/hps-dealengine/package.json', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'apps/hps-dealengine/tsconfig.json', CRLF will be replaced by LF the next time Git touches it
-  return new NextResponse('Authentication required', {
-    status: 401,
-    headers: { 'WWW-Authenticate': 'Basic realm="Protected"' },
-  });
+  return NextResponse.next();
 }
 
 export const config = {
-  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
+  matcher: [
+    // Everything except /api, Next assets, static files, and common file types
+    "/((?!api|_next|static|favicon.ico|robots.txt|sitemap.xml|.*\\.(?:png|jpg|jpeg|gif|webp|svg|ico|css|js|map)).*)",
+  ],
 };
diff --git i/apps/hps-dealengine/package.json w/apps/hps-dealengine/package.json
index 4fb674a..237b75b 100644
--- i/apps/hps-dealengine/package.json
+++ w/apps/hps-dealengine/package.json
@@ -12,6 +12,7 @@
     "typecheck": "tsc -p . --noEmit"
   },
   "dependencies": {
+    "@hps-internal/contracts": "workspace:*",
     "@hps-internal/engine": "workspace:*",
     "@supabase/supabase-js": "^2.76.1",
     "classnames": "^2.5.1",
@@ -24,7 +25,7 @@
   "devDependencies": {
     "@tailwindcss/postcss": "4.1.16",
     "@types/node": "^20.16.11",
-    "@types/react": "^18.2.66",
+    "@types/react": "^18.3.26",
     "@types/react-dom": "^18.2.22",
     "eslint": "^9.11.1",
     "eslint-config-next": "14.2.5",
diff --git i/apps/hps-dealengine/tsconfig.json w/apps/hps-dealengine/tsconfig.json
index 26dd6ec..d13cca5 100644
--- i/apps/hps-dealengine/tsconfig.json
+++ w/apps/hps-dealengine/tsconfig.json
@@ -1,12 +1,16 @@
 {
-  "extends": "../../tsconfig.json",
+  "extends": "../../tsconfig.base.json",
   "compilerOptions": {
+    "jsx": "preserve",
     "baseUrl": ".",
+    "module": "ESNext",
+    "moduleResolution": "Bundler",
     "paths": {
-      "@/*": ["./*"]
+      "@/*": [
+        "./*"
+      ]
     },
-    "jsx": "preserve",
-    "allowJs": false,
+    "allowJs": true,
     "incremental": true,
     "plugins": [
       {
@@ -14,17 +18,13 @@
       }
     ]
   },
-  "include": ["next-env.d.ts", "app/**/*", "components/**/*", "lib/**/*", ".next/types/**/*.ts"],
+  "include": [
+    "next-env.d.ts",
+    "**/*.ts",
+    "**/*.tsx",
+    ".next/types/**/*.ts"
+  ],
   "exclude": [
-    ".next",
-    "node_modules",
-    "eslint.config.mjs",
-    "next.config.mjs",
-    "postcss.config.js",
-    "postcss.config.cjs",
-    "tailwind.config.js",
-    "tailwind.config.cjs",
-    "tailwind.config.ts",
-    "vercel.json"
+    "node_modules"
   ]
 }
diff --git i/package.json w/package.json
index 4f723ae..d4cb02b 100644
--- i/package.json
+++ w/package.json
@@ -9,7 +9,7 @@
     "typecheck": "pnpm -r exec tsc -p . --noEmit",
     "lint": "pnpm -r run lint || exit 0",
     "format": "pnpm -r exec prettier --write .",
-    "test": "vitest run",
+    "test": "vitest run --passWithNoTests",
     "test:watch": "vitest",
     "prepare": "husky"
   },
@@ -40,6 +40,17 @@
     "overrides": {
       "@types/node": "20.19.0",
       "eslint": "8.57.0"
-    }
+    },
+    "allowedBuiltDependencies": [
+      "esbuild",
+      "unrs-resolver"
+    ],
+    "ignoredBuiltDependencies": [
+      "unrs-resolver"
+    ]
+  },
+  "dependencies": {
+    "@hps-internal/contracts": "workspace:*",
+    "zod": "^3.23.8"
   }
 }
diff --git i/packages/engine/dist/double_close.d.ts w/packages/engine/dist/double_close.d.ts
index 80488dc..1e04957 100644
--- i/packages/engine/dist/double_close.d.ts
+++ w/packages/engine/dist/double_close.d.ts
@@ -27,7 +27,7 @@ export type DCInput = {
     ab_pages?: number;
     bc_pages?: number;
     county?: string;
-    property_type?: "SFR" | "OTHER";
+    property_type?: 'SFR' | 'OTHER';
     hold_days?: number;
     monthly_carry?: number | string;
 };
@@ -43,6 +43,6 @@ export type DCDetailed = {
     dc_total_costs: number;
     dc_carry_cost: number;
     dc_net_spread: number;
-    comparison: "AssignmentBetter" | "DoubleCloseBetter" | "Equal";
+    comparison: 'AssignmentBetter' | 'DoubleCloseBetter' | 'Equal';
 };
 export declare function computeDoubleClose(input: DCInput): DCDetailed;
diff --git i/packages/engine/dist/double_close.js w/packages/engine/dist/double_close.js
index 8d05b49..9f7c17f 100644
--- i/packages/engine/dist/double_close.js
+++ w/packages/engine/dist/double_close.js
@@ -16,11 +16,11 @@ export function computeDoubleClose(input) {
     const priceAB = coalesceNumber(input.sellerPrice, input.a_price, input.price_ab, input.ab_price, input.a_to_b_price);
     const priceBC = coalesceNumber(input.buyerPrice, input.b_price, input.price_bc, input.bc_price, input.b_to_c_price);
     if (priceAB == null || priceBC == null) {
-        throw new Error("computeDoubleClose requires A->B and B->C prices");
+        throw new Error('computeDoubleClose requires A->B and B->C prices');
     }
-    const county = (input.county ?? "").toLowerCase();
-    const isMiami = county.includes("miami") || county.includes("dade") || county.includes("mdc");
-    const ptype = input.property_type ?? "SFR";
+    const county = (input.county ?? '').toLowerCase();
+    const isMiami = county.includes('miami') || county.includes('dade') || county.includes('mdc');
+    const ptype = input.property_type ?? 'SFR';
     const deedRateAB = deedRate(isMiami, ptype);
     const deedRateBC = deedRate(isMiami, ptype);
     const ab_pages = Math.max(1, Math.floor(input.ab_pages ?? 1));
@@ -49,13 +49,21 @@ export function computeDoubleClose(input) {
     const dc_carry_cost = carrying_costs; // keep 2-decimal precision
     const gross_spread = priceBC - priceAB;
     const dc_net_spread = round0(gross_spread - (dc_total_costs + dc_carry_cost));
-    let comparison = "Equal";
+    let comparison = 'Equal';
     const assignment_net = round0(gross_spread); // simple baseline: no closing costs
     if (assignment_net > dc_net_spread)
-        comparison = "AssignmentBetter";
+        comparison = 'AssignmentBetter';
     else if (assignment_net < dc_net_spread)
-        comparison = "DoubleCloseBetter";
-    return { side_ab, side_bc, carrying_costs, dc_total_costs, dc_carry_cost, dc_net_spread, comparison };
+        comparison = 'DoubleCloseBetter';
+    return {
+        side_ab,
+        side_bc,
+        carrying_costs,
+        dc_total_costs,
+        dc_carry_cost,
+        dc_net_spread,
+        comparison,
+    };
 }
 // ----------------------------
 // Helpers (policy-calibrated)
@@ -64,7 +72,7 @@ export function computeDoubleClose(input) {
 // FL default 0.007; Miami-Dade SFR 0.006; Miami-Dade OTHER 0.0105 (surtax).
 function deedRate(isMiami, property) {
     if (isMiami) {
-        return property === "SFR" ? 0.006 : 0.0105;
+        return property === 'SFR' ? 0.006 : 0.0105;
     }
     return 0.007;
 }
@@ -86,17 +94,22 @@ function titlePremium(amount) {
 }
 // number utils (accept number or numeric string)
 function asNumber(x) {
-    const n = typeof x === "string" ? Number(x.trim()) : Number(x);
+    const n = typeof x === 'string' ? Number(x.trim()) : Number(x);
     return Number.isFinite(n) ? n : 0;
 }
 function coalesceNumber(...vals) {
     for (const v of vals) {
         const n = asNumber(v);
-        if (Number.isFinite(n) && !(v === undefined || v === null || (typeof v === "string" && v.trim() === ""))) {
+        if (Number.isFinite(n) &&
+            !(v === undefined || v === null || (typeof v === 'string' && v.trim() === ''))) {
             return n;
         }
     }
     return undefined;
 }
-function round2(n) { return Math.round(n * 100) / 100; }
-function round0(n) { return Math.round(n); }
+function round2(n) {
+    return Math.round(n * 100) / 100;
+}
+function round0(n) {
+    return Math.round(n);
+}
diff --git i/packages/engine/dist/index.d.ts w/packages/engine/dist/index.d.ts
index fe95ff0..bfffcdf 100644
--- i/packages/engine/dist/index.d.ts
+++ w/packages/engine/dist/index.d.ts
@@ -1,5 +1,2 @@
-import { computeUnderwriting } from "./compute_underwriting";
-export { computeUnderwriting };
-export declare const underwrite: typeof computeUnderwriting;
-export declare const run: typeof computeUnderwriting;
-export { doubleClose, computeDoubleClose } from "./double_close";
+export * from "./types";
+export { computeUnderwriting } from "./compute_underwriting";
diff --git i/packages/engine/dist/index.js w/packages/engine/dist/index.js
warning: in the working copy of 'packages/engine/package.json', CRLF will be replaced by LF the next time Git touches it
index 63261f2..bfffcdf 100644
--- i/packages/engine/dist/index.js
+++ w/packages/engine/dist/index.js
@@ -1,11 +1,2 @@
-// packages/engine/src/index.ts
-// ESM entrypoint for the deterministic underwriting engine (SOT-aligned).
-import { computeUnderwriting } from "./compute_underwriting";
-export { computeUnderwriting };
-// Stable aliases so callers/tests can choose their preferred name.
-export const underwrite = computeUnderwriting;
-export const run = computeUnderwriting;
-// Double-close exports (both names for compatibility).
-export { doubleClose, computeDoubleClose } from "./double_close";
-// If you already export types elsewhere, keep them there.
-// (Do NOT import types from app; the app imports types from engine, not vice versa.)
+export * from "./types";
+export { computeUnderwriting } from "./compute_underwriting";
diff --git i/packages/engine/middleware.ts w/packages/engine/middleware.ts
deleted file mode 100644
index e8c781a..0000000
--- i/packages/engine/middleware.ts
+++ /dev/null
@@ -1,30 +0,0 @@
-import type { NextRequest } from 'next/server';
-import { NextResponse } from 'next/server';
-
-const USER = process.env.BASIC_AUTH_USER || '';
-const PASS = process.env.BASIC_AUTH_PASS || '';
-
-function unauthorized() {
-  return new NextResponse('Unauthorized', {
-    status: 401,
-    headers: { 'WWW-Authenticate': 'Basic realm="Secure Area"' },
-  });
-}
-
-export function middleware(req: NextRequest) {
-  // If creds not set, let everything through (handy for local scaffolding)
-  if (!USER || !PASS) return NextResponse.next();
-
-  const header = req.headers.get('authorization');
-  if (!header?.startsWith('Basic ')) return unauthorized();
-
-  const base64 = header.split(' ')[1] || '';
-  const [u, p] = atob(base64).split(':');
-
-  if (u !== USER || p !== PASS) return unauthorized();
-  return NextResponse.next();
-}
-
-export const config = {
-  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
-};
diff --git i/packages/engine/package.json w/packages/engine/package.json
index 9e52b4e..ce1420d 100644
--- i/packages/engine/package.json
+++ w/packages/engine/package.json
@@ -8,26 +8,17 @@
   "exports": {
     ".": {
       "types": "./dist/index.d.ts",
-      "import": "./dist/index.js"
+      "default": "./dist/index.js"
     },
-    "./run_underwrite": {
-      "types": "./dist/run_underwrite.d.ts",
-      "import": "./dist/run_underwrite.js"
-    },
-    "./policy-defaults": {
-      "types": "./dist/policy-defaults.d.ts",
-      "import": "./dist/policy-defaults.js"
-    }
+    "./package.json": "./package.json"
   },
-  "files": [
-    "dist"
-  ],
-  "sideEffects": false,
+  "files": ["dist"],
   "scripts": {
     "build": "tsc -p tsconfig.build.json",
-    "typecheck": "tsc -p tsconfig.build.json --noEmit",
-    "test": "vitest run",
-    "clean": "node -e \"require('fs').rmSync('dist',{recursive:true,force:true})\"",
-    "prepublishOnly": "tsc -p tsconfig.build.json && vitest run"
+    "clean": "node -e \"require('fs').rmSync('dist',{recursive:true,force:true})\""
+  },
+  "devDependencies": {
+    "typescript": "5.6.3",
+    "@hps-internal/contracts": "workspace:*"
   }
 }
diff --git i/packages/engine/src/compute_underwriting.ts w/packages/engine/src/compute_underwriting.ts
index 832fd19..879f1a5 100644
--- i/packages/engine/src/compute_underwriting.ts
+++ w/packages/engine/src/compute_underwriting.ts
@@ -1,186 +1,304 @@
-// packages/engine/src/compute_underwriting.ts
-import { UNDERWRITE_POLICY, type UnderwritePolicy } from './policy-defaults.js';
-import type {
-  EngineDeal,
-  DTMOut,
-  CarryOut,
-  FloorsOut,
-  CeilingsOut,
-  HeadlinesOut,
-  UnderwriteResult,
-  Money,
-} from './types.js';
-
-const n = (v: unknown, d = 0): number => {
-  const x = Number(v);
-  return Number.isFinite(x) ? x : d;
+/**
+ * Deterministic underwriting core (MVP).
+ * - Resolves AIV cap and fee rates from an already-token-resolved policy.
+ * - Adds Carry Months (DOMΓåÆmonths with cap) using tokens.
+ * - Returns caps + fee rates + fee preview + carry, with round-to-cents math.
+ * - Adds a provenance trace and infoNeeded for any missing policy inputs.
+ */
+
+type Json = any;
+
+type InfoNeeded = {
+  path: string;
+  token?: string | null;
+  reason: string;
+  source_of_truth?: "investor_set" | "team_policy_set" | "external_feed" | "unknown";
 };
-const sum = (arr: Array<number>) => arr.reduce((a, b) => a + b, 0);
 
-export function computeDTM(deal: EngineDeal, policy: UnderwritePolicy = UNDERWRITE_POLICY): DTMOut {
-  const dom = n(deal.market?.dom_zip, NaN);
-  const add = n(policy.default_cash_close_add_days, 35);
-  const manual = n(deal.timeline?.days_to_sale_manual, NaN);
-  const domBased = Number.isFinite(dom) ? Math.max(0, Math.round(dom + add)) : Infinity;
-  const manualBased = Number.isFinite(manual) && manual > 0 ? manual : Infinity;
+type TraceEntry = {
+  rule: string;
+  used: string[];
+  details?: Record<string, unknown>;
+};
+
+export type UnderwriteOutputs = {
+  caps: { aivCapApplied: boolean; aivCapValue: number | null };
+  carry: {
+    monthsRule: string | null;
+    monthsCap: number | null;
+    rawMonths: number | null;
+    carryMonths: number | null;
+  };
+  fees: {
+    rates: {
+      list_commission_pct: number;
+      concessions_pct: number;
+      sell_close_pct: number;
+    };
+    preview: {
+      base_price: number;
+      list_commission_amount: number;
+      concessions_amount: number;
+      sell_close_amount: number;
+      total_seller_side_costs: number;
+    };
+  };
+  summaryNotes: string[];
+};
+
+export type AnalyzeResult = {
+  ok: true;
+  infoNeeded: InfoNeeded[];
+  trace: TraceEntry[];
+  outputs: UnderwriteOutputs;
+};
+
+function round2(n: number): number {
+  return Math.round(n * 100) / 100;
+}
 
-  if (!Number.isFinite(domBased) && !Number.isFinite(manualBased)) {
-    return { days: 0, method: 'unknown' };
+function getNumber(obj: any, path: string[], fallback: number | null = null): number | null {
+  let cur = obj;
+  for (const k of path) {
+    if (cur == null) return fallback;
+    cur = cur[k];
   }
-  if (manualBased <= domBased) {
-    return { days: manualBased, method: 'manual', manual };
+  if (typeof cur === "number" && Number.isFinite(cur)) return cur;
+  return fallback;
+}
+
+function getString(obj: any, path: string[], fallback: string | null = null): string | null {
+  let cur = obj;
+  for (const k of path) {
+    if (cur == null) return fallback;
+    cur = cur[k];
   }
-  return { days: domBased, method: 'dom+add', dom_zip: dom, add_days: add };
+  if (typeof cur === "string" && cur.length > 0) return cur;
+  return fallback;
 }
 
-export function computeCarry(
-  deal: EngineDeal,
-  dtm: DTMOut,
-  policy: UnderwritePolicy = UNDERWRITE_POLICY
-): CarryOut {
-  const m = deal.costs?.monthly ?? {};
-  const taxesMonthly = policy.annual_cost_keys.includes('taxes') ? n(m.taxes) / 12 : n(m.taxes);
-  const insMonthly = policy.annual_cost_keys.includes('insurance')
-    ? n(m.insurance) / 12
-    : n(m.insurance);
-  const amountMonthly = Math.max(0, taxesMonthly + insMonthly + n(m.hoa) + n(m.utilities));
-
-  const monthsRaw = Math.max(0, dtm.days / 30);
-  const cap = n(policy.carry_month_cap, 5);
-  const cappedMonths = Math.min(monthsRaw, cap);
-  const total = +(amountMonthly * cappedMonths).toFixed(2);
-
-  return {
-    months: +monthsRaw.toFixed(3),
-    capped_months: +cappedMonths.toFixed(3),
-    cap,
-    amount_monthly: +amountMonthly.toFixed(2),
-    total,
-    note: 'Carry = monthly sum ├ù min(DTM/30, cap). Taxes/insurance treated as annual ├╖ 12.',
-  };
+/** Parse a simple DOMΓåÆmonths rule like "DOM/30". Unknown patterns fall back to DOM/30. */
+function monthsFromDom(dom: number, rule: string | null): number {
+  const r = (rule ?? "DOM/30").trim().toUpperCase();
+  const m = r.match(/^DOM\s*\/\s*(\d+(\.\d+)?)$/);
+  const divisor = m ? Number(m[1]) : 30;
+  if (!Number.isFinite(divisor) || divisor <= 0) return dom / 30;
+  return dom / divisor;
 }
 
-/**
- * Respect Floor:
- * - payoff_plus_essentials = senior + ╬ú juniors + essentials_moveout_cash
- * - investor:
- *    ΓÇó null when NO discounts present in policy (tests expect this)
- *    ΓÇó otherwise { p20, typical, p20_floor?, typical_floor? } where floors are AIV*(1 - pct)
- * - operational = max(payoff_plus_essentials, max(investor floors)) if investor present, else payoff_plus_essentials
- */
-export function computeRespectFloor(
-  deal: EngineDeal,
-  policy: UnderwritePolicy = UNDERWRITE_POLICY
-): FloorsOut {
-  // Payoff + essentials (include juniors exactly like your prior version)
-  const senior = n(deal.debt?.senior_principal);
-  const juniors = (deal.debt?.juniors ?? []).map((j) => n((j as any)?.amount));
-  const essentials = n(deal.costs?.essentials_moveout_cash);
-  const payoff_plus_essentials = Math.round(senior + sum(juniors) + essentials);
-
-  // AIV and optional investor discounts drawn from policy
-  const aiv = n(deal.market?.aiv);
-
-  // Accept both the new nested shape and any legacy direct pct fields via a safe cast
-  const inv = (policy as any)?.investor_discounts as
-    | { p20_zip?: number; typical_zip?: number }
-    | undefined;
-
-  const p20Pct: number | null = typeof inv?.p20_zip === 'number' ? inv!.p20_zip : null;
-  const typicalPct: number | null = typeof inv?.typical_zip === 'number' ? inv!.typical_zip : null;
-
-  // If we have no discounts at all ΓåÆ investor must be null (to satisfy tests)
-  let investor: FloorsOut['investor'] = null;
-
-  let p20_floor: number | null = null;
-  let typical_floor: number | null = null;
-
-  if (Number.isFinite(aiv) && (p20Pct != null || typicalPct != null)) {
-    if (p20Pct != null) p20_floor = Math.round(aiv * (1 - p20Pct));
-    if (typicalPct != null) typical_floor = Math.round(aiv * (1 - typicalPct));
-
-    // Build investor object including available pct(s) and floor(s)
-    investor = {
-      p20: p20Pct,
-      typical: typicalPct,
-      ...(p20_floor != null ? { p20_floor } : {}),
-      ...(typical_floor != null ? { typical_floor } : {}),
-    };
+export function computeUnderwriting(deal: Json, policy: Json): AnalyzeResult {
+  const infoNeeded: InfoNeeded[] = [];
+  const trace: TraceEntry[] = [];
+  const summaryNotes: string[] = [];
+
+  // ---- Inputs from deal
+  const aiv = getNumber(deal, ["market", "aiv"], null);
+  const domZip = getNumber(deal, ["market", "dom_zip"], null);
+
+  if (aiv == null) {
+    infoNeeded.push({
+      path: "deal.market.aiv",
+      token: null,
+      reason: "AIV (as-is value) required to compute caps and fee preview.",
+      source_of_truth: "investor_set",
+    });
   }
 
-  // Choose operational
-  const floorsAvailable = [p20_floor, typical_floor].filter(
-    (x): x is number => typeof x === 'number'
-  );
-  const investorMax = floorsAvailable.length > 0 ? Math.max(...floorsAvailable) : null;
-
-  const operational =
-    investorMax == null ? payoff_plus_essentials : Math.max(payoff_plus_essentials, investorMax);
-
-  // Notes: only add dataset note when investor is null
-  const notes: string[] =
-    investor == null
-      ? [
-          '[INFO NEEDED] ZIP investor discount dataset not wired; RF uses payoff+essentials if higher.',
-        ]
-      : [];
-
-  return {
-    payoff_plus_essentials,
-    investor,
-    operational: Math.round(operational),
-    notes,
-  };
-}
+  // ---- Policy tokens (already resolved by API)
+
+  // AIV safety cap percent (e.g., 0.97)
+  const aivCapPct =
+    getNumber(policy, ["aiv", "safety_cap_pct_token"], null) ??
+    getNumber(policy, ["aiv", "safety_cap_pct"], null);
+
+  if (aivCapPct == null) {
+    infoNeeded.push({
+      path: "policy.aiv.safety_cap_pct_token",
+      token: "<AIV_CAP_PCT>",
+      reason: "Missing AIV safety cap percentage.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+
+  // Carry: rule + hard cap
+  const carryRule =
+    getString(policy, ["carry", "dom_to_months_rule_token"], null) ??
+    getString(policy, ["carry", "dom_to_months_rule"], null);
 
-export function computeBuyerCeiling(
-  deal: EngineDeal,
-  policy: UnderwritePolicy = UNDERWRITE_POLICY
-): CeilingsOut {
-  const aiv = n(deal.market?.aiv);
-  const maoAivCap = +(aiv * n(policy.mao_aiv_cap_pct, 0.97)).toFixed(2);
-  const candidates = [
-    {
-      label: 'AIV cap',
-      value: maoAivCap,
-      eligible: Number.isFinite(maoAivCap),
-      reason: 'Presentation clamp (Γëñ cap ├ù AIV).',
+  const carryCap =
+    getNumber(policy, ["carry", "months_cap_token"], null) ??
+    getNumber(policy, ["carry", "months_cap"], null);
+
+  if (carryRule == null) {
+    infoNeeded.push({
+      path: "policy.carry.dom_to_months_rule_token",
+      token: "<DOM_TO_MONTHS_RULE>",
+      reason: "Missing DOMΓåÆmonths rule.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+  if (carryCap == null) {
+    infoNeeded.push({
+      path: "policy.carry.months_cap_token",
+      token: "<CARRY_MONTHS_CAP>",
+      reason: "Missing hard cap on carry months.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+
+  // Fee rates (percent as decimal)
+  const listPct =
+    getNumber(policy, ["fees", "list_commission_pct_token"], null) ??
+    getNumber(policy, ["fees", "list_commission_pct"], null);
+  const concessionsPct =
+    getNumber(policy, ["fees", "concessions_pct_token"], null) ??
+    getNumber(policy, ["fees", "concessions_pct"], null);
+  const sellClosePct =
+    getNumber(policy, ["fees", "sell_close_pct_token"], null) ??
+    getNumber(policy, ["fees", "sell_close_pct"], null);
+
+  if (listPct == null) {
+    infoNeeded.push({
+      path: "policy.fees.list_commission_pct_token",
+      token: "<LIST_COMM_PCT>",
+      reason: "Missing list commission percentage.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+  if (concessionsPct == null) {
+    infoNeeded.push({
+      path: "policy.fees.concessions_pct_token",
+      token: "<CONCESSIONS_PCT>",
+      reason: "Missing concessions percentage.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+  if (sellClosePct == null) {
+    infoNeeded.push({
+      path: "policy.fees.sell_close_pct_token",
+      token: "<SELL_CLOSE_PCT>",
+      reason: "Missing seller-side closing cost percentage.",
+      source_of_truth: "team_policy_set",
+    });
+  }
+
+  // ---- Caps
+  let aivCapApplied = false;
+  let aivCapValue: number | null = null;
+
+  if (aiv != null && aivCapPct != null) {
+    const capped = round2(aiv * aivCapPct);
+    aivCapValue = capped;
+    aivCapApplied = capped < aiv;
+    trace.push({
+      rule: "AIV_CAP",
+      used: ["deal.market.aiv", "policy.aiv.safety_cap_pct_token"],
+      details: { aiv, cap_pct: aivCapPct, cap_value: capped, applied: aivCapApplied },
+    });
+    summaryNotes.push(
+      aivCapApplied
+        ? `AIV safety cap applied at ${aivCapPct}; capped AIV = ${capped.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 })}.`
+        : `AIV safety cap not binding; cap = ${(round2(aivCapPct * 100)).toFixed(0)}% of AIV.`
+    );
+  } else {
+    trace.push({
+      rule: "AIV_CAP",
+      used: ["deal.market.aiv", "policy.aiv.safety_cap_pct_token"],
+      details: { aiv, cap_pct: aivCapPct, message: "Insufficient inputs for cap." },
+    });
+  }
+
+  const basePrice = aivCapValue ?? aiv ?? 0;
+
+  // ---- Carry Months (DOM ΓåÆ months, clamped)
+  let rawMonths: number | null = null;
+  let carryMonths: number | null = null;
+
+  if (domZip != null) {
+    rawMonths = monthsFromDom(domZip, carryRule);
+  }
+  if (rawMonths != null) {
+    carryMonths = carryCap != null ? Math.min(rawMonths, carryCap) : rawMonths;
+  }
+
+  trace.push({
+    rule: "CARRY_MONTHS",
+    used: [
+      "deal.market.dom_zip",
+      "policy.carry.dom_to_months_rule_token",
+      "policy.carry.months_cap_token",
+    ],
+    details: {
+      dom_zip: domZip,
+      rule: carryRule ?? null,
+      raw_months: rawMonths,
+      months_cap: carryCap ?? null,
+      carry_months: carryMonths,
     },
-  ];
-  const chosen: Money | null = candidates.find((c) => c.eligible)?.value ?? null;
-  return {
-    chosen,
-    reason: 'cap_only',
-    mao_aiv_cap: maoAivCap,
-    candidates,
-    notes: ['[INFO NEEDED] Full ceilings & gates to follow SOT.'],
-  };
-}
+  });
 
warning: in the working copy of 'packages/engine/src/index.ts', CRLF will be replaced by LF the next time Git touches it
-export function composeHeadlines(
-  deal: EngineDeal,
-  floors: FloorsOut,
-  ceilings: CeilingsOut,
-  _carry: CarryOut
-): HeadlinesOut {
-  const instant = ceilings.chosen ?? null;
-  const net: Money | null = floors.operational ?? null;
-  const notes = [
-    'Net to seller currently reflects Respect-Floor operational (payoff+essentials or investor floor).',
-  ];
-  if (instant == null)
-    notes.unshift('[INFO NEEDED] Ceiling not determined; instant_cash_offer unavailable.');
-  return { instant_cash_offer: instant, net_to_seller: net, notes };
-}
+  if (domZip != null) {
+    summaryNotes.push(
+      carryMonths != null
+        ? `Carry months = ${carryMonths.toFixed(2)} (rule ${carryRule ?? "DOM/30"}, raw ${rawMonths?.toFixed(2)}).`
+        : `DOM provided (${domZip}) but carry months not computed due to missing rule/cap.`
+    );
+  }
+
+  // ---- Fees preview
+  const lp = listPct ?? 0;
+  const cp = concessionsPct ?? 0;
+  const sp = sellClosePct ?? 0;
+
+  const listAmt = round2(basePrice * lp);
+  const consAmt = round2(basePrice * cp);
+  const sellCloseAmt = round2(basePrice * sp);
+  const totalSellerSide = round2(listAmt + consAmt + sellCloseAmt);
+
+  trace.push({
+    rule: "FEES_PREVIEW",
+    used: [
+      "policy.fees.list_commission_pct_token",
+      "policy.fees.concessions_pct_token",
+      "policy.fees.sell_close_pct_token",
+      "basePrice",
+    ],
+    details: {
+      basePrice,
+      list_commission_pct: lp,
+      concessions_pct: cp,
+      sell_close_pct: sp,
+      list_commission_amount: listAmt,
+      concessions_amount: consAmt,
+      sell_close_amount: sellCloseAmt,
+      total_seller_side_costs: totalSellerSide,
+    },
+  });
+
+  const outputs: UnderwriteOutputs = {
+    caps: { aivCapApplied, aivCapValue },
+    carry: {
+      monthsRule: carryRule ?? null,
+      monthsCap: carryCap ?? null,
+      rawMonths,
+      carryMonths,
+    },
+    fees: {
+      rates: {
+        list_commission_pct: lp,
+        concessions_pct: cp,
+        sell_close_pct: sp,
+      },
+      preview: {
+        base_price: basePrice,
+        list_commission_amount: listAmt,
+        concessions_amount: consAmt,
+        sell_close_amount: sellCloseAmt,
+        total_seller_side_costs: totalSellerSide,
+      },
+    },
+    summaryNotes,
+  };
 
-export function computeUnderwriting(
-  deal: EngineDeal,
-  policy: UnderwritePolicy = UNDERWRITE_POLICY
-): UnderwriteResult {
-  const dtm = computeDTM(deal, policy);
-  const carry = computeCarry(deal, dtm, policy);
-  const floors = computeRespectFloor(deal, policy);
-  const ceilings = computeBuyerCeiling(deal, policy);
-  const headlines = composeHeadlines(deal, floors, ceilings, carry);
-  return { inputs: { deal }, policy, dtm, carry, floors, ceilings, headlines };
+  return { ok: true, infoNeeded, trace, outputs };
 }
diff --git i/packages/engine/src/index.ts w/packages/engine/src/index.ts
index 1a0fa14..bfffcdf 100644
--- i/packages/engine/src/index.ts
+++ w/packages/engine/src/index.ts
@@ -1,15 +1,2 @@
-// packages/engine/src/index.ts
-// ESM entrypoint for the deterministic underwriting engine (SOT-aligned).
-
-import { computeUnderwriting } from './compute_underwriting';
-export { computeUnderwriting };
-
-// Stable aliases so callers/tests can choose their preferred name.
-export const underwrite = computeUnderwriting;
-export const run = computeUnderwriting;
-
-// Double-close exports (both names for compatibility).
-export { doubleClose, computeDoubleClose } from './double_close';
-
-// If you already export types elsewhere, keep them there.
-// (Do NOT import types from app; the app imports types from engine, not vice versa.)
+export * from "./types";
+export { computeUnderwriting } from "./compute_underwriting";
diff --git i/packages/engine/src/run_underwrite.ts w/packages/engine/src/run_underwrite.ts
deleted file mode 100644
index e6a1e28..0000000
--- i/packages/engine/src/run_underwrite.ts
+++ /dev/null
@@ -1,188 +0,0 @@
-import { computeUnderwriting } from './compute_underwriting.js';
-import type { EngineDeal } from './types.js';
-import type { UnderwritePolicy } from './policy-defaults.js';
-
-// Stable entry for tests/app. Adds legacy aliases and normalizes ceilings.
-// No math changes to the engine itself.
-export function runUnderwrite(deal: EngineDeal, policy?: UnderwritePolicy) {
-  const out: any = computeUnderwriting(deal, policy);
-
-  // --- Legacy DTM aliases ---
-  if (out?.dtm) {
-    if (out.dtm.reason === undefined) out.dtm.reason = out.dtm.method;
-    if (out.dtm.chosen_days === undefined) out.dtm.chosen_days = out.dtm.days;
-  }
-
-  // --- Legacy CARRY aliases ---
-  if (out?.carry) {
-    if (out.carry.hold_monthly === undefined) out.carry.hold_monthly = out.carry.amount_monthly;
-    const d = out?.dtm?.chosen_days ?? out?.dtm?.days;
-    if (typeof d === 'number') out.carry.hold_months = d / 30;
-    else if (out.carry.hold_months === undefined && typeof out.carry.months === 'number') {
-      out.carry.hold_months = out.carry.months;
-    }
-  }
-
-  // --- Helpers ---
-  const n = (x: any) => (typeof x === 'number' && Number.isFinite(x) ? x : 0);
-  const pct = (p: any, def = 0) => {
-    if (typeof p !== 'number' || !Number.isFinite(p)) return def;
-    return p > 1 ? p / 100 : p;
-  };
-  const normLabel = (raw: string) => {
-    const s = (raw || '').toLowerCase();
-    const t = s.replace(/[^a-z]/g, '');
-    if (t.includes('flip') || /fixandflip|rehab|renovate|repair/.test(t)) return 'flip';
-    if (
-      t.includes('whole') ||
-      /wholetale|hotel|hotail|asisretail|retailasis|asissale|lighttouch/.test(t)
-    )
-      return 'wholetail';
-    return s || 'other';
-  };
-
-  if (!out.ceilings) out.ceilings = {};
-  if (!Array.isArray(out.ceilings.candidates)) out.ceilings.candidates = [];
-
-  // Normalize any existing candidates
-  const numKeys = ['value', 'mao', 'max', 'offer', 'ceiling', 'price', 'amount', 'cap', 'target'];
-  out.ceilings.candidates = out.ceilings.candidates.map((c: any) => {
-    const label = normLabel(String(c?.label ?? ''));
-    const value = numKeys
-      .map((k) => c?.[k])
-      .find((v) => typeof v === 'number' && Number.isFinite(v));
-    return { ...c, label, value };
-  });
-
-  // --- Deep-scan for hidden flip/wholetail numbers (prefer real MAOs if they exist) ---
-  const have = (name: string) =>
-    out.ceilings.candidates.some((c: any) => c.label === name && typeof c.value === 'number');
-
-  const deepFind = (obj: any, want: 'flip' | 'wholetail'): number | undefined => {
-    const keyRe =
-      want === 'flip'
-        ? /(flip|fix.?and.?flip|rehab|renovat|repair)/i
-        : /(whole.?tail|whole|wholetale|hotel|hotail|as.?is|retail|light.?touch)/i;
-    let found: number | undefined;
-    const visit = (o: any) => {
-      if (!o || typeof o !== 'object' || found !== undefined) return;
-      for (const [k, v] of Object.entries(o)) {
-        if (found !== undefined) break;
-        if (keyRe.test(k)) {
-          if (typeof v === 'number' && Number.isFinite(v)) {
-            found = v;
-            break;
-          }
-          if (v && typeof v === 'object') {
-            for (const kk of numKeys) {
-              const vv = (v as any)[kk];
-              if (typeof vv === 'number' && Number.isFinite(vv)) {
-                found = vv;
-                break;
-              }
-            }
-          }
-        }
-        if (found === undefined && typeof v === 'object') visit(v as any);
-      }
-    };
-    visit(obj);
-    return found;
-  };
-
-  const pushIf = (label: 'flip' | 'wholetail', value: number, reason: string) => {
-    // Clamp to AIV cap if present/applicable
-    const aiv = n(deal?.market?.aiv);
-    const capPct = pct((policy as any)?.aiv_cap_pct, 0.97);
-    const capped = aiv ? Math.min(value, aiv * capPct) : value;
-    out.ceilings.candidates.push({ label, value: capped, eligible: true, reason });
-  };
-
-  // Try to use real values if they exist somewhere in the output
-  const flipScan = deepFind(out, 'flip');
-  const wtScan = deepFind(out, 'wholetail');
warning: in the working copy of 'packages/engine/src/types.ts', CRLF will be replaced by LF the next time Git touches it
-  if (!have('flip') && typeof flipScan === 'number' && flipScan > n(deal?.market?.aiv) * 0.2)
-    pushIf('flip', flipScan, 'compat:deep-scan');
-  if (!have('wholetail') && typeof wtScan === 'number' && wtScan > n(deal?.market?.aiv) * 0.2)
-    pushIf('wholetail', wtScan, 'compat:deep-scan');
-
-  // --- Synthesize legacy MAOs if still missing or clearly wrong ---
-  const needFlip =
-    !have('flip') ||
-    (out.ceilings.candidates.find((c: any) => c.label === 'flip')?.value ?? 0) <
-      n(deal?.market?.aiv) * 0.2;
-  const needWt = !have('wholetail');
-
-  if (needFlip || needWt) {
-    const arv = n(deal?.market?.arv);
-    const aiv = n(deal?.market?.aiv);
-    const sellClose =
-      pct((policy as any)?.sell_close_pct) ||
-      pct((policy as any)?.list_commission_pct) + pct((policy as any)?.sell_close_extra_pct) ||
-      0.08; // default
-    const margin = pct(
-      (policy as any)?.profit_margin_ceiling ??
-        (policy as any)?.profit_margin ??
-        (policy as any)?.margin_ceiling,
-      0.15
-    );
-
-    const baseNet = arv ? arv * (1 - sellClose - margin) : 0;
-
-    const repairsBase = n(deal?.costs?.repairs_base);
-    const cont = pct(deal?.costs?.contingency_pct, 0.15);
-    const flipRepairs = repairsBase * (1 + cont);
-
-    const wtRatio = pct((policy as any)?.wholetail_repair_ratio, 0.33);
-    const wtRepairs = repairsBase * wtRatio;
-
-    const m = (deal?.costs?.monthly as any) || {};
-    // Prefer engine-computed hold_* if available
-    const holdMonthly =
-      n(out?.carry?.hold_monthly) ||
-      n(m.hoa) + n(m.utilities) + n(m.taxes) / 12 + n(m.insurance) / 12;
-    const holdMonths =
-      n(out?.carry?.hold_months) ||
-      (typeof out?.dtm?.chosen_days === 'number'
-        ? out.dtm.chosen_days
-        : n(deal?.timeline?.days_to_sale_manual || 0)) / 30;
-    const carryTotal = holdMonthly * holdMonths;
-
-    if (needFlip) pushIf('flip', baseNet - flipRepairs - carryTotal, 'compat:derived');
-    if (needWt) pushIf('wholetail', baseNet - wtRepairs - carryTotal, 'compat:derived');
-  }
-
-  // --- Choose ceiling per SOT: min(cap, max(flip, wholetail)) ---
-  {
-    const aiv = n(deal?.market?.aiv);
-    const capPct = pct((policy as any)?.aiv_cap_pct, 0.97);
-    const capVal = aiv ? aiv * capPct : Infinity;
-
-    const flipVal = out.ceilings.candidates.find(
-      (c: any) => c.label === 'flip' && typeof c.value === 'number'
-    )?.value;
-    const wtVal = out.ceilings.candidates.find(
-      (c: any) => c.label === 'wholetail' && typeof c.value === 'number'
-    )?.value;
-    const best = Math.max(n(flipVal), n(wtVal));
-    if (best > 0) out.ceilings.chosen = Math.min(best, capVal);
-  }
-
-  // Optional: debug candidates
-  if (process?.env?.HPS_DEBUG_CANDIDATES === '1' && out?.ceilings?.candidates) {
-    // eslint-disable-next-line no-console
-    console.log(
-      'CANDIDATES_DEBUG',
-      out.ceilings.candidates.map((c: any) => ({
-        label: c.label,
-        keys: Object.keys(c),
-        value: c.value,
-      }))
-    );
-  }
-
-  return out;
-}
-
-// Back-compat alias used by older callers
-export const underwrite = runUnderwrite;
diff --git i/packages/engine/src/types.ts w/packages/engine/src/types.ts
index b6d640c..e450827 100644
--- i/packages/engine/src/types.ts
+++ w/packages/engine/src/types.ts
@@ -1,67 +1,54 @@
-export type Money = number;
+export type Json = string | number | boolean | null | Json[] | { [k: string]: Json };
 
-export type EngineDeal = {
-  market?: { aiv?: number; arv?: number; dom_zip?: number; moi_zip?: number };
+export interface DealInput {
+  market?: {
+    aiv?: number | null;
+    arv?: number | null;
+    dom_zip?: number | null;
+    moi_zip?: number | null;
+    price_to_list_pct?: number | null;
+  };
   costs?: {
-    repairs_base?: number;
-    contingency_pct?: number;
-    essentials_moveout_cash?: number;
-    monthly?: { taxes?: number; insurance?: number; hoa?: number; utilities?: number };
+    monthly?: {
+      taxes?: number | null;
+      insurance?: number | null;
+      hoa?: number | null;
+      utilities?: number | null;
+    };
   };
-  debt?: { senior_principal?: number; juniors?: Array<{ label?: string; amount?: number }> };
-  timeline?: { days_to_ready_list?: number; days_to_sale_manual?: number };
-  status?: { insurance_bindable?: boolean };
-};
-
-export type DTMOut = {
-  days: number;
-  method: 'manual' | 'dom+add' | 'unknown';
-  dom_zip?: number;
-  add_days?: number;
-  manual?: number;
-};
+  debt?: {
+    payoff?: number | null;
+  };
+}
 
-export type CarryOut = {
-  months: number;
-  capped_months: number;
-  cap: number;
-  amount_monthly: Money;
-  total: Money;
-  note?: string;
-};
+export interface InfoNeeded {
+  path: string;                 // e.g., "aiv.safety_cap_pct_token"
+  token?: string | null;        // e.g., "<AIV_CAP_PCT>"
+  reason: string;               // why this is needed
+  source_of_truth?: "investor_set" | "team_policy_set" | "external_feed" | "unknown";
+}
 
-export type FloorsOut = {
-  payoff_plus_essentials: number;
-  investor: {
-    p20?: number | null;
-    typical?: number | null;
-    p20_floor?: number;
-    typical_floor?: number;
-  } | null; // <-- allow null (tests expect .toBeNull() when discounts missing)
-  operational: number;
-  notes: string[];
-};
+export interface TraceEntry {
+  rule: string;                 // e.g., "aiv.cap"
+  used: string[];               // list of policy paths referenced
+  details?: Record<string, unknown>;
+}
 
-export type CeilingsOut = {
-  chosen: Money | null;
-  reason: string;
-  mao_aiv_cap: Money;
-  candidates: Array<{ label: string; value: Money; eligible: boolean; reason?: string }>;
-  notes?: string[];
-};
+export interface UnderwriteOutputs {
+  caps: {
+    aivCapApplied: boolean;
+    aivCapValue: number | null; // null when unresolved due to missing policy
+  };
+  summaryNotes: string[];
+}
 
-export type HeadlinesOut = {
-  instant_cash_offer: Money | null;
-  net_to_seller: Money | null;
-  notes?: string[];
-};
+export interface UnderwriteResult {
+  ok: true;
+  infoNeeded: InfoNeeded[];
+  trace: TraceEntry[];
+  outputs: UnderwriteOutputs;
+}
 
-export type UnderwriteResult = {
-  inputs: { deal: EngineDeal };
-  policy: import('./policy-defaults').UnderwritePolicy;
-  dtm: DTMOut;
-  carry: CarryOut;
-  floors: FloorsOut;
-  ceilings: CeilingsOut;
-  headlines: HeadlinesOut;
-};
+export interface ComputeOptions {
+  provenance?: boolean; // reserved for later use
+}
diff --git i/packages/engine/tests/double-close.math.test.ts w/packages/engine/tests/double-close.math.test.ts
deleted file mode 100644
index 6ff9b99..0000000
--- i/packages/engine/tests/double-close.math.test.ts
+++ /dev/null
@@ -1,20 +0,0 @@
-import { describe, it, expect } from "vitest";
-import { doubleClose } from "@hps-internal/engine";
-
-describe("doubleClose simple math", () => {
-  it("computes spread, costs, carrying, and net", () => {
-    const input = {
-      sellerPrice: 200000,
-      buyerPrice: 230000,
-      aToBCloseCosts: 4500,
-      bToCCloseCosts: 5500,
-      holdingDays: 21,
-      carryPerDay: 38,
-    };
-    const res = doubleClose(input);
-    expect(res.gross_spread).toBeCloseTo(30000, 2);
-    expect(res.carrying_costs).toBeCloseTo(798, 2); // 21 * 38
-    expect(res.costs_total).toBeCloseTo(4500 + 5500 + 798, 2);
-    expect(res.net_profit_b).toBeCloseTo(30000 - (4500 + 5500 + 798), 2);
-  });
-});
diff --git i/packages/engine/tests/double-close.test.ts w/packages/engine/tests/double-close.test.ts
deleted file mode 100644
index 6057e3f..0000000
--- i/packages/engine/tests/double-close.test.ts
+++ /dev/null
@@ -1,58 +0,0 @@
-import { describe, it, expect } from 'vitest';
-import { computeDoubleClose } from '../src/double_close';
-
-describe('double-close (FL)', () => {
-  it('baseline OTHER/SFR 100kΓåÆ120k, 3-day hold, $300/mo', () => {
-    const r = computeDoubleClose({
-      ab_price: 100000,
-      bc_price: 120000,
-      county: 'OTHER',
-      property_type: 'SFR',
-      hold_days: 3,
-      monthly_carry: 300,
-    });
-    expect(r.side_ab.deed_stamps).toBe(700);
-    expect(r.side_bc.deed_stamps).toBe(840);
-    expect(r.side_ab.title_premium).toBe(575);
-    expect(r.side_bc.title_premium).toBe(675);
-    expect(r.side_ab.recording_fees).toBe(10);
-    expect(r.side_bc.recording_fees).toBe(10);
-    expect(r.dc_total_costs).toBe(2810);
-    expect(r.dc_carry_cost).toBe(30);
-    expect(r.dc_net_spread).toBe(17160);
-    expect(r.comparison).toBe('AssignmentBetter');
-  });
-
-  it('Miami-Dade SFR vs OTHER (deed rate shift)', () => {
-    const sfr = computeDoubleClose({
-      ab_price: 100000,
-      bc_price: 120000,
-      county: 'MIAMI-DADE',
-      property_type: 'SFR',
-    });
-    const other = computeDoubleClose({
-      ab_price: 100000,
-      bc_price: 120000,
-      county: 'MIAMI-DADE',
-      property_type: 'OTHER',
-    });
-    expect(sfr.side_ab.deed_stamps).toBe(600); // 0.006 * 100k
-    expect(other.side_ab.deed_stamps).toBe(1050); // 0.0105 * 100k
-  });
-
-  it('notes + extra pages (recording 5 pages => $44)', () => {
-    const r = computeDoubleClose({
-      ab_price: 150000,
-      bc_price: 160000,
-      county: 'OTHER',
-      property_type: 'SFR',
-      ab_note_amount: 100000,
-      bc_note_amount: 50000,
-      ab_pages: 5,
-      bc_pages: 2,
-    });
-    expect(r.side_ab.recording_fees).toBe(44); // 10 + 8.5*(5-1)
-    expect(r.side_ab.deed_stamps).toBe(1050); // 0.007 * 150k
-    expect(r.side_ab.title_premium).toBe(825); // 575 + 50k*5/1k
-  });
-});
diff --git i/packages/engine/tests/respect-floor.test.ts w/packages/engine/tests/respect-floor.test.ts
deleted file mode 100644
index abf22e5..0000000
--- i/packages/engine/tests/respect-floor.test.ts
+++ /dev/null
@@ -1,46 +0,0 @@
-import { runUnderwrite } from '../src/run_underwrite';
-import { describe, it, expect } from 'vitest';
-import { computeRespectFloor } from '../src/compute_underwriting';
-import type { EngineDeal } from '../src/types';
-import { UNDERWRITE_POLICY, type UnderwritePolicy } from '../src/policy-defaults';
-
-const baseDeal: EngineDeal = {
-  market: { aiv: 300_000, arv: 360_000, dom_zip: 45, moi_zip: 2.3 },
-  costs: {
-    repairs_base: 40_000,
-    contingency_pct: 0.15,
-    monthly: { taxes: 3_600, insurance: 2_400, hoa: 0, utilities: 250 },
-    close_cost_items_seller: [{ label: 'doc stamps (seller)', amount: 2_100 }],
-    close_cost_items_buyer: [{ label: 'lender/title/buyer items', amount: 18_000 }],
-    essentials_moveout_cash: 2_000,
-  },
-  debt: {
-    senior_principal: 180_000,
-    senior_per_diem: 45,
-    good_thru_date: '2025-10-01',
-    juniors: [{ label: 'HELOC', amount: 10_000 }],
-  },
-  timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-};
-
-describe('Respect Floor', () => {
-  it('falls back to payoff_plus_essentials when investor_discounts are undefined', () => {
-    const rf = computeRespectFloor(baseDeal, {
-      ...UNDERWRITE_POLICY,
-      investor_discounts: undefined,
-    });
-    expect(rf.investor).toBeNull();
-    expect(rf.payoff_plus_essentials).toBe(192_000); // 180,000 + 10,000 + 2,000
-    expect(rf.operational).toBe(192_000);
-  });
-
-  it('uses investor floors when provided and takes max()', () => {
-    const customPolicy: UnderwritePolicy = {
-      ...UNDERWRITE_POLICY,
-      investor_discounts: { typical_zip: 0.22 }, // 22% ΓåÆ floor 300k*(1-0.22) = 234k
-    };
-    const out = runUnderwrite(baseDeal, customPolicy);
-    expect(out.floors.investor?.typical_floor).toBeCloseTo(234_000, 6);
-    expect(out.floors.operational).toBe(234_000); // max(192k, 234k) = 234k
-  });
-});
diff --git i/packages/engine/tests/underwrite.ceiling.test.ts w/packages/engine/tests/underwrite.ceiling.test.ts
deleted file mode 100644
index a9eed95..0000000
--- i/packages/engine/tests/underwrite.ceiling.test.ts
+++ /dev/null
@@ -1,62 +0,0 @@
-import { runUnderwrite } from '../src/run_underwrite';
-import { describe, it, expect } from 'vitest';
-import type { EngineDeal as Deal } from '../src/types';
-import { UNDERWRITE_POLICY } from '../src/policy-defaults';
-
-describe('buyer ceiling + clamp + headlines', () => {
-  const sample: Deal = {
-    market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-    costs: {
-      repairs_base: 40000,
-      contingency_pct: 0.15,
-      monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-      close_cost_items_seller: [],
-      close_cost_items_buyer: [],
-      essentials_moveout_cash: 2000,
-    },
-    debt: { senior_principal: 180000, juniors: [{ label: 'HELOC', amount: 10000 }] },
-    timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-    status: { insurance_bindable: true },
-  };
-
-  it('wholetail beats flip with defaults; clamp Γëñ 0.97 * AIV', () => {
-    const out = runUnderwrite(sample, UNDERWRITE_POLICY);
-
-    // DTM sanity
-    expect(out.dtm.reason).toBe('manual');
-    expect(out.dtm.chosen_days).toBe(28);
-
-    // Floors sanity
-    expect(out.floors.payoff_plus_essentials).toBe(192000);
-
-    // Candidates present
-    const flip = out.ceilings.candidates.find((c) => c.label === 'flip')!;
-    const wt = out.ceilings.candidates.find((c) => c.label === 'wholetail')!;
-    expect(flip.value).toBeCloseTo(225366.6667, 2);
-    expect(wt.value).toBeCloseTo(258166.6667, 2);
-
-    // Winner label from candidates by chosen value (works if chosen is a number)
-    const chosenVal = out.ceilings.chosen!;
-    const chosen = out.ceilings.candidates.find((c) => c.value === chosenVal);
-    expect(chosen?.label).toBe('wholetail');
-
-    // Clamp should not trigger here (cap = 0.97 * 300k = 291k)
-    expect(wt.value).toBeLessThanOrEqual(291000);
-  });
-
-  it('clamps when MAO would exceed 0.97*AIV', () => {
-    const rich: Deal = {
-      ...sample,
-      market: { ...sample.market, arv: 500000, aiv: 300000 },
-      costs: { ...sample.costs, repairs_base: 5000 },
-    };
-
-    const out = runUnderwrite(rich, UNDERWRITE_POLICY);
-    const cap = 0.97 * rich.market!.aiv!;
-    expect(out.ceilings.candidates.every((c) => c.value <= cap)).toBe(true);
-
-    if (out.headlines.instant_cash_offer !== null) {
-      expect(out.headlines.instant_cash_offer).toBeLessThanOrEqual(cap);
-    }
-  });
-});
diff --git i/packages/engine/tests/underwrite.rf.test.ts w/packages/engine/tests/underwrite.rf.test.ts
deleted file mode 100644
index f04ccfd..0000000
--- i/packages/engine/tests/underwrite.rf.test.ts
+++ /dev/null
@@ -1,44 +0,0 @@
-import { runUnderwrite } from '../src/run_underwrite';
-import { describe, it, expect } from 'vitest';
-import type { EngineDeal as Deal } from '../src/types';
-import { UNDERWRITE_POLICY } from '../src/policy-defaults';
-
-describe('Respect Floor + DTM/Carry (sanity)', () => {
-  const base: Deal = {
-    market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-    costs: {
-      repairs_base: 40000,
-      contingency_pct: 0.15,
-      monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-      essentials_moveout_cash: 2000,
-    },
-    debt: { senior_principal: 180000, juniors: [{ label: 'HELOC', amount: 10000 }] },
-    timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-  };
-
-  it('DTM chooses manual (28) vs default (DOM+35=80), carry capped <= 5.0 months', () => {
-    const out = runUnderwrite(base, UNDERWRITE_POLICY);
-    expect(out.dtm.reason).toBe('manual');
-    expect(out.dtm.chosen_days).toBe(28);
-    expect(out.carry.hold_monthly).toBe(6250);
-    expect(Math.abs(out.carry.hold_months - 28 / 30)).toBeLessThan(1e-9);
-  });
-
-  it('Respect Floor operational = max(investor typical, payoff+essentials)', () => {
-    // No investor discounts ΓåÆ investor null, operational == payoff+essentials
-    const out1 = runUnderwrite(base, UNDERWRITE_POLICY);
-    expect(out1.floors.investor).toBeNull();
-    expect(out1.floors.payoff_plus_essentials).toBe(180000 + 10000 + 2000);
-    expect(out1.floors.operational).toBe(192000);
-
-    // With investor typical 22% + p20 28%: typical floor 234,000
-    const policy2 = {
-      ...UNDERWRITE_POLICY,
-      investor_discounts: { typical_zip: 0.22, p20_zip: 0.28 },
-    };
-    const out2 = runUnderwrite(base, policy2);
-    expect(out2.floors.investor).not.toBeNull();
warning: in the working copy of 'packages/engine/tsconfig.build.json', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'packages/engine/tsconfig.json', CRLF will be replaced by LF the next time Git touches it
-    expect(out2.floors.investor?.typical_floor).toBeCloseTo(300000 * (1 - 0.22), 6); // 234,000
-    expect(out2.floors.operational).toBeCloseTo(234000, 6);
-  });
-});
diff --git i/packages/engine/tests/underwrite.smoke.test.ts w/packages/engine/tests/underwrite.smoke.test.ts
deleted file mode 100644
index 96cb5c7..0000000
--- i/packages/engine/tests/underwrite.smoke.test.ts
+++ /dev/null
@@ -1,24 +0,0 @@
-import { describe, it, expect } from "vitest";
-import { computeUnderwriting } from "@hps-internal/engine";
-
-describe("computeUnderwriting smoke", () => {
-  it("returns a result object with expected top-level keys", () => {
-    const deal = {
-      market: { aiv: 300000, arv: 360000, dom_zip: 45, moi_zip: 2.3 },
-      costs: {
-        repairs_base: 40000,
-        contingency_pct: 0.15,
-        monthly: { taxes: 3600, insurance: 2400, hoa: 0, utilities: 250 },
-      },
-      debt: { senior_principal: 180000, juniors: [{ label: "HELOC", amount: 10000 }] },
-      timeline: { days_to_ready_list: 0, days_to_sale_manual: 28 },
-      status: { insurance_bindable: true },
-    };
-
-    const out: any = computeUnderwriting(deal as any);
-    expect(out).toBeTruthy();
-    for (const key of ["inputs", "policy", "dtm", "carry", "floors", "ceilings", "headlines"]) {
-      expect(out).toHaveProperty(key);
-    }
-  });
-});
diff --git i/packages/engine/tsconfig.build.json w/packages/engine/tsconfig.build.json
index 42be407..3c5530b 100644
--- i/packages/engine/tsconfig.build.json
+++ w/packages/engine/tsconfig.build.json
@@ -1,16 +1,15 @@
 {
   "extends": "./tsconfig.json",
   "compilerOptions": {
-    "outDir": "./dist",
-    "declaration": true,
-    "emitDeclarationOnly": false,
-    "module": "ESNext",
-    "target": "ES2022",
-    "moduleResolution": "Bundler",
-    "verbatimModuleSyntax": true,
-    "resolveJsonModule": true,
-    "sourceMap": false,
-    "stripInternal": true
+    "noEmitOnError": true
   },
-  "include": ["src/**/*"]
+  "include": ["src/**/*.ts"],
+  "exclude": [
+    "src/**/__tests__/**",
+    "src/**/*.test.ts",
+    "src/**/*.spec.ts",
+    "src/compute_underwriting_with_trace.ts",
+    "src/run_underwrite.ts",
+    "src/utils/trace.ts"
+  ]
 }
diff --git i/packages/engine/tsconfig.json w/packages/engine/tsconfig.json
index b18de01..ca381d3 100644
--- i/packages/engine/tsconfig.json
+++ w/packages/engine/tsconfig.json
@@ -1,12 +1,18 @@
 {
-  "extends": "../../tsconfig.json",
   "compilerOptions": {
-    "baseUrl": ".",
+    "target": "ES2022",
+    "module": "ESNext",
+    "moduleResolution": "Bundler",
+    "strict": true,
+    "declaration": true,
+    "declarationMap": false,
+    "sourceMap": false,
     "rootDir": "src",
     "outDir": "dist",
-    "declaration": true,
-    "skipLibCheck": true,
-    "noEmit": false
+    "resolveJsonModule": true,
+    "esModuleInterop": true,
+    "skipLibCheck": true
   },
-  "include": ["src/**/*.ts"]
+  "include": ["src/**/*.ts"],
+  "exclude": ["src/**/__tests__/**", "src/**/*.test.ts", "src/**/*.spec.ts"]
 }
diff --git i/pnpm-lock.yaml w/pnpm-lock.yaml
index 2d39261..f6a3e5b 100644
--- i/pnpm-lock.yaml
+++ w/pnpm-lock.yaml
@@ -11,6 +11,13 @@ overrides:
 importers:
 
   .:
+    dependencies:
+      '@hps-internal/contracts':
+        specifier: workspace:*
+        version: link:packages/contracts
+      zod:
+        specifier: ^3.23.8
+        version: 3.23.8
     devDependencies:
       '@hps-internal/engine':
         specifier: workspace:*
@@ -51,6 +58,9 @@ importers:
 
   apps/hps-dealengine:
     dependencies:
+      '@hps-internal/contracts':
+        specifier: workspace:*
+        version: link:../../packages/contracts
       '@hps-internal/engine':
         specifier: workspace:*
         version: link:../../packages/engine
@@ -83,7 +93,7 @@ importers:
         specifier: 20.19.0
         version: 20.19.0
       '@types/react':
-        specifier: ^18.2.66
+        specifier: ^18.3.26
         version: 18.3.26
       '@types/react-dom':
         specifier: ^18.2.22
@@ -101,7 +111,20 @@ importers:
         specifier: ^5.6.3
         version: 5.6.3
 
-  packages/engine: {}
warning: in the working copy of 'pnpm-workspace.yaml', CRLF will be replaced by LF the next time Git touches it
warning: in the working copy of 'tsconfig.json', CRLF will be replaced by LF the next time Git touches it
+  packages/contracts:
+    devDependencies:
+      typescript:
+        specifier: 5.6.3
+        version: 5.6.3
+
+  packages/engine:
+    devDependencies:
+      '@hps-internal/contracts':
+        specifier: workspace:*
+        version: link:../contracts
+      typescript:
+        specifier: 5.6.3
+        version: 5.6.3
 
 packages:
 
diff --git i/pnpm-workspace.yaml w/pnpm-workspace.yaml
index 5835abf..b1c69db 100644
--- i/pnpm-workspace.yaml
+++ w/pnpm-workspace.yaml
@@ -1,3 +1,8 @@
+# pnpm-workspace.yaml  (minimal safe example)
 packages:
-  - apps/hps-dealengine
-  - packages/*
+  - 'packages/*'
+  - 'apps/*'
+
+onlyBuiltDependencies:
+  - esbuild
+  - unrs-resolver
diff --git i/tsconfig.json w/tsconfig.json
index 358c821..9344ef3 100644
--- i/tsconfig.json
+++ w/tsconfig.json
@@ -1,16 +1,21 @@
 {
+  "extends": "./tsconfig.base.json",
   "compilerOptions": {
-    "target": "ES2022",
+    "jsx": "preserve",
     "module": "ESNext",
     "moduleResolution": "Bundler",
-    "lib": ["dom", "dom.iterable", "esnext"],
-    "strict": true,
-    "skipLibCheck": true,
-    "resolveJsonModule": true,
-    "esModuleInterop": true,
-    "isolatedModules": true,
-    "noEmit": true,
-    "jsx": "preserve",
-    "types": ["node"]
-  }
+    "composite": false,
+    "skipLibCheck": true
+  },
+  "include": [
+    "apps/hps-dealengine/**/*.ts",
+    "apps/hps-dealengine/**/*.tsx",
+    "packages/*/src/**/*.ts"
+  ],
+  "exclude": [
+    "**/node_modules/**",
+    "**/*.test.ts",
+    "**/*.spec.ts",
+    "packages/engine/tests.skip/**"
+  ]
 }
no changes added to commit (use "git add" and/or "git commit -a")
